"use strict";
var async = require("async"), mm = require("micromatch");
/**
 * Tunnels are runnable work flow units that can watch nests.
 */
var Tunnel = (function () {
    function Tunnel(e, theName) {
        this.match_obj = {
            queue: [],
            run: null,
            pattern: null,
            orphan_minutes: null
        };
        this.e = e;
        this.nests = [];
        this._name = theName;
        this.run_list = [];
        this.run_sync_list = [];
        this.job_counter = 0;
    }
    Tunnel.prototype.toString = function () {
        return "Tunnel";
    };
    Object.defineProperty(Tunnel.prototype, "name", {
        get: function () {
            return this._name;
        },
        set: function (name) {
            this._name = name;
        },
        enumerable: true,
        configurable: true
    });
    Tunnel.prototype.getNests = function () {
        return this.nests;
    };
    Tunnel.prototype.getRunList = function () {
        return this.run_list;
    };
    Tunnel.prototype.getRunSyncList = function () {
        return this.run_sync_list;
    };
    /**
     * Instructs the tunnel to watch a nest for new jobs.
     * @param nest
     */
    Tunnel.prototype.watch = function (nest) {
        nest.register(this);
        nest.load();
        nest.watch();
        this.nests.push(nest);
    };
    Tunnel.prototype.arrive = function (job, nest) {
        this.job_counter++;
        this.e.log(1, "Job " + this.job_counter + " triggered tunnel arrive.", this, [job, nest]);
        this.executeRun(job, nest);
        this.executeRunSync(job, nest);
        this.executeMatch(job, nest);
    };
    /**
     * Run program logic asynchronously.
     * @param callback
     */
    Tunnel.prototype.run = function (callback) {
        this.run_list.push(callback);
    };
    /**
     * Run program logic synchronously.
     * @param callback
     */
    Tunnel.prototype.runSync = function (callback) {
        this.run_sync_list.push(callback);
    };
    /**
     * Failed jobs runner.
     * @param callback
     */
    Tunnel.prototype.fail = function (callback) {
        this.run_fail = callback;
    };
    /**
     * Asynchronous run event.
     * @param job
     * @param nest
     */
    Tunnel.prototype.executeRun = function (job, nest) {
        var tn = this;
        if (tn.run_list.length > 0) {
            tn.run_list.forEach(function (callback) {
                try {
                    callback(job, nest);
                }
                catch (e) {
                    // Fail if an error is thrown
                    tn.executeFail(job, nest, e);
                }
            });
        }
    };
    /**
     * Synchronous run event.
     * @param job
     * @param nest
     */
    Tunnel.prototype.executeRunSync = function (job, nest) {
        var tn = this;
        var breakFailure = false;
        var successfulRuns = 0;
        if (tn.run_sync_list.length > 0) {
            async.eachSeries(tn.run_sync_list, function (run, doNextRun) {
                if (breakFailure === false) {
                    run(job, nest, function () {
                        successfulRuns++;
                        doNextRun();
                    });
                }
            }, function (err) {
                if (err) {
                    breakFailure = true;
                    tn.executeFail(job, nest, err);
                }
                tn.e.log(0, "Completed " + successfulRuns + "/" + tn.getRunSyncList().length + " synchronous run list(s).", tn, [job, nest]);
            });
        }
    };
    /**
     * Fail run event.
     * @param job
     * @param nest
     * @param reason
     */
    Tunnel.prototype.executeFail = function (job, nest, reason) {
        var tn = this;
        tn.e.log(3, "Failed for reason \"" + reason + "\".", tn, [job, nest]);
        tn.run_fail(job, nest, reason);
    };
    /**
     * Interface for matching two or more files together based on an array of glob filename patterns.
     * @param pattern
     * @param orphanMinutes
     * @param callback
     */
    Tunnel.prototype.match = function (pattern, orphanMinutes, callback) {
        this.match_obj.pattern = pattern;
        this.match_obj.orphan_minutes = orphanMinutes;
        this.match_obj.run = callback;
    };
    /**
     * Match execution
     * @param job
     * @param nest
     */
    Tunnel.prototype.executeMatch = function (job, nest) {
        if (this.match_obj.run) {
            // Try to find match in queue
            var tn_1 = this;
            var qjob_pattern_match_result_1, job_pattern_match_result_1;
            var matched_jobs_1 = [];
            var job_base_1, qjob_base_1;
            tn_1.e.log(0, "Executing matching process.", tn_1);
            tn_1.match_obj.pattern.forEach(function (pattern, i) {
                job_pattern_match_result_1 = mm.isMatch(job.name, pattern);
                if (job_pattern_match_result_1 === true) {
                    job_base_1 = job.name.substr(0, job.name.indexOf(pattern.replace("*", "")));
                }
            });
            tn_1.match_obj.queue.slice().reverse().forEach(function (qJob, qIndex, qObject) {
                tn_1.match_obj.pattern.forEach(function (pattern) {
                    qjob_pattern_match_result_1 = mm.isMatch(qJob.name, pattern);
                    if (qjob_pattern_match_result_1 === true) {
                        qjob_base_1 = qJob.name.substr(0, qJob.name.indexOf(pattern.replace("*", "")));
                        if (job_base_1 === qjob_base_1) {
                            // Pull out qjob from queue
                            tn_1.match_obj.queue.splice(qObject.length - 1 - qIndex, 1);
                            matched_jobs_1.push(qJob);
                            return;
                        }
                    }
                });
            });
            // if found
            if (matched_jobs_1.length > 0) {
                matched_jobs_1.push(job);
                tn_1.e.log(0, "Matched " + matched_jobs_1.length + " jobs.", tn_1);
                tn_1.match_obj.run(matched_jobs_1);
            }
            else {
                // If not found, add this job to the queue
                tn_1.match_obj.queue.push(job);
            }
            // Need to set a timeout for the job to fail
            setTimeout(function () {
                if (tn_1.match_obj.queue.length !== 0) {
                    // Fail all jobs in the queue
                    tn_1.match_obj.queue.forEach(function (fJob) {
                        fJob.fail("Orphan timeout.");
                    });
                    // Wipe the queue
                    tn_1.e.log(0, "Orphan timeout executed on " + tn_1.match_obj.queue.length + " jobs.", tn_1);
                    tn_1.match_obj.queue = [];
                }
            }, tn_1.match_obj.orphan_minutes * 60000);
        }
    };
    return Tunnel;
}());
exports.Tunnel = Tunnel;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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U0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJO3dCQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7b0JBQ2pDLENBQUMsQ0FBQyxDQUFDO29CQUVILGlCQUFpQjtvQkFDakIsSUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGdDQUE4QixJQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLFdBQVEsRUFBRSxJQUFFLENBQUMsQ0FBQztvQkFDakYsSUFBRSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUM1QixDQUFDO1lBQ0wsQ0FBQyxFQUFFLElBQUUsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDTCxDQUFDO0lBQ0wsYUFBQztBQUFELENBMU9BLEFBME9DLElBQUE7QUExT1ksY0FBTSxTQTBPbEIsQ0FBQSIsImZpbGUiOiJsaWIvdHVubmVsL3R1bm5lbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvbGRlck5lc3QgfSBmcm9tIFwiLi4vbmVzdC9mb2xkZXJOZXN0XCI7XG5pbXBvcnQgeyBOZXN0IH0gZnJvbSBcIi4uL25lc3QvbmVzdFwiO1xuaW1wb3J0IHsgSm9iIH0gZnJvbSBcIi4uL2pvYi9qb2JcIjtcbmltcG9ydCB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uL2Vudmlyb25tZW50L2Vudmlyb25tZW50XCI7XG5pbXBvcnQge1dlYmhvb2tOZXN0fSBmcm9tIFwiLi4vbmVzdC93ZWJob29rTmVzdFwiO1xuaW1wb3J0IHtGdHBOZXN0fSBmcm9tIFwiLi4vbmVzdC9mdHBOZXN0XCI7XG5cbmNvbnN0ICAgYXN5bmMgPSByZXF1aXJlKFwiYXN5bmNcIiksXG4gICAgICAgIG1tID0gcmVxdWlyZShcIm1pY3JvbWF0Y2hcIik7XG4vKipcbiAqIFR1bm5lbHMgYXJlIHJ1bm5hYmxlIHdvcmsgZmxvdyB1bml0cyB0aGF0IGNhbiB3YXRjaCBuZXN0cy5cbiAqL1xuZXhwb3J0IGNsYXNzIFR1bm5lbCB7XG5cbiAgICBwcm90ZWN0ZWQgX25hbWU6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgbmVzdHM6IE5lc3RbXTtcbiAgICBwcm90ZWN0ZWQgcnVuX2xpc3Q6IGFueVtdO1xuICAgIHByb3RlY3RlZCBydW5fc3luY19saXN0OiBhbnlbXTtcbiAgICBwcm90ZWN0ZWQgcnVuX2ZhaWw6IGFueTtcbiAgICBwcm90ZWN0ZWQgZTogRW52aXJvbm1lbnQ7XG4gICAgcHJvdGVjdGVkIGpvYl9jb3VudGVyOiBudW1iZXI7XG5cbiAgICBwcm90ZWN0ZWQgbWF0Y2hfb2JqID0ge1xuICAgICAgICBxdWV1ZTogW10sXG4gICAgICAgIHJ1bjogbnVsbCxcbiAgICAgICAgcGF0dGVybjogbnVsbCxcbiAgICAgICAgb3JwaGFuX21pbnV0ZXM6IG51bGxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IoZTogRW52aXJvbm1lbnQsIHRoZU5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLmUgPSBlO1xuICAgICAgICB0aGlzLm5lc3RzID0gW107XG4gICAgICAgIHRoaXMuX25hbWUgPSB0aGVOYW1lO1xuICAgICAgICB0aGlzLnJ1bl9saXN0ID0gW107XG4gICAgICAgIHRoaXMucnVuX3N5bmNfbGlzdCA9IFtdO1xuICAgICAgICB0aGlzLmpvYl9jb3VudGVyID0gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBcIlR1bm5lbFwiO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbmFtZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX25hbWU7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBuYW1lKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9uYW1lID0gbmFtZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TmVzdHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm5lc3RzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSdW5MaXN0KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5fbGlzdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UnVuU3luY0xpc3QoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJ1bl9zeW5jX2xpc3Q7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5zdHJ1Y3RzIHRoZSB0dW5uZWwgdG8gd2F0Y2ggYSBuZXN0IGZvciBuZXcgam9icy5cbiAgICAgKiBAcGFyYW0gbmVzdFxuICAgICAqL1xuICAgIHB1YmxpYyB3YXRjaChuZXN0OiBGb2xkZXJOZXN0IHwgV2ViaG9va05lc3QgfCBGdHBOZXN0KSB7XG4gICAgICAgIG5lc3QucmVnaXN0ZXIodGhpcyk7XG4gICAgICAgIG5lc3QubG9hZCgpO1xuICAgICAgICBuZXN0LndhdGNoKCk7XG4gICAgICAgIHRoaXMubmVzdHMucHVzaChuZXN0KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXJyaXZlKGpvYjogSm9iLCBuZXN0PzogTmVzdCkge1xuICAgICAgICB0aGlzLmpvYl9jb3VudGVyKys7XG4gICAgICAgIHRoaXMuZS5sb2coMSwgYEpvYiAke3RoaXMuam9iX2NvdW50ZXJ9IHRyaWdnZXJlZCB0dW5uZWwgYXJyaXZlLmAsIHRoaXMsIFtqb2IsIG5lc3RdKTtcbiAgICAgICAgdGhpcy5leGVjdXRlUnVuKGpvYiwgbmVzdCk7XG4gICAgICAgIHRoaXMuZXhlY3V0ZVJ1blN5bmMoam9iLCBuZXN0KTtcbiAgICAgICAgdGhpcy5leGVjdXRlTWF0Y2goam9iLCBuZXN0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gcHJvZ3JhbSBsb2dpYyBhc3luY2hyb25vdXNseS5cbiAgICAgKiBAcGFyYW0gY2FsbGJhY2tcbiAgICAgKi9cbiAgICBwdWJsaWMgcnVuKGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMucnVuX2xpc3QucHVzaChjYWxsYmFjayk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIHByb2dyYW0gbG9naWMgc3luY2hyb25vdXNseS5cbiAgICAgKiBAcGFyYW0gY2FsbGJhY2tcbiAgICAgKi9cbiAgICBwdWJsaWMgcnVuU3luYyhjYWxsYmFjaykge1xuICAgICAgICB0aGlzLnJ1bl9zeW5jX2xpc3QucHVzaChjYWxsYmFjayk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmFpbGVkIGpvYnMgcnVubmVyLlxuICAgICAqIEBwYXJhbSBjYWxsYmFja1xuICAgICAqL1xuICAgIHB1YmxpYyBmYWlsKGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMucnVuX2ZhaWwgPSBjYWxsYmFjaztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBc3luY2hyb25vdXMgcnVuIGV2ZW50LlxuICAgICAqIEBwYXJhbSBqb2JcbiAgICAgKiBAcGFyYW0gbmVzdFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBleGVjdXRlUnVuKGpvYjogSm9iLCBuZXN0OiBOZXN0KSB7XG4gICAgICAgIGxldCB0biA9IHRoaXM7XG5cbiAgICAgICAgaWYgKHRuLnJ1bl9saXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRuLnJ1bl9saXN0LmZvckVhY2goKGNhbGxiYWNrKSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soam9iLCBuZXN0KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEZhaWwgaWYgYW4gZXJyb3IgaXMgdGhyb3duXG4gICAgICAgICAgICAgICAgICAgIHRuLmV4ZWN1dGVGYWlsKGpvYiwgbmVzdCwgZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTeW5jaHJvbm91cyBydW4gZXZlbnQuXG4gICAgICogQHBhcmFtIGpvYlxuICAgICAqIEBwYXJhbSBuZXN0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGV4ZWN1dGVSdW5TeW5jKGpvYjogSm9iLCBuZXN0OiBOZXN0KSB7XG4gICAgICAgIGxldCB0biA9IHRoaXM7XG5cbiAgICAgICAgbGV0IGJyZWFrRmFpbHVyZSA9IGZhbHNlO1xuICAgICAgICBsZXQgc3VjY2Vzc2Z1bFJ1bnMgPSAwO1xuXG4gICAgICAgIGlmICh0bi5ydW5fc3luY19saXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXModG4ucnVuX3N5bmNfbGlzdCwgKHJ1biwgZG9OZXh0UnVuKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGJyZWFrRmFpbHVyZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgcnVuKGpvYiwgbmVzdCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bFJ1bnMrKztcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvTmV4dFJ1bigpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBicmVha0ZhaWx1cmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0bi5leGVjdXRlRmFpbChqb2IsIG5lc3QsIGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRuLmUubG9nKDAsIGBDb21wbGV0ZWQgJHtzdWNjZXNzZnVsUnVuc30vJHt0bi5nZXRSdW5TeW5jTGlzdCgpLmxlbmd0aH0gc3luY2hyb25vdXMgcnVuIGxpc3QocykuYCwgdG4sIFtqb2IsIG5lc3RdKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmFpbCBydW4gZXZlbnQuXG4gICAgICogQHBhcmFtIGpvYlxuICAgICAqIEBwYXJhbSBuZXN0XG4gICAgICogQHBhcmFtIHJlYXNvblxuICAgICAqL1xuICAgIHB1YmxpYyBleGVjdXRlRmFpbChqb2I6IEpvYiwgbmVzdDogTmVzdCwgcmVhc29uOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IHRuID0gdGhpcztcbiAgICAgICAgdG4uZS5sb2coMywgYEZhaWxlZCBmb3IgcmVhc29uIFwiJHtyZWFzb259XCIuYCwgdG4sIFtqb2IsIG5lc3RdKTtcbiAgICAgICAgdG4ucnVuX2ZhaWwoam9iLCBuZXN0LCByZWFzb24pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEludGVyZmFjZSBmb3IgbWF0Y2hpbmcgdHdvIG9yIG1vcmUgZmlsZXMgdG9nZXRoZXIgYmFzZWQgb24gYW4gYXJyYXkgb2YgZ2xvYiBmaWxlbmFtZSBwYXR0ZXJucy5cbiAgICAgKiBAcGFyYW0gcGF0dGVyblxuICAgICAqIEBwYXJhbSBvcnBoYW5NaW51dGVzXG4gICAgICogQHBhcmFtIGNhbGxiYWNrXG4gICAgICovXG4gICAgcHVibGljIG1hdGNoKHBhdHRlcm46IHN0cmluZ1tdfHN0cmluZywgb3JwaGFuTWludXRlczogbnVtYmVyLCBjYWxsYmFjazogYW55KSB7XG4gICAgICAgIHRoaXMubWF0Y2hfb2JqLnBhdHRlcm4gPSBwYXR0ZXJuO1xuICAgICAgICB0aGlzLm1hdGNoX29iai5vcnBoYW5fbWludXRlcyA9IG9ycGhhbk1pbnV0ZXM7XG4gICAgICAgIHRoaXMubWF0Y2hfb2JqLnJ1biA9IGNhbGxiYWNrO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1hdGNoIGV4ZWN1dGlvblxuICAgICAqIEBwYXJhbSBqb2JcbiAgICAgKiBAcGFyYW0gbmVzdFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBleGVjdXRlTWF0Y2goam9iOiBKb2IsIG5lc3Q6IE5lc3QpIHtcblxuICAgICAgICBpZiAodGhpcy5tYXRjaF9vYmoucnVuKSB7XG4gICAgICAgICAgICAvLyBUcnkgdG8gZmluZCBtYXRjaCBpbiBxdWV1ZVxuXG4gICAgICAgICAgICBsZXQgdG4gPSB0aGlzO1xuXG4gICAgICAgICAgICBsZXQgcWpvYl9wYXR0ZXJuX21hdGNoX3Jlc3VsdCwgam9iX3BhdHRlcm5fbWF0Y2hfcmVzdWx0O1xuICAgICAgICAgICAgbGV0IG1hdGNoZWRfam9icyA9IFtdO1xuXG4gICAgICAgICAgICBsZXQgam9iX2Jhc2UsIHFqb2JfYmFzZTtcblxuICAgICAgICAgICAgdG4uZS5sb2coMCwgXCJFeGVjdXRpbmcgbWF0Y2hpbmcgcHJvY2Vzcy5cIiwgdG4pO1xuXG4gICAgICAgICAgICB0bi5tYXRjaF9vYmoucGF0dGVybi5mb3JFYWNoKGZ1bmN0aW9uIChwYXR0ZXJuLCBpKSB7XG4gICAgICAgICAgICAgICAgam9iX3BhdHRlcm5fbWF0Y2hfcmVzdWx0ID0gbW0uaXNNYXRjaChqb2IubmFtZSwgcGF0dGVybik7XG4gICAgICAgICAgICAgICAgaWYgKGpvYl9wYXR0ZXJuX21hdGNoX3Jlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICBqb2JfYmFzZSA9IGpvYi5uYW1lLnN1YnN0cigwLCBqb2IubmFtZS5pbmRleE9mKHBhdHRlcm4ucmVwbGFjZShcIipcIiwgXCJcIikpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgICAgICB0bi5tYXRjaF9vYmoucXVldWUuc2xpY2UoKS5yZXZlcnNlKCkuZm9yRWFjaChmdW5jdGlvbiAocUpvYiwgcUluZGV4LCBxT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgdG4ubWF0Y2hfb2JqLnBhdHRlcm4uZm9yRWFjaChmdW5jdGlvbiAocGF0dGVybikge1xuICAgICAgICAgICAgICAgICAgICBxam9iX3BhdHRlcm5fbWF0Y2hfcmVzdWx0ID0gbW0uaXNNYXRjaChxSm9iLm5hbWUsIHBhdHRlcm4pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocWpvYl9wYXR0ZXJuX21hdGNoX3Jlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcWpvYl9iYXNlID0gcUpvYi5uYW1lLnN1YnN0cigwLCBxSm9iLm5hbWUuaW5kZXhPZihwYXR0ZXJuLnJlcGxhY2UoXCIqXCIsIFwiXCIpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqb2JfYmFzZSA9PT0gcWpvYl9iYXNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHVsbCBvdXQgcWpvYiBmcm9tIHF1ZXVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG4ubWF0Y2hfb2JqLnF1ZXVlLnNwbGljZShxT2JqZWN0Lmxlbmd0aCAtIDEgLSBxSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZWRfam9icy5wdXNoKHFKb2IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIGlmIGZvdW5kXG4gICAgICAgICAgICBpZiAobWF0Y2hlZF9qb2JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaGVkX2pvYnMucHVzaChqb2IpO1xuICAgICAgICAgICAgICAgIHRuLmUubG9nKDAsIGBNYXRjaGVkICR7bWF0Y2hlZF9qb2JzLmxlbmd0aH0gam9icy5gLCB0bik7XG4gICAgICAgICAgICAgICAgdG4ubWF0Y2hfb2JqLnJ1bihtYXRjaGVkX2pvYnMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBJZiBub3QgZm91bmQsIGFkZCB0aGlzIGpvYiB0byB0aGUgcXVldWVcbiAgICAgICAgICAgICAgICB0bi5tYXRjaF9vYmoucXVldWUucHVzaChqb2IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBOZWVkIHRvIHNldCBhIHRpbWVvdXQgZm9yIHRoZSBqb2IgdG8gZmFpbFxuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRuLm1hdGNoX29iai5xdWV1ZS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRmFpbCBhbGwgam9icyBpbiB0aGUgcXVldWVcbiAgICAgICAgICAgICAgICAgICAgdG4ubWF0Y2hfb2JqLnF1ZXVlLmZvckVhY2goZnVuY3Rpb24gKGZKb2IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZKb2IuZmFpbChcIk9ycGhhbiB0aW1lb3V0LlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gV2lwZSB0aGUgcXVldWVcbiAgICAgICAgICAgICAgICAgICAgdG4uZS5sb2coMCwgYE9ycGhhbiB0aW1lb3V0IGV4ZWN1dGVkIG9uICR7dG4ubWF0Y2hfb2JqLnF1ZXVlLmxlbmd0aH0gam9icy5gLCB0bik7XG4gICAgICAgICAgICAgICAgICAgIHRuLm1hdGNoX29iai5xdWV1ZSA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHRuLm1hdGNoX29iai5vcnBoYW5fbWludXRlcyAqIDYwMDAwKTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=
