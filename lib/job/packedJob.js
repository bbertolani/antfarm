"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var jobProperty_1 = require("./jobProperty");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        var _this = 
        // let job_name = job.name;
        _super.call(this, e, job.name) || this;
        var pj = _this;
        pj.e = e;
        pj.job = job;
        return _this;
    }
    Object.defineProperty(PackedJob.prototype, "job", {
        get: function () {
            return this._job;
        },
        set: function (job) {
            this._job = job;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Makes job ticket and returns the _path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.job;
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.name + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "_finish" event.
            pj.path = file_path;
            pj.name = file_name;
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.execPack = function (done) {
        var pj = this;
        var job = pj.job;
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.path, function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.name, data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.files.forEach(function (file) {
                    fs.readFile(file.path, function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.nameProper + path.sep + file.name, data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            if (jobObject._type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject._id);
            }
            else if (jobObject._type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject._id);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject._type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
            pj.e.log(3, "Unparsable ticket: " + jsonTicket + ".", pj);
        }
        // Restore property values
        var props = {};
        _.each(jobObject._properties, function (prop) {
            props[prop._key] = new jobProperty_1.JobProperty(prop._key, prop._value);
        });
        job.propertyValues = props;
        // Restore lifecycle
        job.lifeCycle = jobObject._lifeCycle;
        return job;
    };
    PackedJob.prototype.execUnpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.job;
        // Read the zip to a buffer
        fs.readFile(job.path, function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        // Restore _files
                        pj.restoreFiles(job, zip, function (unpackedJob) {
                            done(unpackedJob);
                        });
                    });
                });
            });
        });
    };
    PackedJob.prototype.restoreFiles = function (job, zip, callback) {
        var pj = this;
        // Check for valid pack format
        if (zip.folder("_asset").length > 1) {
            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
        }
        if (job.isFolder()) {
            pj.extractFiles(zip, false, "_asset/", function (folderPath, folderName) {
                job.path = folderPath;
                job.rename(folderName);
                callback(job);
            });
        }
        else if (job.isFile()) {
            pj.extractFiles(zip, true, "_asset/", function (filePath, fileName) {
                job.path = filePath;
                job.rename(fileName);
                callback(job);
            });
        }
    };
    PackedJob.prototype.extractFiles = function (zip, single, zipPath, callback, totalFiles) {
        var pj = this;
        var tmpobj = tmp.dirSync();
        var tempPath = tmpobj.name;
        var fileNumber = 1;
        if (!totalFiles) {
            totalFiles = 0;
            zip.folder(zipPath).forEach(function (asset) { return totalFiles++; });
        }
        if (single === true) {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                if (fileNumber > 1) {
                    pj.e.log(3, "More than 1 files found when extracting a file job.", pj);
                }
                else {
                    var newRelPath = zipPath + relativePath;
                    if (asset.dir === "true") {
                        totalFiles--;
                        pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                    }
                    else {
                        zip.file(newRelPath).async("nodebuffer")
                            .then(function (content) {
                            fileNumber++;
                            var filePath = tempPath + path.sep + relativePath;
                            fs.writeFileSync(filePath, content);
                            callback(filePath, relativePath);
                        });
                    }
                }
            });
        }
        else {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                var newRelPath = zipPath + relativePath;
                if (asset.dir === true) {
                    totalFiles--;
                    pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                }
                else {
                    zip.file(newRelPath).async("nodebuffer")
                        .then(function (content) {
                        var filePath = tempPath + path.sep + relativePath;
                        fs.writeFileSync(filePath, content);
                        if (totalFiles === fileNumber) {
                            var rootFolderName = newRelPath.split(path.sep)[1];
                            callback(tempPath, rootFolderName);
                        }
                        fileNumber++;
                    });
                }
            });
        }
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUFBRSxDQUFDO29CQUVqQixDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDO1lBRUwsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBRUwsQ0FBQztJQUVMLGdCQUFDO0FBQUQsQ0F4UUEsQUF3UUMsQ0F4UThCLGlCQUFPLEdBd1FyQztBQXhRWSw4QkFBUyIsImZpbGUiOiJsaWIvam9iL3BhY2tlZEpvYi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RW52aXJvbm1lbnR9IGZyb20gXCIuLi9lbnZpcm9ubWVudC9lbnZpcm9ubWVudFwiO1xyXG5pbXBvcnQge0ZpbGVKb2J9IGZyb20gXCIuL2ZpbGVKb2JcIjtcclxuaW1wb3J0IHtKb2J9IGZyb20gXCIuL2pvYlwiO1xyXG5pbXBvcnQge0ZvbGRlckpvYn0gZnJvbSBcIi4vZm9sZGVySm9iXCI7XHJcbmltcG9ydCB7Sm9iUHJvcGVydHl9IGZyb20gXCIuL2pvYlByb3BlcnR5XCI7XHJcblxyXG5jb25zdCAgIHRtcCA9IHJlcXVpcmUoXCJ0bXBcIiksXHJcbiAgICAgICAgZnMgPSByZXF1aXJlKFwiZnNcIiksXHJcbiAgICAgICAgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpLFxyXG4gICAgICAgIEpTWmlwID0gcmVxdWlyZShcImpzemlwXCIpLFxyXG4gICAgICAgIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpLFxyXG4gICAgICAgIFJlZmxlY3QgPSByZXF1aXJlKFwicmVmbGVjdC1tZXRhZGF0YVwiKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQYWNrZWRKb2IgZXh0ZW5kcyBGaWxlSm9iIHtcclxuXHJcbiAgICBwcm90ZWN0ZWQgZTogRW52aXJvbm1lbnQ7XHJcbiAgICBwcm90ZWN0ZWQgX2pvYjogSm9iO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGU6IEVudmlyb25tZW50LCBqb2I6IEpvYikge1xyXG4gICAgICAgIC8vIGxldCBqb2JfbmFtZSA9IGpvYi5uYW1lO1xyXG4gICAgICAgIHN1cGVyKGUsIGpvYi5uYW1lKTtcclxuICAgICAgICBsZXQgcGogPSB0aGlzO1xyXG4gICAgICAgIHBqLmUgPSBlO1xyXG4gICAgICAgIHBqLmpvYiA9IGpvYjtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0IGpvYigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fam9iO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBzZXQgam9iKGpvYjogSm9iKSB7XHJcbiAgICAgICAgdGhpcy5fam9iID0gam9iO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTWFrZXMgam9iIHRpY2tldCBhbmQgcmV0dXJucyB0aGUgX3BhdGggdG8gdGhlIHRlbXBvcmFyeSBmaWxlLlxyXG4gICAgICogQHBhcmFtIGpvYlxyXG4gICAgICogQHJldHVybnMge3N0cmluZ31cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGdldEpvYlRpY2tldChqb2I6IEpvYikge1xyXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XHJcbiAgICAgICAgLy8gTWFrZSBqb2IgdGlja2V0XHJcbiAgICAgICAgbGV0IGpzb24gPSBqb2IuZ2V0SlNPTigpO1xyXG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xyXG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcclxuICAgICAgICBsZXQgZmlsZV9uYW1lID0gZGlyICsgcGF0aC5zZXAgKyBcInRpY2tldC5qc29uXCI7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZV9uYW1lLCBqc29uLCBcInV0ZjhcIik7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBFcnJvciB3cml0aW5nIGpvYiB0aWNrZXQgdG8gdGVtcG9yYXJ5IGZpbGVgLCBwaik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmaWxlX25hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGJ1aWxkWmlwKHppcDogYW55LCBjYWxsYmFjaykge1xyXG4gICAgICAgIC8vIFNhdmUgb3V0IHppcFxyXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XHJcbiAgICAgICAgbGV0IGpvYiA9IHRoaXMuam9iO1xyXG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xyXG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcclxuICAgICAgICBsZXQgZmlsZV9uYW1lID0gam9iLm5hbWUgKyBcIi5hbnRwYWNrLnppcFwiO1xyXG4gICAgICAgIGxldCBmaWxlX3BhdGggPSBkaXIgKyBwYXRoLnNlcCArIGZpbGVfbmFtZTtcclxuICAgICAgICB6aXBcclxuICAgICAgICAgICAgLmdlbmVyYXRlTm9kZVN0cmVhbSh7dHlwZTogXCJub2RlYnVmZmVyXCIsIHN0cmVhbUZpbGVzOiB0cnVlfSlcclxuICAgICAgICAgICAgLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZV9wYXRoKSlcclxuICAgICAgICAgICAgLm9uKFwiZmluaXNoXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIC8vIEpTWmlwIGdlbmVyYXRlcyBhIHJlYWRhYmxlIHN0cmVhbSB3aXRoIGEgXCJlbmRcIiBldmVudCxcclxuICAgICAgICAgICAgICAgIC8vIGJ1dCBpcyBwaXBlZCBoZXJlIGluIGEgd3JpdGFibGUgc3RyZWFtIHdoaWNoIGVtaXRzIGEgXCJfZmluaXNoXCIgZXZlbnQuXHJcbiAgICAgICAgICAgICAgICBwai5wYXRoID0gZmlsZV9wYXRoO1xyXG4gICAgICAgICAgICAgICAgcGoubmFtZSA9IGZpbGVfbmFtZTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUGFja3MgdGhlIHJlbGF0ZWQgam9iIG9uIGNvbnN0cnVjdGlvbi5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGV4ZWNQYWNrKGRvbmUpIHtcclxuICAgICAgICBsZXQgcGogPSB0aGlzO1xyXG4gICAgICAgIGxldCBqb2IgPSBwai5qb2I7XHJcblxyXG4gICAgICAgIGxldCB0aWNrZXRQYXRoID0gcGouZ2V0Sm9iVGlja2V0KGpvYik7XHJcblxyXG4gICAgICAgIGxldCB6aXAgPSBuZXcgSlNaaXAoKTtcclxuXHJcbiAgICAgICAgLy8gQWRkIHRpY2tldCB0byB6aXBcclxuICAgICAgICBmcy5yZWFkRmlsZSh0aWNrZXRQYXRoLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xyXG4gICAgICAgICAgICB6aXAuZmlsZShcIl90aWNrZXQvdGlja2V0Lmpzb25cIiwgZGF0YSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoam9iLmlzRmlsZSgpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGUoam9iLnBhdGgsIChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoXCJfYXNzZXQvXCIgKyBqb2IubmFtZSwgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XHJcbiAgICAgICAgICAgICAgICBqb2IuZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZShmaWxlLnBhdGgsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKFwiX2Fzc2V0XCIgKyBwYXRoLnNlcCArIGpvYi5uYW1lUHJvcGVyICsgcGF0aC5zZXAgKyBmaWxlLm5hbWUsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUpvYlRpY2tldChqc29uVGlja2V0KSB7XHJcbiAgICAgICAgbGV0IHBqID0gdGhpcztcclxuICAgICAgICBsZXQgam9iT2JqZWN0LCBqb2I7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgam9iT2JqZWN0ID0gSlNPTi5wYXJzZShqc29uVGlja2V0KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChqb2JPYmplY3QuX3R5cGUgPT09IFwiZmlsZVwiKSB7XHJcbiAgICAgICAgICAgICAgICBqb2IgPSBuZXcgRmlsZUpvYihwai5lLCBqb2JPYmplY3QuX2lkKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2JPYmplY3QuX3R5cGUgPT09IFwiZm9sZGVyXCIpIHtcclxuICAgICAgICAgICAgICAgIGpvYiA9IG5ldyBGb2xkZXJKb2IocGouZSwgam9iT2JqZWN0Ll9pZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBwai5lLmxvZygzLCBgQ2Fubm90IHVucGFjayB0aGlzIHR5cGUgb2Ygam9iOiAke2pvYk9iamVjdC5fdHlwZX1gLCBwaik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgcGouZS5sb2coMywgYFVucGFjayB0aWNrZXQgcGFyc2UgZXJyb3I6ICR7ZXJyfS5gLCBwaik7XHJcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhcnNhYmxlIHRpY2tldDogJHtqc29uVGlja2V0fS5gLCBwaik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBSZXN0b3JlIHByb3BlcnR5IHZhbHVlc1xyXG4gICAgICAgIGxldCBwcm9wcyA9IHt9O1xyXG5cclxuICAgICAgICBfLmVhY2goam9iT2JqZWN0Ll9wcm9wZXJ0aWVzLCBwcm9wID0+IHtcclxuICAgICAgICAgICAgcHJvcHNbcHJvcC5fa2V5XSA9IG5ldyBKb2JQcm9wZXJ0eShwcm9wLl9rZXksIHByb3AuX3ZhbHVlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBqb2IucHJvcGVydHlWYWx1ZXMgPSBwcm9wcztcclxuXHJcbiAgICAgICAgLy8gUmVzdG9yZSBsaWZlY3ljbGVcclxuICAgICAgICBqb2IubGlmZUN5Y2xlID0gam9iT2JqZWN0Ll9saWZlQ3ljbGU7XHJcblxyXG4gICAgICAgIHJldHVybiBqb2I7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGV4ZWNVbnBhY2soZG9uZSkge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwidW5wYWNraW5nXCIpO1xyXG5cclxuICAgICAgICBsZXQgcGogPSB0aGlzO1xyXG4gICAgICAgIGxldCBqb2IgPSBwai5qb2I7XHJcblxyXG4gICAgICAgIC8vIFJlYWQgdGhlIHppcCB0byBhIGJ1ZmZlclxyXG4gICAgICAgIGZzLnJlYWRGaWxlKGpvYi5wYXRoLCAoZXJyLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhY2tpbmcgcmVhZEZpbGUgZXJyb3I6ICR7ZXJyfWAsIHBqKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBPcGVuIHRoZSB6aXAgaW4gSlNaaXBcclxuICAgICAgICAgICAgSlNaaXAubG9hZEFzeW5jKGRhdGEpLnRoZW4oKHppcCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBqb2IgdGlja2V0IGFuZCBjcmVhdGUgam9iXHJcbiAgICAgICAgICAgICAgICB6aXAuZm9sZGVyKFwiX3RpY2tldFwiKS5mb3JFYWNoKChyZWxhdGl2ZVBhdGgsIGZpbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShgX3RpY2tldCR7cGF0aC5zZXB9JHtyZWxhdGl2ZVBhdGh9YCkuYXN5bmMoXCJzdHJpbmdcIilcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBvbGQgam9iIHRpY2tldFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2IgPSBwai5yZXN0b3JlSm9iVGlja2V0KGNvbnRlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBfZmlsZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGoucmVzdG9yZUZpbGVzKGpvYiwgemlwLCAodW5wYWNrZWRKb2IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUodW5wYWNrZWRKb2IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHJlc3RvcmVGaWxlcyhqb2I6IEpvYiwgemlwOiBhbnksIGNhbGxiYWNrKSB7XHJcblxyXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XHJcblxyXG5cclxuICAgICAgICAvLyBDaGVjayBmb3IgdmFsaWQgcGFjayBmb3JtYXRcclxuICAgICAgICBpZiAoemlwLmZvbGRlcihcIl9hc3NldFwiKS5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIHBqLmUubG9nKDIsIGBSZXN0b3JlZCBqb2IgZGlkIG5vdCBjb250YWluIGFueSBmaWxlIGFzc2V0cy5gLCBwaiwgW2pvYl0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XHJcbiAgICAgICAgICAgIHBqLmV4dHJhY3RGaWxlcyh6aXAsIGZhbHNlLCBcIl9hc3NldC9cIiwgKGZvbGRlclBhdGgsIGZvbGRlck5hbWUpID0+IHtcclxuICAgICAgICAgICAgICAgIGpvYi5wYXRoID0gZm9sZGVyUGF0aDtcclxuICAgICAgICAgICAgICAgIGpvYi5yZW5hbWUoZm9sZGVyTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhqb2IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZpbGUoKSkge1xyXG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCB0cnVlLCBcIl9hc3NldC9cIiwgKGZpbGVQYXRoLCBmaWxlTmFtZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgam9iLnBhdGggPSBmaWxlUGF0aDtcclxuICAgICAgICAgICAgICAgIGpvYi5yZW5hbWUoZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2soam9iKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBleHRyYWN0RmlsZXMoemlwOiBhbnksIHNpbmdsZTogYm9vbGVhbiwgemlwUGF0aDogc3RyaW5nLCBjYWxsYmFjazogYW55LCB0b3RhbEZpbGVzPzogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHBqID0gdGhpcztcclxuXHJcbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XHJcbiAgICAgICAgbGV0IHRlbXBQYXRoID0gdG1wb2JqLm5hbWU7XHJcblxyXG4gICAgICAgIGxldCBmaWxlTnVtYmVyID0gMTtcclxuXHJcbiAgICAgICAgaWYgKCF0b3RhbEZpbGVzKSB7XHJcbiAgICAgICAgICAgIHRvdGFsRmlsZXMgPSAwO1xyXG4gICAgICAgICAgICB6aXAuZm9sZGVyKHppcFBhdGgpLmZvckVhY2goKGFzc2V0KSA9PiB0b3RhbEZpbGVzKysgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzaW5nbGUgPT09IHRydWUpIHtcclxuXHJcbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChmaWxlTnVtYmVyID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBNb3JlIHRoYW4gMSBmaWxlcyBmb3VuZCB3aGVuIGV4dHJhY3RpbmcgYSBmaWxlIGpvYi5gLCBwaik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3UmVsUGF0aCA9IHppcFBhdGggKyByZWxhdGl2ZVBhdGg7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhc3NldC5kaXIgPT09IFwidHJ1ZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRmlsZXMtLTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgc2luZ2xlLCBuZXdSZWxQYXRoLCBjYWxsYmFjaywgdG90YWxGaWxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUobmV3UmVsUGF0aCkuYXN5bmMoXCJub2RlYnVmZmVyXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlTnVtYmVyKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZVBhdGggPSB0ZW1wUGF0aCArIHBhdGguc2VwICsgcmVsYXRpdmVQYXRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmaWxlUGF0aCwgcmVsYXRpdmVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgemlwLmZvbGRlcih6aXBQYXRoKS5mb3JFYWNoKChyZWxhdGl2ZVBhdGgsIGFzc2V0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3UmVsUGF0aCA9IHppcFBhdGggKyByZWxhdGl2ZVBhdGg7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRvdGFsRmlsZXMtLTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgc2luZ2xlLCBuZXdSZWxQYXRoLCBjYWxsYmFjaywgdG90YWxGaWxlcyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShuZXdSZWxQYXRoKS5hc3luYyhcIm5vZGVidWZmZXJcIilcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gdGVtcFBhdGggKyBwYXRoLnNlcCArIHJlbGF0aXZlUGF0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG90YWxGaWxlcyA9PT0gZmlsZU51bWJlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvb3RGb2xkZXJOYW1lID0gbmV3UmVsUGF0aC5zcGxpdChwYXRoLnNlcClbMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0ZW1wUGF0aCwgcm9vdEZvbGRlck5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVOdW1iZXIrKztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==
