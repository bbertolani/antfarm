"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var jobProperty_1 = require("./jobProperty");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        // let job_name = job.name;
        _super.call(this, e, job.name);
        var pj = this;
        pj.e = e;
        pj.job = job;
    }
    /**
     *
     * @returns {Job}
     */
    PackedJob.prototype.getJob = function () {
        return this.job;
    };
    /**
     * Makes job ticket and returns the _path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.getJob();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.name + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "_finish" event.
            pj.path = file_path;
            pj.name = file_name;
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.execPack = function (done) {
        var pj = this;
        var job = pj.getJob();
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.path, function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.name, data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.files.forEach(function (file) {
                    fs.readFile(file.path, function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.nameProper + path.sep + file.name, data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            if (jobObject._type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject._id);
            }
            else if (jobObject._type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject._id);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject._type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
            pj.e.log(3, "Unparsable ticket: " + jsonTicket + ".", pj);
        }
        // Restore property values
        var props = {};
        _.each(jobObject._properties, function (prop) {
            props[prop._key] = new jobProperty_1.JobProperty(prop._key, prop._value);
        });
        job.propertyValues = props;
        // Restore lifecycle
        job.lifeCycle = jobObject._lifeCycle;
        return job;
    };
    PackedJob.prototype.execUnpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.getJob();
        // Read the zip to a buffer
        fs.readFile(job.path, function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        // Restore _files
                        pj.restoreFiles(job, zip, function (unpackedJob) {
                            done(unpackedJob);
                        });
                    });
                });
            });
        });
    };
    PackedJob.prototype.restoreFiles = function (job, zip, callback) {
        var pj = this;
        // Check for valid pack format
        if (zip.folder("_asset").length > 1) {
            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
        }
        if (job.isFolder()) {
            pj.extractFiles(zip, false, "_asset/", function (folderPath, folderName) {
                job.path = folderPath;
                job.rename(folderName);
                callback(job);
            });
        }
        else if (job.isFile()) {
            pj.extractFiles(zip, true, "_asset/", function (filePath, fileName) {
                job.path = filePath;
                job.rename(fileName);
                callback(job);
            });
        }
    };
    PackedJob.prototype.extractFiles = function (zip, single, zipPath, callback, totalFiles) {
        var pj = this;
        var tmpobj = tmp.dirSync();
        var tempPath = tmpobj.name;
        var fileNumber = 1;
        if (!totalFiles) {
            totalFiles = 0;
            zip.folder(zipPath).forEach(function (asset) { return totalFiles++; });
        }
        if (single === true) {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                if (fileNumber > 1) {
                    pj.e.log(3, "More than 1 files found when extracting a file job.", pj);
                }
                else {
                    var newRelPath = zipPath + relativePath;
                    if (asset.dir === "true") {
                        totalFiles--;
                        pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                    }
                    else {
                        zip.file(newRelPath).async("nodebuffer")
                            .then(function (content) {
                            fileNumber++;
                            var filePath = tempPath + path.sep + relativePath;
                            fs.writeFileSync(filePath, content);
                            callback(filePath, relativePath);
                        });
                    }
                }
            });
        }
        else {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                var newRelPath = zipPath + relativePath;
                if (asset.dir === true) {
                    totalFiles--;
                    pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                }
                else {
                    zip.file(newRelPath).async("nodebuffer")
                        .then(function (content) {
                        var filePath = tempPath + path.sep + relativePath;
                        fs.writeFileSync(filePath, content);
                        if (totalFiles === fileNumber) {
                            var rootFolderName = newRelPath.split(path.sep)[1];
                            callback(tempPath, rootFolderName);
                        }
                        fileNumber++;
                    });
                }
            });
        }
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQztZQUVMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztJQUVMLENBQUM7SUFFTCxnQkFBQztBQUFELENBeFFBLEFBd1FDLENBeFE4QixpQkFBTyxHQXdRckM7QUF4UVksaUJBQVMsWUF3UXJCLENBQUEiLCJmaWxlIjoibGliL2pvYi9wYWNrZWRKb2IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Vudmlyb25tZW50fSBmcm9tIFwiLi4vZW52aXJvbm1lbnQvZW52aXJvbm1lbnRcIjtcbmltcG9ydCB7RmlsZUpvYn0gZnJvbSBcIi4vZmlsZUpvYlwiO1xuaW1wb3J0IHtKb2J9IGZyb20gXCIuL2pvYlwiO1xuaW1wb3J0IHtGb2xkZXJKb2J9IGZyb20gXCIuL2ZvbGRlckpvYlwiO1xuaW1wb3J0IHtKb2JQcm9wZXJ0eX0gZnJvbSBcIi4vam9iUHJvcGVydHlcIjtcblxuY29uc3QgICB0bXAgPSByZXF1aXJlKFwidG1wXCIpLFxuICAgICAgICBmcyA9IHJlcXVpcmUoXCJmc1wiKSxcbiAgICAgICAgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpLFxuICAgICAgICBKU1ppcCA9IHJlcXVpcmUoXCJqc3ppcFwiKSxcbiAgICAgICAgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIiksXG4gICAgICAgIFJlZmxlY3QgPSByZXF1aXJlKFwicmVmbGVjdC1tZXRhZGF0YVwiKTtcblxuZXhwb3J0IGNsYXNzIFBhY2tlZEpvYiBleHRlbmRzIEZpbGVKb2Ige1xuXG4gICAgcHJvdGVjdGVkIGU6IEVudmlyb25tZW50O1xuICAgIHByb3RlY3RlZCBqb2I6IEpvYjtcblxuICAgIGNvbnN0cnVjdG9yKGU6IEVudmlyb25tZW50LCBqb2I6IEpvYikge1xuICAgICAgICAvLyBsZXQgam9iX25hbWUgPSBqb2IubmFtZTtcbiAgICAgICAgc3VwZXIoZSwgam9iLm5hbWUpO1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBwai5lID0gZTtcbiAgICAgICAgcGouam9iID0gam9iO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHJldHVybnMge0pvYn1cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0Sm9iKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5qb2I7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZXMgam9iIHRpY2tldCBhbmQgcmV0dXJucyB0aGUgX3BhdGggdG8gdGhlIHRlbXBvcmFyeSBmaWxlLlxuICAgICAqIEBwYXJhbSBqb2JcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRKb2JUaWNrZXQoam9iOiBKb2IpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgLy8gTWFrZSBqb2IgdGlja2V0XG4gICAgICAgIGxldCBqc29uID0gam9iLmdldEpTT04oKTtcbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcbiAgICAgICAgbGV0IGZpbGVfbmFtZSA9IGRpciArIHBhdGguc2VwICsgXCJ0aWNrZXQuanNvblwiO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVfbmFtZSwganNvbiwgXCJ1dGY4XCIpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBFcnJvciB3cml0aW5nIGpvYiB0aWNrZXQgdG8gdGVtcG9yYXJ5IGZpbGVgLCBwaik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVfbmFtZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYnVpbGRaaXAoemlwOiBhbnksIGNhbGxiYWNrKSB7XG4gICAgICAgIC8vIFNhdmUgb3V0IHppcFxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gdGhpcy5nZXRKb2IoKTtcbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcbiAgICAgICAgbGV0IGZpbGVfbmFtZSA9IGpvYi5uYW1lICsgXCIuYW50cGFjay56aXBcIjtcbiAgICAgICAgbGV0IGZpbGVfcGF0aCA9IGRpciArIHBhdGguc2VwICsgZmlsZV9uYW1lO1xuICAgICAgICB6aXBcbiAgICAgICAgICAgIC5nZW5lcmF0ZU5vZGVTdHJlYW0oe3R5cGU6IFwibm9kZWJ1ZmZlclwiLCBzdHJlYW1GaWxlczogdHJ1ZX0pXG4gICAgICAgICAgICAucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlX3BhdGgpKVxuICAgICAgICAgICAgLm9uKFwiZmluaXNoXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBKU1ppcCBnZW5lcmF0ZXMgYSByZWFkYWJsZSBzdHJlYW0gd2l0aCBhIFwiZW5kXCIgZXZlbnQsXG4gICAgICAgICAgICAgICAgLy8gYnV0IGlzIHBpcGVkIGhlcmUgaW4gYSB3cml0YWJsZSBzdHJlYW0gd2hpY2ggZW1pdHMgYSBcIl9maW5pc2hcIiBldmVudC5cbiAgICAgICAgICAgICAgICBwai5wYXRoID0gZmlsZV9wYXRoO1xuICAgICAgICAgICAgICAgIHBqLm5hbWUgPSBmaWxlX25hbWU7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBhY2tzIHRoZSByZWxhdGVkIGpvYiBvbiBjb25zdHJ1Y3Rpb24uXG4gICAgICovXG4gICAgcHVibGljIGV4ZWNQYWNrKGRvbmUpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHBqLmdldEpvYigpO1xuXG4gICAgICAgIGxldCB0aWNrZXRQYXRoID0gcGouZ2V0Sm9iVGlja2V0KGpvYik7XG5cbiAgICAgICAgbGV0IHppcCA9IG5ldyBKU1ppcCgpO1xuXG4gICAgICAgIC8vIEFkZCB0aWNrZXQgdG8gemlwXG4gICAgICAgIGZzLnJlYWRGaWxlKHRpY2tldFBhdGgsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAgICAgemlwLmZpbGUoXCJfdGlja2V0L3RpY2tldC5qc29uXCIsIGRhdGEpO1xuXG4gICAgICAgICAgICBpZiAoam9iLmlzRmlsZSgpKSB7XG5cbiAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZShqb2IucGF0aCwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICAgIHppcC5maWxlKFwiX2Fzc2V0L1wiICsgam9iLm5hbWUsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICAgICAgam9iLmZpbGVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGZpbGUucGF0aCwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShcIl9hc3NldFwiICsgcGF0aC5zZXAgKyBqb2IubmFtZVByb3BlciArIHBhdGguc2VwICsgZmlsZS5uYW1lLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByb3RlY3RlZCByZXN0b3JlSm9iVGlja2V0KGpzb25UaWNrZXQpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYk9iamVjdCwgam9iO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgam9iT2JqZWN0ID0gSlNPTi5wYXJzZShqc29uVGlja2V0KTtcblxuICAgICAgICAgICAgaWYgKGpvYk9iamVjdC5fdHlwZSA9PT0gXCJmaWxlXCIpIHtcbiAgICAgICAgICAgICAgICBqb2IgPSBuZXcgRmlsZUpvYihwai5lLCBqb2JPYmplY3QuX2lkKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoam9iT2JqZWN0Ll90eXBlID09PSBcImZvbGRlclwiKSB7XG4gICAgICAgICAgICAgICAgam9iID0gbmV3IEZvbGRlckpvYihwai5lLCBqb2JPYmplY3QuX2lkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGouZS5sb2coMywgYENhbm5vdCB1bnBhY2sgdGhpcyB0eXBlIG9mIGpvYjogJHtqb2JPYmplY3QuX3R5cGV9YCwgcGopO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhY2sgdGlja2V0IHBhcnNlIGVycm9yOiAke2Vycn0uYCwgcGopO1xuICAgICAgICAgICAgcGouZS5sb2coMywgYFVucGFyc2FibGUgdGlja2V0OiAke2pzb25UaWNrZXR9LmAsIHBqKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlc3RvcmUgcHJvcGVydHkgdmFsdWVzXG4gICAgICAgIGxldCBwcm9wcyA9IHt9O1xuXG4gICAgICAgIF8uZWFjaChqb2JPYmplY3QuX3Byb3BlcnRpZXMsIHByb3AgPT4ge1xuICAgICAgICAgICAgcHJvcHNbcHJvcC5fa2V5XSA9IG5ldyBKb2JQcm9wZXJ0eShwcm9wLl9rZXksIHByb3AuX3ZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGpvYi5wcm9wZXJ0eVZhbHVlcyA9IHByb3BzO1xuXG4gICAgICAgIC8vIFJlc3RvcmUgbGlmZWN5Y2xlXG4gICAgICAgIGpvYi5saWZlQ3ljbGUgPSBqb2JPYmplY3QuX2xpZmVDeWNsZTtcblxuICAgICAgICByZXR1cm4gam9iO1xuICAgIH1cblxuICAgIHB1YmxpYyBleGVjVW5wYWNrKGRvbmUpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJ1bnBhY2tpbmdcIik7XG5cbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHBqLmdldEpvYigpO1xuXG4gICAgICAgIC8vIFJlYWQgdGhlIHppcCB0byBhIGJ1ZmZlclxuICAgICAgICBmcy5yZWFkRmlsZShqb2IucGF0aCwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhY2tpbmcgcmVhZEZpbGUgZXJyb3I6ICR7ZXJyfWAsIHBqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE9wZW4gdGhlIHppcCBpbiBKU1ppcFxuICAgICAgICAgICAgSlNaaXAubG9hZEFzeW5jKGRhdGEpLnRoZW4oKHppcCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgam9iIHRpY2tldCBhbmQgY3JlYXRlIGpvYlxuICAgICAgICAgICAgICAgIHppcC5mb2xkZXIoXCJfdGlja2V0XCIpLmZvckVhY2goKHJlbGF0aXZlUGF0aCwgZmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShgX3RpY2tldCR7cGF0aC5zZXB9JHtyZWxhdGl2ZVBhdGh9YCkuYXN5bmMoXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRlbnQpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBvbGQgam9iIHRpY2tldFxuICAgICAgICAgICAgICAgICAgICAgICAgam9iID0gcGoucmVzdG9yZUpvYlRpY2tldChjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBfZmlsZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLnJlc3RvcmVGaWxlcyhqb2IsIHppcCwgKHVucGFja2VkSm9iKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSh1bnBhY2tlZEpvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUZpbGVzKGpvYjogSm9iLCB6aXA6IGFueSwgY2FsbGJhY2spIHtcblxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuXG5cbiAgICAgICAgLy8gQ2hlY2sgZm9yIHZhbGlkIHBhY2sgZm9ybWF0XG4gICAgICAgIGlmICh6aXAuZm9sZGVyKFwiX2Fzc2V0XCIpLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDIsIGBSZXN0b3JlZCBqb2IgZGlkIG5vdCBjb250YWluIGFueSBmaWxlIGFzc2V0cy5gLCBwaiwgW2pvYl0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCBmYWxzZSwgXCJfYXNzZXQvXCIsIChmb2xkZXJQYXRoLCBmb2xkZXJOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgam9iLnBhdGggPSBmb2xkZXJQYXRoO1xuICAgICAgICAgICAgICAgIGpvYi5yZW5hbWUoZm9sZGVyTmFtZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soam9iKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgdHJ1ZSwgXCJfYXNzZXQvXCIsIChmaWxlUGF0aCwgZmlsZU5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBqb2IucGF0aCA9IGZpbGVQYXRoO1xuICAgICAgICAgICAgICAgIGpvYi5yZW5hbWUoZmlsZU5hbWUpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGpvYik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBleHRyYWN0RmlsZXMoemlwOiBhbnksIHNpbmdsZTogYm9vbGVhbiwgemlwUGF0aDogc3RyaW5nLCBjYWxsYmFjazogYW55LCB0b3RhbEZpbGVzPzogbnVtYmVyKSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XG4gICAgICAgIGxldCB0ZW1wUGF0aCA9IHRtcG9iai5uYW1lO1xuXG4gICAgICAgIGxldCBmaWxlTnVtYmVyID0gMTtcblxuICAgICAgICBpZiAoIXRvdGFsRmlsZXMpIHtcbiAgICAgICAgICAgIHRvdGFsRmlsZXMgPSAwO1xuICAgICAgICAgICAgemlwLmZvbGRlcih6aXBQYXRoKS5mb3JFYWNoKChhc3NldCkgPT4gdG90YWxGaWxlcysrICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2luZ2xlID09PSB0cnVlKSB7XG5cbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGVOdW1iZXIgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBNb3JlIHRoYW4gMSBmaWxlcyBmb3VuZCB3aGVuIGV4dHJhY3RpbmcgYSBmaWxlIGpvYi5gLCBwaik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3UmVsUGF0aCA9IHppcFBhdGggKyByZWxhdGl2ZVBhdGg7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRmlsZXMtLTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLmV4dHJhY3RGaWxlcyh6aXAsIHNpbmdsZSwgbmV3UmVsUGF0aCwgY2FsbGJhY2ssIHRvdGFsRmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUobmV3UmVsUGF0aCkuYXN5bmMoXCJub2RlYnVmZmVyXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVOdW1iZXIrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZVBhdGggPSB0ZW1wUGF0aCArIHBhdGguc2VwICsgcmVsYXRpdmVQYXRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZpbGVQYXRoLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgemlwLmZvbGRlcih6aXBQYXRoKS5mb3JFYWNoKChyZWxhdGl2ZVBhdGgsIGFzc2V0KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG5ld1JlbFBhdGggPSB6aXBQYXRoICsgcmVsYXRpdmVQYXRoO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbEZpbGVzLS07XG5cbiAgICAgICAgICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgc2luZ2xlLCBuZXdSZWxQYXRoLCBjYWxsYmFjaywgdG90YWxGaWxlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShuZXdSZWxQYXRoKS5hc3luYyhcIm5vZGVidWZmZXJcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRlbnQpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gdGVtcFBhdGggKyBwYXRoLnNlcCArIHJlbGF0aXZlUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIGNvbnRlbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG90YWxGaWxlcyA9PT0gZmlsZU51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCByb290Rm9sZGVyTmFtZSA9IG5ld1JlbFBhdGguc3BsaXQocGF0aC5zZXApWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRlbXBQYXRoLCByb290Rm9sZGVyTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlTnVtYmVyKys7XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG59Il19
