"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        // let job_name = job.getName();
        _super.call(this, e, job.getName());
        var pj = this;
        pj.e = e;
        pj.job = job;
    }
    /**
     *
     * @returns {Job}
     */
    PackedJob.prototype.getJob = function () {
        return this.job;
    };
    /**
     * Makes job ticket and returns the path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.getJob();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.getName() + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "finish" event.
            pj.setPath(file_path);
            pj.setName(file_name);
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.pack = function (done) {
        var pj = this;
        var job = pj.getJob();
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.getPath(), function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.getName(), data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.getFiles().forEach(function (file) {
                    fs.readFile(file.getPath(), function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.getNameProper() + path.sep + file.getName(), data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            console.log("job type =>", jobObject.type, typeof jobObject);
            if (jobObject.type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject.basename);
            }
            else if (jobObject.type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject.basename);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject.type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
        }
        // Restore property values
        job.setPropertyValues(jobObject.properties);
        // Restore lifecycle
        job.setLifeCycle(jobObject.lifeCycle);
        return job;
    };
    PackedJob.prototype.unpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.getJob();
        // Read the zip to a buffer
        fs.readFile(job.getPath(), function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        // Restore files
                        pj.restoreFiles(job, zip, function (job) {
                            done(job);
                        });
                    });
                });
            });
        });
    };
    PackedJob.prototype.restoreFiles = function (job, zip, callback) {
        var pj = this;
        // Check for valid pack format
        if (zip.folder("_asset").length > 1) {
            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
        }
        if (job.isFolder()) {
            console.log("running folder");
            pj.extractFiles(zip, false, "_asset/", function (folderPath, folderName) {
                console.log("got callback", folderName, folderPath);
                job.setPath(folderPath);
                job.rename(folderName);
                console.log("DONE RESTORING");
                callback(job);
            });
        }
        else if (job.isFile()) {
            pj.extractFiles(zip, true, "_asset/", function (filePath, fileName) {
                job.setPath(filePath);
                job.rename(fileName);
                callback(job);
            });
        }
    };
    PackedJob.prototype.extractFiles = function (zip, single, zipPath, callback, totalFiles) {
        var pj = this;
        var tmpobj = tmp.dirSync();
        var tempPath = tmpobj.name;
        var fileNumber = 1;
        if (!totalFiles) {
            totalFiles = 0;
            zip.folder(zipPath).forEach(function (asset) { return totalFiles++; });
            console.log("totalFiles" + totalFiles);
        }
        if (single === true) {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                if (fileNumber > 1) {
                    pj.e.log(3, "More than 1 files found when extracting a file job.", pj);
                }
                else {
                    var newRelPath = zipPath + relativePath;
                    if (asset.dir === "true") {
                        totalFiles--;
                        pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                    }
                    else {
                        console.log("EXTRACTING SINGLE");
                        zip.file(newRelPath).async("nodebuffer")
                            .then(function (content) {
                            fileNumber++;
                            var filePath = tempPath + path.sep + relativePath;
                            console.log("*** filepath", filePath);
                            fs.writeFileSync(filePath, content);
                            callback(filePath, relativePath);
                        });
                    }
                }
            });
        }
        else {
            console.log("Extracting folder");
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                var newRelPath = zipPath + relativePath;
                console.log("file newRelPath", newRelPath);
                if (asset.dir === true) {
                    totalFiles--;
                    console.log("dir found", totalFiles);
                    pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                }
                else {
                    zip.file(newRelPath).async("nodebuffer")
                        .then(function (content) {
                        console.log(newRelPath, relativePath, typeof asset.dir);
                        var filePath = tempPath + path.sep + relativePath;
                        fs.writeFileSync(filePath, content);
                        console.log("Wrote out", filePath, totalFiles, fileNumber);
                        if (totalFiles === fileNumber) {
                            var rootFolderName = newRelPath.split(path.sep)[1];
                            console.log("Calling back, done unzipping", rootFolderName);
                            console.log(tempPath, rootFolderName);
                            callback(tempPath, rootFolderName);
                        }
                        fileNumber++;
                    });
                }
            });
        }
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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T0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBR3hELElBQUksUUFBUSxHQUFHLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLFlBQVksQ0FBQzt3QkFDbEQsRUFBRSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7d0JBRXBDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7d0JBRTNELEVBQUUsQ0FBQyxDQUFDLFVBQVUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDOzRCQUM1QixJQUFJLGNBQWMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxjQUFjLENBQUMsQ0FBQzs0QkFDNUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7NEJBQ3RDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7d0JBQ3ZDLENBQUM7d0JBQ0QsVUFBVSxFQUFFLENBQUM7b0JBRWpCLENBQUMsQ0FBQyxDQUFDO2dCQUNQLENBQUM7WUFFTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFFTCxDQUFDO0lBRUwsZ0JBQUM7QUFBRCxDQXZSQSxBQXVSQyxDQXZSOEIsaUJBQU8sR0F1UnJDO0FBdlJZLGlCQUFTLFlBdVJyQixDQUFBIiwiZmlsZSI6ImxpYi9qb2IvcGFja2VkSm9iLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFbnZpcm9ubWVudH0gZnJvbSBcIi4uL2Vudmlyb25tZW50L2Vudmlyb25tZW50XCI7XG5pbXBvcnQge0ZpbGVKb2J9IGZyb20gXCIuL2ZpbGVKb2JcIjtcbmltcG9ydCB7Sm9ifSBmcm9tIFwiLi9qb2JcIjtcbmltcG9ydCB7Rm9sZGVySm9ifSBmcm9tIFwiLi9mb2xkZXJKb2JcIjtcblxuY29uc3QgICB0bXAgPSByZXF1aXJlKFwidG1wXCIpLFxuICAgICAgICBmcyA9IHJlcXVpcmUoXCJmc1wiKSxcbiAgICAgICAgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpLFxuICAgICAgICBKU1ppcCA9IHJlcXVpcmUoXCJqc3ppcFwiKSxcbiAgICAgICAgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIiksXG4gICAgICAgIFJlZmxlY3QgPSByZXF1aXJlKFwicmVmbGVjdC1tZXRhZGF0YVwiKTtcblxuZXhwb3J0IGNsYXNzIFBhY2tlZEpvYiBleHRlbmRzIEZpbGVKb2Ige1xuXG4gICAgcHJvdGVjdGVkIGU6IEVudmlyb25tZW50O1xuICAgIHByb3RlY3RlZCBqb2I6IEpvYjtcblxuICAgIGNvbnN0cnVjdG9yKGU6IEVudmlyb25tZW50LCBqb2I6IEpvYikge1xuICAgICAgICAvLyBsZXQgam9iX25hbWUgPSBqb2IuZ2V0TmFtZSgpO1xuICAgICAgICBzdXBlcihlLCBqb2IuZ2V0TmFtZSgpKTtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgcGouZSA9IGU7XG4gICAgICAgIHBqLmpvYiA9IGpvYjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtKb2J9XG4gICAgICovXG4gICAgcHVibGljIGdldEpvYigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuam9iO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ha2VzIGpvYiB0aWNrZXQgYW5kIHJldHVybnMgdGhlIHBhdGggdG8gdGhlIHRlbXBvcmFyeSBmaWxlLlxuICAgICAqIEBwYXJhbSBqb2JcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRKb2JUaWNrZXQoam9iOiBKb2IpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgLy8gTWFrZSBqb2IgdGlja2V0XG4gICAgICAgIGxldCBqc29uID0gam9iLmdldEpTT04oKTtcbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcbiAgICAgICAgbGV0IGZpbGVfbmFtZSA9IGRpciArIHBhdGguc2VwICsgXCJ0aWNrZXQuanNvblwiO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVfbmFtZSwganNvbiwgXCJ1dGY4XCIpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBFcnJvciB3cml0aW5nIGpvYiB0aWNrZXQgdG8gdGVtcG9yYXJ5IGZpbGVgLCBwaik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVfbmFtZTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYnVpbGRaaXAoemlwOiBhbnksIGNhbGxiYWNrKSB7XG4gICAgICAgIC8vIFNhdmUgb3V0IHppcFxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gdGhpcy5nZXRKb2IoKTtcbiAgICAgICAgbGV0IHRtcG9iaiA9IHRtcC5kaXJTeW5jKCk7XG4gICAgICAgIGxldCBkaXIgPSB0bXBvYmoubmFtZTtcbiAgICAgICAgbGV0IGZpbGVfbmFtZSA9IGpvYi5nZXROYW1lKCkgKyBcIi5hbnRwYWNrLnppcFwiO1xuICAgICAgICBsZXQgZmlsZV9wYXRoID0gZGlyICsgcGF0aC5zZXAgKyBmaWxlX25hbWU7XG4gICAgICAgIHppcFxuICAgICAgICAgICAgLmdlbmVyYXRlTm9kZVN0cmVhbSh7dHlwZTogXCJub2RlYnVmZmVyXCIsIHN0cmVhbUZpbGVzOiB0cnVlfSlcbiAgICAgICAgICAgIC5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGZpbGVfcGF0aCkpXG4gICAgICAgICAgICAub24oXCJmaW5pc2hcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIEpTWmlwIGdlbmVyYXRlcyBhIHJlYWRhYmxlIHN0cmVhbSB3aXRoIGEgXCJlbmRcIiBldmVudCxcbiAgICAgICAgICAgICAgICAvLyBidXQgaXMgcGlwZWQgaGVyZSBpbiBhIHdyaXRhYmxlIHN0cmVhbSB3aGljaCBlbWl0cyBhIFwiZmluaXNoXCIgZXZlbnQuXG4gICAgICAgICAgICAgICAgcGouc2V0UGF0aChmaWxlX3BhdGgpO1xuICAgICAgICAgICAgICAgIHBqLnNldE5hbWUoZmlsZV9uYW1lKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFja3MgdGhlIHJlbGF0ZWQgam9iIG9uIGNvbnN0cnVjdGlvbi5cbiAgICAgKi9cbiAgICBwdWJsaWMgcGFjayhkb25lKSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIGxldCBqb2IgPSBwai5nZXRKb2IoKTtcblxuICAgICAgICBsZXQgdGlja2V0UGF0aCA9IHBqLmdldEpvYlRpY2tldChqb2IpO1xuXG4gICAgICAgIGxldCB6aXAgPSBuZXcgSlNaaXAoKTtcblxuICAgICAgICAvLyBBZGQgdGlja2V0IHRvIHppcFxuICAgICAgICBmcy5yZWFkRmlsZSh0aWNrZXRQYXRoLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgICAgICAgIHppcC5maWxlKFwiX3RpY2tldC90aWNrZXQuanNvblwiLCBkYXRhKTtcblxuICAgICAgICAgICAgaWYgKGpvYi5pc0ZpbGUoKSkge1xuXG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGUoam9iLmdldFBhdGgoKSwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICAgIHppcC5maWxlKFwiX2Fzc2V0L1wiICsgam9iLmdldE5hbWUoKSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoam9iLmlzRm9sZGVyKCkpIHtcbiAgICAgICAgICAgICAgICBqb2IuZ2V0RmlsZXMoKS5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZShmaWxlLmdldFBhdGgoKSwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShcIl9hc3NldFwiICsgcGF0aC5zZXAgKyBqb2IuZ2V0TmFtZVByb3BlcigpICsgcGF0aC5zZXAgKyBmaWxlLmdldE5hbWUoKSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUpvYlRpY2tldChqc29uVGlja2V0KSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIGxldCBqb2JPYmplY3QsIGpvYjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGpvYk9iamVjdCA9IEpTT04ucGFyc2UoanNvblRpY2tldCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImpvYiB0eXBlID0+XCIsIGpvYk9iamVjdC50eXBlLCB0eXBlb2Ygam9iT2JqZWN0KTtcblxuICAgICAgICAgICAgaWYgKGpvYk9iamVjdC50eXBlID09PSBcImZpbGVcIikge1xuICAgICAgICAgICAgICAgIGpvYiA9IG5ldyBGaWxlSm9iKHBqLmUsIGpvYk9iamVjdC5iYXNlbmFtZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvYk9iamVjdC50eXBlID09PSBcImZvbGRlclwiKSB7XG4gICAgICAgICAgICAgICAgam9iID0gbmV3IEZvbGRlckpvYihwai5lLCBqb2JPYmplY3QuYmFzZW5hbWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwai5lLmxvZygzLCBgQ2Fubm90IHVucGFjayB0aGlzIHR5cGUgb2Ygam9iOiAke2pvYk9iamVjdC50eXBlfWAsIHBqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBwai5lLmxvZygzLCBgVW5wYWNrIHRpY2tldCBwYXJzZSBlcnJvcjogJHtlcnJ9LmAsIHBqKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlc3RvcmUgcHJvcGVydHkgdmFsdWVzXG4gICAgICAgIGpvYi5zZXRQcm9wZXJ0eVZhbHVlcyhqb2JPYmplY3QucHJvcGVydGllcyk7XG5cbiAgICAgICAgLy8gUmVzdG9yZSBsaWZlY3ljbGVcbiAgICAgICAgam9iLnNldExpZmVDeWNsZShqb2JPYmplY3QubGlmZUN5Y2xlKTtcblxuICAgICAgICByZXR1cm4gam9iO1xuICAgIH1cblxuICAgIHB1YmxpYyB1bnBhY2soZG9uZSkge1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcInVucGFja2luZ1wiKTtcblxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gcGouZ2V0Sm9iKCk7XG5cbiAgICAgICAgLy8gUmVhZCB0aGUgemlwIHRvIGEgYnVmZmVyXG4gICAgICAgIGZzLnJlYWRGaWxlKGpvYi5nZXRQYXRoKCksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBwai5lLmxvZygzLCBgVW5wYWNraW5nIHJlYWRGaWxlIGVycm9yOiAke2Vycn1gLCBwaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBPcGVuIHRoZSB6aXAgaW4gSlNaaXBcbiAgICAgICAgICAgIEpTWmlwLmxvYWRBc3luYyhkYXRhKS50aGVuKCh6aXApID0+IHtcbiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIGpvYiB0aWNrZXQgYW5kIGNyZWF0ZSBqb2JcbiAgICAgICAgICAgICAgICB6aXAuZm9sZGVyKFwiX3RpY2tldFwiKS5mb3JFYWNoKChyZWxhdGl2ZVBhdGgsIGZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoYF90aWNrZXQke3BhdGguc2VwfSR7cmVsYXRpdmVQYXRofWApLmFzeW5jKFwic3RyaW5nXCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgb2xkIGpvYiB0aWNrZXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvYiA9IHBqLnJlc3RvcmVKb2JUaWNrZXQoY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgZmlsZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLnJlc3RvcmVGaWxlcyhqb2IsIHppcCwgKGpvYikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoam9iKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCByZXN0b3JlRmlsZXMoam9iOiBKb2IsIHppcDogYW55LCBjYWxsYmFjaykge1xuXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG5cblxuICAgICAgICAvLyBDaGVjayBmb3IgdmFsaWQgcGFjayBmb3JtYXRcbiAgICAgICAgaWYgKHppcC5mb2xkZXIoXCJfYXNzZXRcIikubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgcGouZS5sb2coMiwgYFJlc3RvcmVkIGpvYiBkaWQgbm90IGNvbnRhaW4gYW55IGZpbGUgYXNzZXRzLmAsIHBqLCBbam9iXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoam9iLmlzRm9sZGVyKCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicnVubmluZyBmb2xkZXJcIik7XG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCBmYWxzZSwgXCJfYXNzZXQvXCIsIChmb2xkZXJQYXRoLCBmb2xkZXJOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJnb3QgY2FsbGJhY2tcIiwgZm9sZGVyTmFtZSwgZm9sZGVyUGF0aClcbiAgICAgICAgICAgICAgICBqb2Iuc2V0UGF0aChmb2xkZXJQYXRoKTtcbiAgICAgICAgICAgICAgICBqb2IucmVuYW1lKGZvbGRlck5hbWUpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRE9ORSBSRVNUT1JJTkdcIik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soam9iKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgdHJ1ZSwgXCJfYXNzZXQvXCIsIChmaWxlUGF0aCwgZmlsZU5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBqb2Iuc2V0UGF0aChmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgam9iLnJlbmFtZShmaWxlTmFtZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soam9iKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGV4dHJhY3RGaWxlcyh6aXA6IGFueSwgc2luZ2xlOiBib29sZWFuLCB6aXBQYXRoOiBzdHJpbmcsIGNhbGxiYWNrOiBhbnksIHRvdGFsRmlsZXM/OiBudW1iZXIpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcblxuICAgICAgICBsZXQgdG1wb2JqID0gdG1wLmRpclN5bmMoKTtcbiAgICAgICAgbGV0IHRlbXBQYXRoID0gdG1wb2JqLm5hbWU7XG5cbiAgICAgICAgbGV0IGZpbGVOdW1iZXIgPSAxO1xuXG4gICAgICAgIGlmICghdG90YWxGaWxlcykge1xuICAgICAgICAgICAgdG90YWxGaWxlcyA9IDA7XG4gICAgICAgICAgICB6aXAuZm9sZGVyKHppcFBhdGgpLmZvckVhY2goKGFzc2V0KSA9PiB0b3RhbEZpbGVzKysgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidG90YWxGaWxlc1wiICsgdG90YWxGaWxlcyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2luZ2xlID09PSB0cnVlKSB7XG5cbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGVOdW1iZXIgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBNb3JlIHRoYW4gMSBmaWxlcyBmb3VuZCB3aGVuIGV4dHJhY3RpbmcgYSBmaWxlIGpvYi5gLCBwaik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3UmVsUGF0aCA9IHppcFBhdGggKyByZWxhdGl2ZVBhdGg7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRmlsZXMtLTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLmV4dHJhY3RGaWxlcyh6aXAsIHNpbmdsZSwgbmV3UmVsUGF0aCwgY2FsbGJhY2ssIHRvdGFsRmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFWFRSQUNUSU5HIFNJTkdMRVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKG5ld1JlbFBhdGgpLmFzeW5jKFwibm9kZWJ1ZmZlclwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlTnVtYmVyKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gdGVtcFBhdGggKyBwYXRoLnNlcCArIHJlbGF0aXZlUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIioqKiBmaWxlcGF0aFwiLCBmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmlsZVBhdGgsIHJlbGF0aXZlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkV4dHJhY3RpbmcgZm9sZGVyXCIpO1xuXG4gICAgICAgICAgICB6aXAuZm9sZGVyKHppcFBhdGgpLmZvckVhY2goKHJlbGF0aXZlUGF0aCwgYXNzZXQpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbmV3UmVsUGF0aCA9IHppcFBhdGggKyByZWxhdGl2ZVBhdGg7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImZpbGUgbmV3UmVsUGF0aFwiLCBuZXdSZWxQYXRoKTtcblxuXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbEZpbGVzLS07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJkaXIgZm91bmRcIiwgdG90YWxGaWxlcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgc2luZ2xlLCBuZXdSZWxQYXRoLCBjYWxsYmFjaywgdG90YWxGaWxlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShuZXdSZWxQYXRoKS5hc3luYyhcIm5vZGVidWZmZXJcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRlbnQpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cobmV3UmVsUGF0aCwgcmVsYXRpdmVQYXRoLCB0eXBlb2YgYXNzZXQuZGlyKTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZVBhdGggPSB0ZW1wUGF0aCArIHBhdGguc2VwICsgcmVsYXRpdmVQYXRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiV3JvdGUgb3V0XCIsIGZpbGVQYXRoLCB0b3RhbEZpbGVzLCBmaWxlTnVtYmVyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdGFsRmlsZXMgPT09IGZpbGVOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcm9vdEZvbGRlck5hbWUgPSBuZXdSZWxQYXRoLnNwbGl0KHBhdGguc2VwKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNhbGxpbmcgYmFjaywgZG9uZSB1bnppcHBpbmdcIiwgcm9vdEZvbGRlck5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRlbXBQYXRoLCByb290Rm9sZGVyTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodGVtcFBhdGgsIHJvb3RGb2xkZXJOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVOdW1iZXIrKztcblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICB9XG5cbn0iXX0=
