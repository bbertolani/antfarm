"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        // let job_name = job.name;
        _super.call(this, e, job.name);
        var pj = this;
        pj.e = e;
        pj.job = job;
    }
    /**
     *
     * @returns {Job}
     */
    PackedJob.prototype.getJob = function () {
        return this.job;
    };
    /**
     * Makes job ticket and returns the path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.getJob();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.name + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "finish" event.
            pj.setPath(file_path);
            pj.name = file_name;
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.execPack = function (done) {
        var pj = this;
        var job = pj.getJob();
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.getPath(), function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.name, data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.getFiles().forEach(function (file) {
                    fs.readFile(file.getPath(), function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.getNameProper() + path.sep + file.name, data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            if (jobObject.type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject.id);
            }
            else if (jobObject.type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject.id);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject.type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
            pj.e.log(3, "Unparsable ticket: " + jsonTicket + ".", pj);
        }
        // Restore property values
        job.setPropertyValues(jobObject.properties);
        // Restore lifecycle
        job.setLifeCycle(jobObject.lifeCycle);
        return job;
    };
    PackedJob.prototype.execUnpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.getJob();
        // Read the zip to a buffer
        fs.readFile(job.getPath(), function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        // Restore files
                        pj.restoreFiles(job, zip, function (unpackedJob) {
                            done(unpackedJob);
                        });
                    });
                });
            });
        });
    };
    PackedJob.prototype.restoreFiles = function (job, zip, callback) {
        var pj = this;
        // Check for valid pack format
        if (zip.folder("_asset").length > 1) {
            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
        }
        if (job.isFolder()) {
            pj.extractFiles(zip, false, "_asset/", function (folderPath, folderName) {
                job.setPath(folderPath);
                job.rename(folderName);
                callback(job);
            });
        }
        else if (job.isFile()) {
            pj.extractFiles(zip, true, "_asset/", function (filePath, fileName) {
                job.setPath(filePath);
                job.rename(fileName);
                callback(job);
            });
        }
    };
    PackedJob.prototype.extractFiles = function (zip, single, zipPath, callback, totalFiles) {
        var pj = this;
        var tmpobj = tmp.dirSync();
        var tempPath = tmpobj.name;
        var fileNumber = 1;
        if (!totalFiles) {
            totalFiles = 0;
            zip.folder(zipPath).forEach(function (asset) { return totalFiles++; });
        }
        if (single === true) {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                if (fileNumber > 1) {
                    pj.e.log(3, "More than 1 files found when extracting a file job.", pj);
                }
                else {
                    var newRelPath = zipPath + relativePath;
                    if (asset.dir === "true") {
                        totalFiles--;
                        pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                    }
                    else {
                        zip.file(newRelPath).async("nodebuffer")
                            .then(function (content) {
                            fileNumber++;
                            var filePath = tempPath + path.sep + relativePath;
                            fs.writeFileSync(filePath, content);
                            callback(filePath, relativePath);
                        });
                    }
                }
            });
        }
        else {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                var newRelPath = zipPath + relativePath;
                if (asset.dir === true) {
                    totalFiles--;
                    pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                }
                else {
                    zip.file(newRelPath).async("nodebuffer")
                        .then(function (content) {
                        var filePath = tempPath + path.sep + relativePath;
                        fs.writeFileSync(filePath, content);
                        if (totalFiles === fileNumber) {
                            var rootFolderName = newRelPath.split(path.sep)[1];
                            callback(tempPath, rootFolderName);
                        }
                        fileNumber++;
                    });
                }
            });
        }
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Y2VzQ29udGVudCI6WyJpbXBvcnQge0Vudmlyb25tZW50fSBmcm9tIFwiLi4vZW52aXJvbm1lbnQvZW52aXJvbm1lbnRcIjtcbmltcG9ydCB7RmlsZUpvYn0gZnJvbSBcIi4vZmlsZUpvYlwiO1xuaW1wb3J0IHtKb2J9IGZyb20gXCIuL2pvYlwiO1xuaW1wb3J0IHtGb2xkZXJKb2J9IGZyb20gXCIuL2ZvbGRlckpvYlwiO1xuXG5jb25zdCAgIHRtcCA9IHJlcXVpcmUoXCJ0bXBcIiksXG4gICAgICAgIGZzID0gcmVxdWlyZShcImZzXCIpLFxuICAgICAgICBwYXRoID0gcmVxdWlyZShcInBhdGhcIiksXG4gICAgICAgIEpTWmlwID0gcmVxdWlyZShcImpzemlwXCIpLFxuICAgICAgICBfID0gcmVxdWlyZShcImxvZGFzaFwiKSxcbiAgICAgICAgUmVmbGVjdCA9IHJlcXVpcmUoXCJyZWZsZWN0LW1ldGFkYXRhXCIpO1xuXG5leHBvcnQgY2xhc3MgUGFja2VkSm9iIGV4dGVuZHMgRmlsZUpvYiB7XG5cbiAgICBwcm90ZWN0ZWQgZTogRW52aXJvbm1lbnQ7XG4gICAgcHJvdGVjdGVkIGpvYjogSm9iO1xuXG4gICAgY29uc3RydWN0b3IoZTogRW52aXJvbm1lbnQsIGpvYjogSm9iKSB7XG4gICAgICAgIC8vIGxldCBqb2JfbmFtZSA9IGpvYi5uYW1lO1xuICAgICAgICBzdXBlcihlLCBqb2IubmFtZSk7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIHBqLmUgPSBlO1xuICAgICAgICBwai5qb2IgPSBqb2I7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7Sm9ifVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRKb2IoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmpvYjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlcyBqb2IgdGlja2V0IGFuZCByZXR1cm5zIHRoZSBwYXRoIHRvIHRoZSB0ZW1wb3JhcnkgZmlsZS5cbiAgICAgKiBAcGFyYW0gam9iXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZ2V0Sm9iVGlja2V0KGpvYjogSm9iKSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIC8vIE1ha2Ugam9iIHRpY2tldFxuICAgICAgICBsZXQganNvbiA9IGpvYi5nZXRKU09OKCk7XG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgZGlyID0gdG1wb2JqLm5hbWU7XG4gICAgICAgIGxldCBmaWxlX25hbWUgPSBkaXIgKyBwYXRoLnNlcCArIFwidGlja2V0Lmpzb25cIjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlX25hbWUsIGpzb24sIFwidXRmOFwiKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBwai5lLmxvZygzLCBgRXJyb3Igd3JpdGluZyBqb2IgdGlja2V0IHRvIHRlbXBvcmFyeSBmaWxlYCwgcGopO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWxlX25hbWU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGJ1aWxkWmlwKHppcDogYW55LCBjYWxsYmFjaykge1xuICAgICAgICAvLyBTYXZlIG91dCB6aXBcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHRoaXMuZ2V0Sm9iKCk7XG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgZGlyID0gdG1wb2JqLm5hbWU7XG4gICAgICAgIGxldCBmaWxlX25hbWUgPSBqb2IubmFtZSArIFwiLmFudHBhY2suemlwXCI7XG4gICAgICAgIGxldCBmaWxlX3BhdGggPSBkaXIgKyBwYXRoLnNlcCArIGZpbGVfbmFtZTtcbiAgICAgICAgemlwXG4gICAgICAgICAgICAuZ2VuZXJhdGVOb2RlU3RyZWFtKHt0eXBlOiBcIm5vZGVidWZmZXJcIiwgc3RyZWFtRmlsZXM6IHRydWV9KVxuICAgICAgICAgICAgLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZV9wYXRoKSlcbiAgICAgICAgICAgIC5vbihcImZpbmlzaFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gSlNaaXAgZ2VuZXJhdGVzIGEgcmVhZGFibGUgc3RyZWFtIHdpdGggYSBcImVuZFwiIGV2ZW50LFxuICAgICAgICAgICAgICAgIC8vIGJ1dCBpcyBwaXBlZCBoZXJlIGluIGEgd3JpdGFibGUgc3RyZWFtIHdoaWNoIGVtaXRzIGEgXCJmaW5pc2hcIiBldmVudC5cbiAgICAgICAgICAgICAgICBwai5zZXRQYXRoKGZpbGVfcGF0aCk7XG4gICAgICAgICAgICAgICAgcGoubmFtZSA9IGZpbGVfbmFtZTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFja3MgdGhlIHJlbGF0ZWQgam9iIG9uIGNvbnN0cnVjdGlvbi5cbiAgICAgKi9cbiAgICBwdWJsaWMgZXhlY1BhY2soZG9uZSkge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gcGouZ2V0Sm9iKCk7XG5cbiAgICAgICAgbGV0IHRpY2tldFBhdGggPSBwai5nZXRKb2JUaWNrZXQoam9iKTtcblxuICAgICAgICBsZXQgemlwID0gbmV3IEpTWmlwKCk7XG5cbiAgICAgICAgLy8gQWRkIHRpY2tldCB0byB6aXBcbiAgICAgICAgZnMucmVhZEZpbGUodGlja2V0UGF0aCwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICB6aXAuZmlsZShcIl90aWNrZXQvdGlja2V0Lmpzb25cIiwgZGF0YSk7XG5cbiAgICAgICAgICAgIGlmIChqb2IuaXNGaWxlKCkpIHtcblxuICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGpvYi5nZXRQYXRoKCksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShcIl9hc3NldC9cIiArIGpvYi5uYW1lLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2IuaXNGb2xkZXIoKSkge1xuICAgICAgICAgICAgICAgIGpvYi5nZXRGaWxlcygpLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGZpbGUuZ2V0UGF0aCgpLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKFwiX2Fzc2V0XCIgKyBwYXRoLnNlcCArIGpvYi5nZXROYW1lUHJvcGVyKCkgKyBwYXRoLnNlcCArIGZpbGUubmFtZSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUpvYlRpY2tldChqc29uVGlja2V0KSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIGxldCBqb2JPYmplY3QsIGpvYjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGpvYk9iamVjdCA9IEpTT04ucGFyc2UoanNvblRpY2tldCk7XG5cbiAgICAgICAgICAgIGlmIChqb2JPYmplY3QudHlwZSA9PT0gXCJmaWxlXCIpIHtcbiAgICAgICAgICAgICAgICBqb2IgPSBuZXcgRmlsZUpvYihwai5lLCBqb2JPYmplY3QuaWQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2JPYmplY3QudHlwZSA9PT0gXCJmb2xkZXJcIikge1xuICAgICAgICAgICAgICAgIGpvYiA9IG5ldyBGb2xkZXJKb2IocGouZSwgam9iT2JqZWN0LmlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGouZS5sb2coMywgYENhbm5vdCB1bnBhY2sgdGhpcyB0eXBlIG9mIGpvYjogJHtqb2JPYmplY3QudHlwZX1gLCBwaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcGouZS5sb2coMywgYFVucGFjayB0aWNrZXQgcGFyc2UgZXJyb3I6ICR7ZXJyfS5gLCBwaik7XG4gICAgICAgICAgICBwai5lLmxvZygzLCBgVW5wYXJzYWJsZSB0aWNrZXQ6ICR7anNvblRpY2tldH0uYCwgcGopO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVzdG9yZSBwcm9wZXJ0eSB2YWx1ZXNcbiAgICAgICAgam9iLnNldFByb3BlcnR5VmFsdWVzKGpvYk9iamVjdC5wcm9wZXJ0aWVzKTtcblxuICAgICAgICAvLyBSZXN0b3JlIGxpZmVjeWNsZVxuICAgICAgICBqb2Iuc2V0TGlmZUN5Y2xlKGpvYk9iamVjdC5saWZlQ3ljbGUpO1xuXG4gICAgICAgIHJldHVybiBqb2I7XG4gICAgfVxuXG4gICAgcHVibGljIGV4ZWNVbnBhY2soZG9uZSkge1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcInVucGFja2luZ1wiKTtcblxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gcGouZ2V0Sm9iKCk7XG5cbiAgICAgICAgLy8gUmVhZCB0aGUgemlwIHRvIGEgYnVmZmVyXG4gICAgICAgIGZzLnJlYWRGaWxlKGpvYi5nZXRQYXRoKCksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBwai5lLmxvZygzLCBgVW5wYWNraW5nIHJlYWRGaWxlIGVycm9yOiAke2Vycn1gLCBwaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBPcGVuIHRoZSB6aXAgaW4gSlNaaXBcbiAgICAgICAgICAgIEpTWmlwLmxvYWRBc3luYyhkYXRhKS50aGVuKCh6aXApID0+IHtcbiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIGpvYiB0aWNrZXQgYW5kIGNyZWF0ZSBqb2JcbiAgICAgICAgICAgICAgICB6aXAuZm9sZGVyKFwiX3RpY2tldFwiKS5mb3JFYWNoKChyZWxhdGl2ZVBhdGgsIGZpbGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoYF90aWNrZXQke3BhdGguc2VwfSR7cmVsYXRpdmVQYXRofWApLmFzeW5jKFwic3RyaW5nXCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgb2xkIGpvYiB0aWNrZXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvYiA9IHBqLnJlc3RvcmVKb2JUaWNrZXQoY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgZmlsZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLnJlc3RvcmVGaWxlcyhqb2IsIHppcCwgKHVucGFja2VkSm9iKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSh1bnBhY2tlZEpvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUZpbGVzKGpvYjogSm9iLCB6aXA6IGFueSwgY2FsbGJhY2spIHtcblxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuXG5cbiAgICAgICAgLy8gQ2hlY2sgZm9yIHZhbGlkIHBhY2sgZm9ybWF0XG4gICAgICAgIGlmICh6aXAuZm9sZGVyKFwiX2Fzc2V0XCIpLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDIsIGBSZXN0b3JlZCBqb2IgZGlkIG5vdCBjb250YWluIGFueSBmaWxlIGFzc2V0cy5gLCBwaiwgW2pvYl0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCBmYWxzZSwgXCJfYXNzZXQvXCIsIChmb2xkZXJQYXRoLCBmb2xkZXJOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgam9iLnNldFBhdGgoZm9sZGVyUGF0aCk7XG4gICAgICAgICAgICAgICAgam9iLnJlbmFtZShmb2xkZXJOYW1lKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhqb2IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoam9iLmlzRmlsZSgpKSB7XG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCB0cnVlLCBcIl9hc3NldC9cIiwgKGZpbGVQYXRoLCBmaWxlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGpvYi5zZXRQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgICBqb2IucmVuYW1lKGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhqb2IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZXh0cmFjdEZpbGVzKHppcDogYW55LCBzaW5nbGU6IGJvb2xlYW4sIHppcFBhdGg6IHN0cmluZywgY2FsbGJhY2s6IGFueSwgdG90YWxGaWxlcz86IG51bWJlcikge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuXG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgdGVtcFBhdGggPSB0bXBvYmoubmFtZTtcblxuICAgICAgICBsZXQgZmlsZU51bWJlciA9IDE7XG5cbiAgICAgICAgaWYgKCF0b3RhbEZpbGVzKSB7XG4gICAgICAgICAgICB0b3RhbEZpbGVzID0gMDtcbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgoYXNzZXQpID0+IHRvdGFsRmlsZXMrKyApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNpbmdsZSA9PT0gdHJ1ZSkge1xuXG4gICAgICAgICAgICB6aXAuZm9sZGVyKHppcFBhdGgpLmZvckVhY2goKHJlbGF0aXZlUGF0aCwgYXNzZXQpID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChmaWxlTnVtYmVyID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBwai5lLmxvZygzLCBgTW9yZSB0aGFuIDEgZmlsZXMgZm91bmQgd2hlbiBleHRyYWN0aW5nIGEgZmlsZSBqb2IuYCwgcGopO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld1JlbFBhdGggPSB6aXBQYXRoICsgcmVsYXRpdmVQYXRoO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChhc3NldC5kaXIgPT09IFwidHJ1ZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEZpbGVzLS07XG4gICAgICAgICAgICAgICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCBzaW5nbGUsIG5ld1JlbFBhdGgsIGNhbGxiYWNrLCB0b3RhbEZpbGVzKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKG5ld1JlbFBhdGgpLmFzeW5jKFwibm9kZWJ1ZmZlclwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlTnVtYmVyKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gdGVtcFBhdGggKyBwYXRoLnNlcCArIHJlbGF0aXZlUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmaWxlUGF0aCwgcmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBuZXdSZWxQYXRoID0gemlwUGF0aCArIHJlbGF0aXZlUGF0aDtcblxuICAgICAgICAgICAgICAgIGlmIChhc3NldC5kaXIgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWxGaWxlcy0tO1xuXG4gICAgICAgICAgICAgICAgICAgIHBqLmV4dHJhY3RGaWxlcyh6aXAsIHNpbmdsZSwgbmV3UmVsUGF0aCwgY2FsbGJhY2ssIHRvdGFsRmlsZXMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUobmV3UmVsUGF0aCkuYXN5bmMoXCJub2RlYnVmZmVyXCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmaWxlUGF0aCA9IHRlbXBQYXRoICsgcGF0aC5zZXAgKyByZWxhdGl2ZVBhdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdGFsRmlsZXMgPT09IGZpbGVOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcm9vdEZvbGRlck5hbWUgPSBuZXdSZWxQYXRoLnNwbGl0KHBhdGguc2VwKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0ZW1wUGF0aCwgcm9vdEZvbGRlck5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZU51bWJlcisrO1xuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgIH1cblxufSJdfQ==
