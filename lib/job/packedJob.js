"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        // let job_name = job.getName();
        _super.call(this, e, job.getName());
        var pj = this;
        pj.e = e;
        pj.job = job;
    }
    /**
     *
     * @returns {Job}
     */
    PackedJob.prototype.getJob = function () {
        return this.job;
    };
    /**
     * Makes job ticket and returns the path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.getJob();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.getName() + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "finish" event.
            pj.setPath(file_path);
            pj.setName(file_name);
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.pack = function (done) {
        var pj = this;
        var job = pj.getJob();
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.getPath(), function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.getName(), data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.getFiles().forEach(function (file) {
                    fs.readFile(file.getPath(), function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.getNameProper() + path.sep + file.getName(), data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            console.log("job type =>", jobObject.type, typeof jobObject);
            if (jobObject.type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject.basename);
            }
            else if (jobObject.type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject.basename);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject.type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
        }
        // Restore property values
        job.setPropertyValues(jobObject.properties);
        // Restore lifecycle
        job.setLifeCycle(jobObject.lifeCycle);
        return job;
    };
    PackedJob.prototype.unpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.getJob();
        // Read the zip to a buffer
        fs.readFile(job.getPath(), function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        var tmpobj = tmp.dirSync();
                        var tempPath = tmpobj.name;
                        if (zip.folder("_asset").length > 1) {
                            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
                        }
                        zip.folder("_asset").forEach(function (relativePath, file) {
                            // console.log("iterating over", relativePath);
                            zip.file("_asset" + path.sep + relativePath).async("nodebuffer")
                                .then(function (content) {
                                var filePath = tempPath + path.sep + relativePath;
                                fs.writeFileSync(filePath, content);
                                if (job.isFolder()) {
                                    console.log("gotta add file to job for folder");
                                }
                                else {
                                    job.setPath(filePath);
                                    job.rename(relativePath);
                                }
                                done(job);
                            });
                        });
                    });
                    // let readFile = fs.readFileSync(file.asNodeBuffer());
                    // console.log("readFile", readFile);
                });
                //
                // zip.folder("_asset").forEach(function (relativePath, file){
                //     console.log("iterating over", relativePath);
                // });
            });
        });
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDO2dDQUNsRCxFQUFFLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztnQ0FDcEMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztvQ0FDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO2dDQUNwRCxDQUFDO2dDQUFDLElBQUksQ0FBQyxDQUFDO29DQUNKLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7b0NBQ3RCLEdBQUcsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7Z0NBQzdCLENBQUM7Z0NBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUVkLENBQUMsQ0FBQyxDQUFDO3dCQUVYLENBQUMsQ0FBQyxDQUFDO29CQUdQLENBQUMsQ0FBQyxDQUFDO29CQUNQLHVEQUF1RDtvQkFFdkQscUNBQXFDO2dCQUN6QyxDQUFDLENBQUMsQ0FBQztnQkFDSCxFQUFFO2dCQUNGLDhEQUE4RDtnQkFDOUQsbURBQW1EO2dCQUNuRCxNQUFNO1lBSVYsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFTCxnQkFBQztBQUFELENBeE1BLEFBd01DLENBeE04QixpQkFBTyxHQXdNckM7QUF4TVksaUJBQVMsWUF3TXJCLENBQUEiLCJmaWxlIjoibGliL2pvYi9wYWNrZWRKb2IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Vudmlyb25tZW50fSBmcm9tIFwiLi4vZW52aXJvbm1lbnQvZW52aXJvbm1lbnRcIjtcbmltcG9ydCB7RmlsZUpvYn0gZnJvbSBcIi4vZmlsZUpvYlwiO1xuaW1wb3J0IHtKb2J9IGZyb20gXCIuL2pvYlwiO1xuaW1wb3J0IHtGb2xkZXJKb2J9IGZyb20gXCIuL2ZvbGRlckpvYlwiO1xuXG5jb25zdCAgIHRtcCA9IHJlcXVpcmUoXCJ0bXBcIiksXG4gICAgICAgIGZzID0gcmVxdWlyZShcImZzXCIpLFxuICAgICAgICBwYXRoID0gcmVxdWlyZShcInBhdGhcIiksXG4gICAgICAgIEpTWmlwID0gcmVxdWlyZShcImpzemlwXCIpLFxuICAgICAgICBfID0gcmVxdWlyZShcImxvZGFzaFwiKSxcbiAgICAgICAgUmVmbGVjdCA9IHJlcXVpcmUoXCJyZWZsZWN0LW1ldGFkYXRhXCIpO1xuXG5leHBvcnQgY2xhc3MgUGFja2VkSm9iIGV4dGVuZHMgRmlsZUpvYiB7XG5cbiAgICBwcm90ZWN0ZWQgZTogRW52aXJvbm1lbnQ7XG4gICAgcHJvdGVjdGVkIGpvYjogSm9iO1xuXG4gICAgY29uc3RydWN0b3IoZTogRW52aXJvbm1lbnQsIGpvYjogSm9iKSB7XG4gICAgICAgIC8vIGxldCBqb2JfbmFtZSA9IGpvYi5nZXROYW1lKCk7XG4gICAgICAgIHN1cGVyKGUsIGpvYi5nZXROYW1lKCkpO1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBwai5lID0gZTtcbiAgICAgICAgcGouam9iID0gam9iO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHJldHVybnMge0pvYn1cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0Sm9iKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5qb2I7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWFrZXMgam9iIHRpY2tldCBhbmQgcmV0dXJucyB0aGUgcGF0aCB0byB0aGUgdGVtcG9yYXJ5IGZpbGUuXG4gICAgICogQHBhcmFtIGpvYlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGdldEpvYlRpY2tldChqb2I6IEpvYikge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICAvLyBNYWtlIGpvYiB0aWNrZXRcbiAgICAgICAgbGV0IGpzb24gPSBqb2IuZ2V0SlNPTigpO1xuICAgICAgICBsZXQgdG1wb2JqID0gdG1wLmRpclN5bmMoKTtcbiAgICAgICAgbGV0IGRpciA9IHRtcG9iai5uYW1lO1xuICAgICAgICBsZXQgZmlsZV9uYW1lID0gZGlyICsgcGF0aC5zZXAgKyBcInRpY2tldC5qc29uXCI7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZV9uYW1lLCBqc29uLCBcInV0ZjhcIik7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcGouZS5sb2coMywgYEVycm9yIHdyaXRpbmcgam9iIHRpY2tldCB0byB0ZW1wb3JhcnkgZmlsZWAsIHBqKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmlsZV9uYW1lO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBidWlsZFppcCh6aXA6IGFueSwgY2FsbGJhY2spIHtcbiAgICAgICAgLy8gU2F2ZSBvdXQgemlwXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIGxldCBqb2IgPSB0aGlzLmdldEpvYigpO1xuICAgICAgICBsZXQgdG1wb2JqID0gdG1wLmRpclN5bmMoKTtcbiAgICAgICAgbGV0IGRpciA9IHRtcG9iai5uYW1lO1xuICAgICAgICBsZXQgZmlsZV9uYW1lID0gam9iLmdldE5hbWUoKSArIFwiLmFudHBhY2suemlwXCI7XG4gICAgICAgIGxldCBmaWxlX3BhdGggPSBkaXIgKyBwYXRoLnNlcCArIGZpbGVfbmFtZTtcbiAgICAgICAgemlwXG4gICAgICAgICAgICAuZ2VuZXJhdGVOb2RlU3RyZWFtKHt0eXBlOiBcIm5vZGVidWZmZXJcIiwgc3RyZWFtRmlsZXM6IHRydWV9KVxuICAgICAgICAgICAgLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZV9wYXRoKSlcbiAgICAgICAgICAgIC5vbihcImZpbmlzaFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gSlNaaXAgZ2VuZXJhdGVzIGEgcmVhZGFibGUgc3RyZWFtIHdpdGggYSBcImVuZFwiIGV2ZW50LFxuICAgICAgICAgICAgICAgIC8vIGJ1dCBpcyBwaXBlZCBoZXJlIGluIGEgd3JpdGFibGUgc3RyZWFtIHdoaWNoIGVtaXRzIGEgXCJmaW5pc2hcIiBldmVudC5cbiAgICAgICAgICAgICAgICBwai5zZXRQYXRoKGZpbGVfcGF0aCk7XG4gICAgICAgICAgICAgICAgcGouc2V0TmFtZShmaWxlX25hbWUpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQYWNrcyB0aGUgcmVsYXRlZCBqb2Igb24gY29uc3RydWN0aW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBwYWNrKGRvbmUpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHBqLmdldEpvYigpO1xuXG4gICAgICAgIGxldCB0aWNrZXRQYXRoID0gcGouZ2V0Sm9iVGlja2V0KGpvYik7XG5cbiAgICAgICAgbGV0IHppcCA9IG5ldyBKU1ppcCgpO1xuXG4gICAgICAgIC8vIEFkZCB0aWNrZXQgdG8gemlwXG4gICAgICAgIGZzLnJlYWRGaWxlKHRpY2tldFBhdGgsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAgICAgemlwLmZpbGUoXCJfdGlja2V0L3RpY2tldC5qc29uXCIsIGRhdGEpO1xuXG4gICAgICAgICAgICBpZiAoam9iLmlzRmlsZSgpKSB7XG5cbiAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZShqb2IuZ2V0UGF0aCgpLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoXCJfYXNzZXQvXCIgKyBqb2IuZ2V0TmFtZSgpLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2IuaXNGb2xkZXIoKSkge1xuICAgICAgICAgICAgICAgIGpvYi5nZXRGaWxlcygpLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGZpbGUuZ2V0UGF0aCgpLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKFwiX2Fzc2V0XCIgKyBwYXRoLnNlcCArIGpvYi5nZXROYW1lUHJvcGVyKCkgKyBwYXRoLnNlcCArIGZpbGUuZ2V0TmFtZSgpLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLmJ1aWxkWmlwKHppcCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIHByb3RlY3RlZCByZXN0b3JlSm9iVGlja2V0KGpzb25UaWNrZXQpIHtcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYk9iamVjdCwgam9iO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgam9iT2JqZWN0ID0gSlNPTi5wYXJzZShqc29uVGlja2V0KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiam9iIHR5cGUgPT5cIiwgam9iT2JqZWN0LnR5cGUsIHR5cGVvZiBqb2JPYmplY3QpO1xuXG4gICAgICAgICAgICBpZiAoam9iT2JqZWN0LnR5cGUgPT09IFwiZmlsZVwiKSB7XG4gICAgICAgICAgICAgICAgam9iID0gbmV3IEZpbGVKb2IocGouZSwgam9iT2JqZWN0LmJhc2VuYW1lKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoam9iT2JqZWN0LnR5cGUgPT09IFwiZm9sZGVyXCIpIHtcbiAgICAgICAgICAgICAgICBqb2IgPSBuZXcgRm9sZGVySm9iKHBqLmUsIGpvYk9iamVjdC5iYXNlbmFtZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBDYW5ub3QgdW5wYWNrIHRoaXMgdHlwZSBvZiBqb2I6ICR7am9iT2JqZWN0LnR5cGV9YCwgcGopO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhY2sgdGlja2V0IHBhcnNlIGVycm9yOiAke2Vycn0uYCwgcGopO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVzdG9yZSBwcm9wZXJ0eSB2YWx1ZXNcbiAgICAgICAgam9iLnNldFByb3BlcnR5VmFsdWVzKGpvYk9iamVjdC5wcm9wZXJ0aWVzKTtcblxuICAgICAgICAvLyBSZXN0b3JlIGxpZmVjeWNsZVxuICAgICAgICBqb2Iuc2V0TGlmZUN5Y2xlKGpvYk9iamVjdC5saWZlQ3ljbGUpO1xuXG4gICAgICAgIHJldHVybiBqb2I7XG4gICAgfVxuXG4gICAgcHVibGljIHVucGFjayhkb25lKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwidW5wYWNraW5nXCIpO1xuXG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIGxldCBqb2IgPSBwai5nZXRKb2IoKTtcblxuICAgICAgICAvLyBSZWFkIHRoZSB6aXAgdG8gYSBidWZmZXJcbiAgICAgICAgZnMucmVhZEZpbGUoam9iLmdldFBhdGgoKSwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBVbnBhY2tpbmcgcmVhZEZpbGUgZXJyb3I6ICR7ZXJyfWAsIHBqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE9wZW4gdGhlIHppcCBpbiBKU1ppcFxuICAgICAgICAgICAgSlNaaXAubG9hZEFzeW5jKGRhdGEpLnRoZW4oKHppcCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgam9iIHRpY2tldCBhbmQgY3JlYXRlIGpvYlxuICAgICAgICAgICAgICAgIHppcC5mb2xkZXIoXCJfdGlja2V0XCIpLmZvckVhY2goKHJlbGF0aXZlUGF0aCwgZmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShgX3RpY2tldCR7cGF0aC5zZXB9JHtyZWxhdGl2ZVBhdGh9YCkuYXN5bmMoXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG9sZCBqb2IgdGlja2V0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgam9iID0gcGoucmVzdG9yZUpvYlRpY2tldChjb250ZW50KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0ZW1wUGF0aCA9IHRtcG9iai5uYW1lO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHppcC5mb2xkZXIoXCJfYXNzZXRcIikubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwai5lLmxvZygyLCBgUmVzdG9yZWQgam9iIGRpZCBub3QgY29udGFpbiBhbnkgZmlsZSBhc3NldHMuYCwgcGosIFtqb2JdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB6aXAuZm9sZGVyKFwiX2Fzc2V0XCIpLmZvckVhY2goKHJlbGF0aXZlUGF0aCwgZmlsZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIml0ZXJhdGluZyBvdmVyXCIsIHJlbGF0aXZlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoYF9hc3NldCR7cGF0aC5zZXB9JHtyZWxhdGl2ZVBhdGh9YCkuYXN5bmMoXCJub2RlYnVmZmVyXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBmaWxlUGF0aCA9IHRlbXBQYXRoICsgcGF0aC5zZXAgKyByZWxhdGl2ZVBhdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZ290dGEgYWRkIGZpbGUgdG8gam9iIGZvciBmb2xkZXJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgam9iLnNldFBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2IucmVuYW1lKHJlbGF0aXZlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZShqb2IpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBsZXQgcmVhZEZpbGUgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZS5hc05vZGVCdWZmZXIoKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZWFkRmlsZVwiLCByZWFkRmlsZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyB6aXAuZm9sZGVyKFwiX2Fzc2V0XCIpLmZvckVhY2goZnVuY3Rpb24gKHJlbGF0aXZlUGF0aCwgZmlsZSl7XG4gICAgICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKFwiaXRlcmF0aW5nIG92ZXJcIiwgcmVsYXRpdmVQYXRoKTtcbiAgICAgICAgICAgICAgICAvLyB9KTtcblxuXG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgIH1cblxufSJdfQ==
