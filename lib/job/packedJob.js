"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var fileJob_1 = require("./fileJob");
var folderJob_1 = require("./folderJob");
var tmp = require("tmp"), fs = require("fs"), path = require("path"), JSZip = require("jszip"), _ = require("lodash"), Reflect = require("reflect-metadata");
var PackedJob = (function (_super) {
    __extends(PackedJob, _super);
    function PackedJob(e, job) {
        // let job_name = job.getName();
        _super.call(this, e, job.getName());
        var pj = this;
        pj.e = e;
        pj.job = job;
    }
    /**
     *
     * @returns {Job}
     */
    PackedJob.prototype.getJob = function () {
        return this.job;
    };
    /**
     * Makes job ticket and returns the path to the temporary file.
     * @param job
     * @returns {string}
     */
    PackedJob.prototype.getJobTicket = function (job) {
        var pj = this;
        // Make job ticket
        var json = job.getJSON();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = dir + path.sep + "ticket.json";
        try {
            fs.writeFileSync(file_name, json, "utf8");
        }
        catch (err) {
            pj.e.log(3, "Error writing job ticket to temporary file", pj);
        }
        return file_name;
    };
    PackedJob.prototype.buildZip = function (zip, callback) {
        // Save out zip
        var pj = this;
        var job = this.getJob();
        var tmpobj = tmp.dirSync();
        var dir = tmpobj.name;
        var file_name = job.getName() + ".antpack.zip";
        var file_path = dir + path.sep + file_name;
        zip
            .generateNodeStream({ type: "nodebuffer", streamFiles: true })
            .pipe(fs.createWriteStream(file_path))
            .on("finish", function () {
            // JSZip generates a readable stream with a "end" event,
            // but is piped here in a writable stream which emits a "finish" event.
            pj.setPath(file_path);
            pj.setName(file_name);
            callback();
        });
    };
    /**
     * Packs the related job on construction.
     */
    PackedJob.prototype.pack = function (done) {
        var pj = this;
        var job = pj.getJob();
        var ticketPath = pj.getJobTicket(job);
        var zip = new JSZip();
        // Add ticket to zip
        fs.readFile(ticketPath, function (err, data) {
            if (err)
                throw err;
            zip.file("_ticket/ticket.json", data);
            if (job.isFile()) {
                fs.readFile(job.getPath(), function (err, data) {
                    if (err)
                        throw err;
                    zip.file("_asset/" + job.getName(), data);
                    pj.buildZip(zip, function () {
                        done();
                    });
                });
            }
            else if (job.isFolder()) {
                job.getFiles().forEach(function (file) {
                    fs.readFile(file.getPath(), function (err, data) {
                        if (err)
                            throw err;
                        zip.file("_asset" + path.sep + job.getNameProper() + path.sep + file.getName(), data);
                        pj.buildZip(zip, function () {
                            done();
                        });
                    });
                });
            }
            else {
                pj.buildZip(zip, function () {
                    done();
                });
            }
        });
    };
    PackedJob.prototype.restoreJobTicket = function (jsonTicket) {
        var pj = this;
        var jobObject, job;
        try {
            jobObject = JSON.parse(jsonTicket);
            console.log("job type =>", jobObject.type, typeof jobObject);
            if (jobObject.type === "file") {
                job = new fileJob_1.FileJob(pj.e, jobObject.basename);
            }
            else if (jobObject.type === "folder") {
                job = new folderJob_1.FolderJob(pj.e, jobObject.basename);
            }
            else {
                pj.e.log(3, "Cannot unpack this type of job: " + jobObject.type, pj);
            }
        }
        catch (err) {
            pj.e.log(3, "Unpack ticket parse error: " + err + ".", pj);
        }
        // Restore property values
        job.setPropertyValues(jobObject.properties);
        // Restore lifecycle
        job.setLifeCycle(jobObject.lifeCycle);
        return job;
    };
    PackedJob.prototype.unpack = function (done) {
        // console.log("unpacking");
        var pj = this;
        var job = pj.getJob();
        // Read the zip to a buffer
        fs.readFile(job.getPath(), function (err, data) {
            if (err) {
                pj.e.log(3, "Unpacking readFile error: " + err, pj);
            }
            // Open the zip in JSZip
            JSZip.loadAsync(data).then(function (zip) {
                // Restore job ticket and create job
                zip.folder("_ticket").forEach(function (relativePath, file) {
                    zip.file("_ticket" + path.sep + relativePath).async("string")
                        .then(function (content) {
                        // Restore old job ticket
                        job = pj.restoreJobTicket(content);
                        // Restore files
                        pj.restoreFiles(job, zip, function (job) {
                            done(job);
                        });
                    });
                });
            });
        });
    };
    PackedJob.prototype.restoreFiles = function (job, zip, callback) {
        var pj = this;
        // Check for valid pack format
        if (zip.folder("_asset").length > 1) {
            pj.e.log(2, "Restored job did not contain any file assets.", pj, [job]);
        }
        if (job.isFolder()) {
            console.log("running folder");
            pj.extractFiles(zip, false, "_asset/", function (filePath, folderName) {
                job.setPath(filePath);
                job.rename(folderName);
                callback(job);
            });
        }
        else if (job.isFile()) {
            pj.extractFiles(zip, true, "_asset/", function (filePath, fileName) {
                job.setPath(filePath);
                job.rename(fileName);
                callback(job);
            });
        }
    };
    PackedJob.prototype.extractFiles = function (zip, single, zipPath, callback, totalFiles) {
        var pj = this;
        var tmpobj = tmp.dirSync();
        var tempPath = tmpobj.name;
        var fileNumber = 1;
        console.log("original totalFiles", totalFiles);
        if (!totalFiles) {
            totalFiles = 0;
            zip.folder(zipPath).forEach(function (asset) { return totalFiles++; });
            console.log("totalFiles" + totalFiles);
        }
        if (single === true) {
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                if (fileNumber > 1) {
                    pj.e.log(3, "More than 1 files found when extracting a file job.", pj);
                }
                else {
                    var newRelPath = zipPath + path.sep + relativePath;
                    if (asset.dir === "true") {
                        totalFiles--;
                        pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                    }
                    else {
                        console.log("EXTRACTING SINGLE");
                        zip.file(newRelPath).async("nodebuffer")
                            .then(function (content) {
                            fileNumber++;
                            var filePath = tempPath + path.sep + relativePath;
                            fs.writeFileSync(filePath, content);
                            callback(filePath, relativePath);
                        });
                    }
                }
            });
        }
        else {
            console.log("Extracting folder");
            zip.folder(zipPath).forEach(function (relativePath, asset) {
                var newRelPath = zipPath + relativePath;
                if (asset.dir === true) {
                    totalFiles--;
                    console.log("dir found", totalFiles);
                    pj.extractFiles(zip, single, newRelPath, callback, totalFiles);
                }
                else {
                    zip.file(newRelPath).async("nodebuffer")
                        .then(function (content) {
                        console.log("EXTRACTING SINGLE FROM FOLDER", totalFiles, fileNumber);
                        console.log(newRelPath, relativePath, typeof asset.dir);
                        fileNumber++;
                        var filePath = tempPath + path.sep + relativePath;
                        fs.writeFileSync(filePath, content);
                        if (totalFiles === fileNumber) {
                            console.log("relativePath.split(path.sep)", relativePath.split(path.sep));
                            callback(tempPath, newRelPath.split(path.sep)[1]);
                        }
                    });
                }
            });
        }
    };
    return PackedJob;
}(fileJob_1.FileJob));
exports.PackedJob = PackedJob;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QVEsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLFlBQVksQ0FBQzt3QkFDbEQsRUFBRSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7d0JBRXBDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDOzRCQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQzFFLFFBQVEsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDdEQsQ0FBQztvQkFFTCxDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDO1lBRUwsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBRUwsQ0FBQztJQUVMLGdCQUFDO0FBQUQsQ0FqUkEsQUFpUkMsQ0FqUjhCLGlCQUFPLEdBaVJyQztBQWpSWSxpQkFBUyxZQWlSckIsQ0FBQSIsImZpbGUiOiJsaWIvam9iL3BhY2tlZEpvYi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RW52aXJvbm1lbnR9IGZyb20gXCIuLi9lbnZpcm9ubWVudC9lbnZpcm9ubWVudFwiO1xuaW1wb3J0IHtGaWxlSm9ifSBmcm9tIFwiLi9maWxlSm9iXCI7XG5pbXBvcnQge0pvYn0gZnJvbSBcIi4vam9iXCI7XG5pbXBvcnQge0ZvbGRlckpvYn0gZnJvbSBcIi4vZm9sZGVySm9iXCI7XG5cbmNvbnN0ICAgdG1wID0gcmVxdWlyZShcInRtcFwiKSxcbiAgICAgICAgZnMgPSByZXF1aXJlKFwiZnNcIiksXG4gICAgICAgIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKSxcbiAgICAgICAgSlNaaXAgPSByZXF1aXJlKFwianN6aXBcIiksXG4gICAgICAgIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpLFxuICAgICAgICBSZWZsZWN0ID0gcmVxdWlyZShcInJlZmxlY3QtbWV0YWRhdGFcIik7XG5cbmV4cG9ydCBjbGFzcyBQYWNrZWRKb2IgZXh0ZW5kcyBGaWxlSm9iIHtcblxuICAgIHByb3RlY3RlZCBlOiBFbnZpcm9ubWVudDtcbiAgICBwcm90ZWN0ZWQgam9iOiBKb2I7XG5cbiAgICBjb25zdHJ1Y3RvcihlOiBFbnZpcm9ubWVudCwgam9iOiBKb2IpIHtcbiAgICAgICAgLy8gbGV0IGpvYl9uYW1lID0gam9iLmdldE5hbWUoKTtcbiAgICAgICAgc3VwZXIoZSwgam9iLmdldE5hbWUoKSk7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIHBqLmUgPSBlO1xuICAgICAgICBwai5qb2IgPSBqb2I7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7Sm9ifVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRKb2IoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmpvYjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYWtlcyBqb2IgdGlja2V0IGFuZCByZXR1cm5zIHRoZSBwYXRoIHRvIHRoZSB0ZW1wb3JhcnkgZmlsZS5cbiAgICAgKiBAcGFyYW0gam9iXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZ2V0Sm9iVGlja2V0KGpvYjogSm9iKSB7XG4gICAgICAgIGxldCBwaiA9IHRoaXM7XG4gICAgICAgIC8vIE1ha2Ugam9iIHRpY2tldFxuICAgICAgICBsZXQganNvbiA9IGpvYi5nZXRKU09OKCk7XG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgZGlyID0gdG1wb2JqLm5hbWU7XG4gICAgICAgIGxldCBmaWxlX25hbWUgPSBkaXIgKyBwYXRoLnNlcCArIFwidGlja2V0Lmpzb25cIjtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlX25hbWUsIGpzb24sIFwidXRmOFwiKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBwai5lLmxvZygzLCBgRXJyb3Igd3JpdGluZyBqb2IgdGlja2V0IHRvIHRlbXBvcmFyeSBmaWxlYCwgcGopO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWxlX25hbWU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGJ1aWxkWmlwKHppcDogYW55LCBjYWxsYmFjaykge1xuICAgICAgICAvLyBTYXZlIG91dCB6aXBcbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHRoaXMuZ2V0Sm9iKCk7XG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgZGlyID0gdG1wb2JqLm5hbWU7XG4gICAgICAgIGxldCBmaWxlX25hbWUgPSBqb2IuZ2V0TmFtZSgpICsgXCIuYW50cGFjay56aXBcIjtcbiAgICAgICAgbGV0IGZpbGVfcGF0aCA9IGRpciArIHBhdGguc2VwICsgZmlsZV9uYW1lO1xuICAgICAgICB6aXBcbiAgICAgICAgICAgIC5nZW5lcmF0ZU5vZGVTdHJlYW0oe3R5cGU6IFwibm9kZWJ1ZmZlclwiLCBzdHJlYW1GaWxlczogdHJ1ZX0pXG4gICAgICAgICAgICAucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlX3BhdGgpKVxuICAgICAgICAgICAgLm9uKFwiZmluaXNoXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBKU1ppcCBnZW5lcmF0ZXMgYSByZWFkYWJsZSBzdHJlYW0gd2l0aCBhIFwiZW5kXCIgZXZlbnQsXG4gICAgICAgICAgICAgICAgLy8gYnV0IGlzIHBpcGVkIGhlcmUgaW4gYSB3cml0YWJsZSBzdHJlYW0gd2hpY2ggZW1pdHMgYSBcImZpbmlzaFwiIGV2ZW50LlxuICAgICAgICAgICAgICAgIHBqLnNldFBhdGgoZmlsZV9wYXRoKTtcbiAgICAgICAgICAgICAgICBwai5zZXROYW1lKGZpbGVfbmFtZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBhY2tzIHRoZSByZWxhdGVkIGpvYiBvbiBjb25zdHJ1Y3Rpb24uXG4gICAgICovXG4gICAgcHVibGljIHBhY2soZG9uZSkge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iID0gcGouZ2V0Sm9iKCk7XG5cbiAgICAgICAgbGV0IHRpY2tldFBhdGggPSBwai5nZXRKb2JUaWNrZXQoam9iKTtcblxuICAgICAgICBsZXQgemlwID0gbmV3IEpTWmlwKCk7XG5cbiAgICAgICAgLy8gQWRkIHRpY2tldCB0byB6aXBcbiAgICAgICAgZnMucmVhZEZpbGUodGlja2V0UGF0aCwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG4gICAgICAgICAgICB6aXAuZmlsZShcIl90aWNrZXQvdGlja2V0Lmpzb25cIiwgZGF0YSk7XG5cbiAgICAgICAgICAgIGlmIChqb2IuaXNGaWxlKCkpIHtcblxuICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlKGpvYi5nZXRQYXRoKCksIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICAgICAgICB6aXAuZmlsZShcIl9hc3NldC9cIiArIGpvYi5nZXROYW1lKCksIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICAgICAgam9iLmdldEZpbGVzKCkuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZnMucmVhZEZpbGUoZmlsZS5nZXRQYXRoKCksIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICAgICAgICAgICAgemlwLmZpbGUoXCJfYXNzZXRcIiArIHBhdGguc2VwICsgam9iLmdldE5hbWVQcm9wZXIoKSArIHBhdGguc2VwICsgZmlsZS5nZXROYW1lKCksIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGouYnVpbGRaaXAoemlwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwai5idWlsZFppcCh6aXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlc3RvcmVKb2JUaWNrZXQoanNvblRpY2tldCkge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuICAgICAgICBsZXQgam9iT2JqZWN0LCBqb2I7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBqb2JPYmplY3QgPSBKU09OLnBhcnNlKGpzb25UaWNrZXQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJqb2IgdHlwZSA9PlwiLCBqb2JPYmplY3QudHlwZSwgdHlwZW9mIGpvYk9iamVjdCk7XG5cbiAgICAgICAgICAgIGlmIChqb2JPYmplY3QudHlwZSA9PT0gXCJmaWxlXCIpIHtcbiAgICAgICAgICAgICAgICBqb2IgPSBuZXcgRmlsZUpvYihwai5lLCBqb2JPYmplY3QuYmFzZW5hbWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2JPYmplY3QudHlwZSA9PT0gXCJmb2xkZXJcIikge1xuICAgICAgICAgICAgICAgIGpvYiA9IG5ldyBGb2xkZXJKb2IocGouZSwgam9iT2JqZWN0LmJhc2VuYW1lKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGouZS5sb2coMywgYENhbm5vdCB1bnBhY2sgdGhpcyB0eXBlIG9mIGpvYjogJHtqb2JPYmplY3QudHlwZX1gLCBwaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcGouZS5sb2coMywgYFVucGFjayB0aWNrZXQgcGFyc2UgZXJyb3I6ICR7ZXJyfS5gLCBwaik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZXN0b3JlIHByb3BlcnR5IHZhbHVlc1xuICAgICAgICBqb2Iuc2V0UHJvcGVydHlWYWx1ZXMoam9iT2JqZWN0LnByb3BlcnRpZXMpO1xuXG4gICAgICAgIC8vIFJlc3RvcmUgbGlmZWN5Y2xlXG4gICAgICAgIGpvYi5zZXRMaWZlQ3ljbGUoam9iT2JqZWN0LmxpZmVDeWNsZSk7XG5cbiAgICAgICAgcmV0dXJuIGpvYjtcbiAgICB9XG5cbiAgICBwdWJsaWMgdW5wYWNrKGRvbmUpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJ1bnBhY2tpbmdcIik7XG5cbiAgICAgICAgbGV0IHBqID0gdGhpcztcbiAgICAgICAgbGV0IGpvYiA9IHBqLmdldEpvYigpO1xuXG4gICAgICAgIC8vIFJlYWQgdGhlIHppcCB0byBhIGJ1ZmZlclxuICAgICAgICBmcy5yZWFkRmlsZShqb2IuZ2V0UGF0aCgpLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgcGouZS5sb2coMywgYFVucGFja2luZyByZWFkRmlsZSBlcnJvcjogJHtlcnJ9YCwgcGopO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gT3BlbiB0aGUgemlwIGluIEpTWmlwXG4gICAgICAgICAgICBKU1ppcC5sb2FkQXN5bmMoZGF0YSkudGhlbigoemlwKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBqb2IgdGlja2V0IGFuZCBjcmVhdGUgam9iXG4gICAgICAgICAgICAgICAgemlwLmZvbGRlcihcIl90aWNrZXRcIikuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBmaWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHppcC5maWxlKGBfdGlja2V0JHtwYXRoLnNlcH0ke3JlbGF0aXZlUGF0aH1gKS5hc3luYyhcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG9sZCBqb2IgdGlja2V0XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2IgPSBwai5yZXN0b3JlSm9iVGlja2V0KGNvbnRlbnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIGZpbGVzXG4gICAgICAgICAgICAgICAgICAgICAgICBwai5yZXN0b3JlRmlsZXMoam9iLCB6aXAsIChqb2IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lKGpvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVzdG9yZUZpbGVzKGpvYjogSm9iLCB6aXA6IGFueSwgY2FsbGJhY2spIHtcblxuICAgICAgICBsZXQgcGogPSB0aGlzO1xuXG5cbiAgICAgICAgLy8gQ2hlY2sgZm9yIHZhbGlkIHBhY2sgZm9ybWF0XG4gICAgICAgIGlmICh6aXAuZm9sZGVyKFwiX2Fzc2V0XCIpLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHBqLmUubG9nKDIsIGBSZXN0b3JlZCBqb2IgZGlkIG5vdCBjb250YWluIGFueSBmaWxlIGFzc2V0cy5gLCBwaiwgW2pvYl0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGpvYi5pc0ZvbGRlcigpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInJ1bm5pbmcgZm9sZGVyXCIpO1xuICAgICAgICAgICAgcGouZXh0cmFjdEZpbGVzKHppcCwgZmFsc2UsIFwiX2Fzc2V0L1wiLCAoZmlsZVBhdGgsIGZvbGRlck5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBqb2Iuc2V0UGF0aChmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgam9iLnJlbmFtZShmb2xkZXJOYW1lKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhqb2IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoam9iLmlzRmlsZSgpKSB7XG4gICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCB0cnVlLCBcIl9hc3NldC9cIiwgKGZpbGVQYXRoLCBmaWxlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIGpvYi5zZXRQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgICBqb2IucmVuYW1lKGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhqb2IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZXh0cmFjdEZpbGVzKHppcDogYW55LCBzaW5nbGU6IGJvb2xlYW4sIHppcFBhdGg6IHN0cmluZywgY2FsbGJhY2s6IGFueSwgdG90YWxGaWxlcz86IG51bWJlcikge1xuICAgICAgICBsZXQgcGogPSB0aGlzO1xuXG4gICAgICAgIGxldCB0bXBvYmogPSB0bXAuZGlyU3luYygpO1xuICAgICAgICBsZXQgdGVtcFBhdGggPSB0bXBvYmoubmFtZTtcblxuICAgICAgICBsZXQgZmlsZU51bWJlciA9IDE7XG5cbiAgICAgICAgY29uc29sZS5sb2coXCJvcmlnaW5hbCB0b3RhbEZpbGVzXCIsIHRvdGFsRmlsZXMpO1xuXG4gICAgICAgIGlmICghdG90YWxGaWxlcykge1xuICAgICAgICAgICAgdG90YWxGaWxlcyA9IDA7XG4gICAgICAgICAgICB6aXAuZm9sZGVyKHppcFBhdGgpLmZvckVhY2goKGFzc2V0KSA9PiB0b3RhbEZpbGVzKysgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidG90YWxGaWxlc1wiICsgdG90YWxGaWxlcyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2luZ2xlID09PSB0cnVlKSB7XG5cbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGVOdW1iZXIgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHBqLmUubG9nKDMsIGBNb3JlIHRoYW4gMSBmaWxlcyBmb3VuZCB3aGVuIGV4dHJhY3RpbmcgYSBmaWxlIGpvYi5gLCBwaik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld1JlbFBhdGggPSB6aXBQYXRoICsgcGF0aC5zZXAgKyByZWxhdGl2ZVBhdGg7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsRmlsZXMtLTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBqLmV4dHJhY3RGaWxlcyh6aXAsIHNpbmdsZSwgbmV3UmVsUGF0aCwgY2FsbGJhY2ssIHRvdGFsRmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFWFRSQUNUSU5HIFNJTkdMRVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHppcC5maWxlKG5ld1JlbFBhdGgpLmFzeW5jKFwibm9kZWJ1ZmZlclwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChjb250ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVOdW1iZXIrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gdGVtcFBhdGggKyBwYXRoLnNlcCArIHJlbGF0aXZlUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZpbGVQYXRoLCByZWxhdGl2ZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRXh0cmFjdGluZyBmb2xkZXJcIik7XG5cbiAgICAgICAgICAgIHppcC5mb2xkZXIoemlwUGF0aCkuZm9yRWFjaCgocmVsYXRpdmVQYXRoLCBhc3NldCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBuZXdSZWxQYXRoID0gemlwUGF0aCArIHJlbGF0aXZlUGF0aDtcblxuXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0LmRpciA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbEZpbGVzLS07XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJkaXIgZm91bmRcIiwgdG90YWxGaWxlcyk7XG5cblxuICAgICAgICAgICAgICAgICAgICBwai5leHRyYWN0RmlsZXMoemlwLCBzaW5nbGUsIG5ld1JlbFBhdGgsIGNhbGxiYWNrLCB0b3RhbEZpbGVzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgIHppcC5maWxlKG5ld1JlbFBhdGgpLmFzeW5jKFwibm9kZWJ1ZmZlclwiKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoY29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFWFRSQUNUSU5HIFNJTkdMRSBGUk9NIEZPTERFUlwiLCB0b3RhbEZpbGVzLCBmaWxlTnVtYmVyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cobmV3UmVsUGF0aCwgcmVsYXRpdmVQYXRoLCB0eXBlb2YgYXNzZXQuZGlyKTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlTnVtYmVyKys7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZVBhdGggPSB0ZW1wUGF0aCArIHBhdGguc2VwICsgcmVsYXRpdmVQYXRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3RhbEZpbGVzID09PSBmaWxlTnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJyZWxhdGl2ZVBhdGguc3BsaXQocGF0aC5zZXApXCIsIHJlbGF0aXZlUGF0aC5zcGxpdChwYXRoLnNlcCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRlbXBQYXRoLCBuZXdSZWxQYXRoLnNwbGl0KHBhdGguc2VwKVsxXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG59Il19
