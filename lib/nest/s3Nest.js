"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var nest_1 = require("./nest");
var s3FileJob_1 = require("../job/s3FileJob");
var AWS = require("aws-sdk"), _ = require("lodash"), async = require("async"), fs = require("fs");
var S3Nest = (function (_super) {
    __extends(S3Nest, _super);
    /**
     * Constructor
     * @param e
     * @param bucket            AWS S3 bucket to watch.
     * @param keyPrefix         Optional key prefix (sub-directory) to watch.
     * @param checkEvery        Frequency of bucket checking, in minutes.
     * @param allowCreation     Create the bucket:prefix if it does not exist.
     */
    function S3Nest(e, bucket, keyPrefix, checkEvery, allowCreation) {
        if (checkEvery === void 0) { checkEvery = 5; }
        if (allowCreation === void 0) { allowCreation = false; }
        _super.call(this, e, "An S3 bucket");
        var sn = this;
        sn.s3 = new AWS.S3();
        sn.bucket = bucket;
        sn.keyPrefix = keyPrefix;
        sn.checkEvery = checkEvery;
        sn.checkEveryMs = checkEvery * 60000;
        sn.allowCreation = allowCreation;
        sn.verifyBucket();
    }
    /**
     * Set hard-coded AWS credentials.
     * @param accessKeyId
     * @param secretAccessKey
     */
    S3Nest.prototype.setCredentials = function (accessKeyId, secretAccessKey) {
        AWS.config.update({ accessKeyId: accessKeyId, secretAccessKey: secretAccessKey });
    };
    /**
     * Verify bucket and handle creation of bucket if need be.
     */
    S3Nest.prototype.verifyBucket = function () {
        var sn = this;
        sn.headBucket(function (headSuccess) {
            if (!headSuccess) {
                if (sn.allowCreation) {
                    sn.createBucket(function (createSuccess) {
                        if (!createSuccess) {
                            sn.e.log(3, "Bucket \"" + sn.bucket + "\" could not be created.", sn);
                        }
                    });
                }
                else {
                    sn.e.log(3, "Bucket \"" + sn.bucket + "\" does not exist and allowCreation is set to false.", sn);
                }
            }
        });
    };
    /**
     * Verify that the bucket is available and exists
     * @param callback
     */
    S3Nest.prototype.headBucket = function (callback) {
        var sn = this;
        var params = { Bucket: sn.bucket };
        sn.s3.headBucket(params, function (err, data) {
            if (err) {
                sn.e.log(2, "headBucket error: " + err, sn);
                callback(false);
            }
            else {
                // if (_.isEmpty(data)) {
                //     sn.e.log(2, `headBucket empty response`, sn);
                //     callback(true);
                // } else {
                //     sn.e.log(0, `headBucket success: ${data}`, sn);
                //     console.log(data);
                //     callback(true);
                // }
                sn.e.log(0, "Bucket \"" + sn.bucket + "\" is available.", sn);
                callback(true);
            }
        });
    };
    S3Nest.prototype.createBucket = function (callback) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
        };
        sn.s3.createBucket(params, function (err, data) {
            if (err) {
                sn.e.log(3, "createBucket error: " + err, sn);
                callback(false);
            }
            else {
                if (_.isEmpty(data)) {
                    sn.e.log(2, "createBucket empty response", sn);
                    callback(false);
                }
                else {
                    sn.e.log(0, "createBucket success: " + data, sn);
                    callback(true);
                }
            }
        });
    };
    S3Nest.prototype.load = function () {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            // ContinuationToken: 'STRING_VALUE',
            // Delimiter: 'STRING_VALUE',
            // EncodingType: 'url',
            // FetchOwner: true || false,
            // MaxKeys: 0,
            Prefix: sn.keyPrefix
        };
        sn.s3.listObjectsV2(params, function (err, data) {
            if (err) {
                sn.e.log(3, "listObjectsV2: " + err, sn);
            }
            else {
                var contents_1 = data.Contents;
                // Download each file found
                if (contents_1.length > 0) {
                    sn.e.log(0, "Found " + contents_1.length + " objects in \"" + sn.bucket + "/" + sn.keyPrefix + "\".", sn);
                    async.eachSeries(contents_1, function (object, done) {
                        // Create temp file
                        sn.e.log(1, "S3 found file \"" + object.Key + "\".", sn);
                        var job = new s3FileJob_1.S3FileJob(sn.e, object.Key);
                        // Download and pipe to file
                        var params = { Bucket: sn.bucket, Key: object.Key };
                        var file = require("fs").createWriteStream(job.getPath());
                        sn.s3.getObject(params).createReadStream().pipe(file);
                        sn.e.log(1, "Downloading \"" + object.Key + "\".", sn);
                        file.on("close", function () {
                            // Delete object
                            sn.deleteObject(object.Key);
                            sn.arrive(job);
                            done();
                        });
                    }, function (err) {
                        if (err) {
                            sn.e.log(3, "Async series download error: \"" + err + "\".", sn);
                        }
                        sn.e.log(0, "Completed " + contents_1.length + " synchronous download(s).", sn);
                    });
                }
            }
        });
    };
    /**
     * Removes an object from an S3 bucket.
     * @param key
     */
    S3Nest.prototype.deleteObject = function (key) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            Key: key /* required */
        };
        sn.s3.deleteObject(params, function (err) {
            if (err) {
                sn.e.log(3, "S3 delete object error " + err, sn);
            }
        });
    };
    /**
     * Watch an S3 bucket.
     */
    S3Nest.prototype.watch = function () {
        var sn = this;
        if (sn.checkEvery === 0) {
            sn.e.log(3, "Cannot watch this bucket. Check every (minutes) set to 0.", sn);
        }
        else {
            sn.e.log(1, "Watching S3 bucket.", sn);
            var count_1 = 0;
            setInterval(function () {
                count_1++;
                sn.e.log(1, "Re-checking S3 bucket, attempt " + count_1 + ".", sn);
                sn.load();
            }, sn.checkEveryMs, count_1);
        }
    };
    /**
     * Nest arrival
     * @param job
     */
    S3Nest.prototype.arrive = function (job) {
        _super.prototype.arrive.call(this, job);
    };
    /**
     * Upload a file to an S3 bucket.
     */
    S3Nest.prototype.take = function (job, callback) {
        var sn = this;
        try {
            sn.uploadFile(job, function (s3Job) {
                callback(s3Job);
            });
        }
        catch (e) {
            sn.e.log(3, "Take upload error, " + e, sn);
        }
    };
    /**
     * Calculate the percent remaining from the httpUploadProgress event values.
     * @param total
     * @param loaded
     * @param part
     * @returns {number}
     */
    S3Nest.prototype.calculateRemaining = function (total, loaded, part) {
        var sn = this;
        if (!isNaN(total) && !isNaN(loaded)) {
            var percentRemaining = Math.round((loaded / total) * 100);
            if (isNaN(percentRemaining) || percentRemaining > 100) {
                sn.e.log(3, "Error calculating percent remaining: " + percentRemaining + " (" + typeof percentRemaining + "), total: " + total + ", loaded: " + loaded + ".", sn);
                return 0;
            }
            else {
                return percentRemaining;
            }
        }
        else {
            return 0;
        }
    };
    /**
     * Upload file to S3
     * @param job {FileJob}     FileJob to be uploaded.
     * @param callback          Callback includes the S3FileJob parameter.
     */
    S3Nest.prototype.uploadFile = function (job, callback) {
        var sn = this;
        var body = fs.createReadStream(job.getPath());
        var params = {
            Bucket: sn.bucket,
            Key: sn.keyPrefix + job.name,
            Body: body,
            ACL: "public-read"
        };
        var percentUploaded = 0;
        sn.s3.upload(params).
            on("httpUploadProgress", function (evt) {
            // console.log("evt", evt);
            percentUploaded = sn.calculateRemaining(evt.total, evt.loaded, evt.part);
            sn.e.log(0, "Uploading \"" + evt.key + "\" - " + percentUploaded + "%", sn);
        }).
            send(function (err, data) {
            if (err) {
                sn.e.log(3, "S3 upload error: " + err, sn);
            }
            // Change job type to a S3FileJob
            var s3Job = job;
            s3Job.setLocallyAvailable(false);
            s3Job.setPath(data.Location);
            s3Job.bucket = data.Bucket;
            s3Job.key = data.Key;
            s3Job.eTag = data.ETag;
            callback(s3Job);
        });
    };
    return S3Nest;
}(nest_1.Nest));
exports.S3Nest = S3Nest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxpQkFBYyxHQUFHLENBQUMsR0FBRyxhQUFPLGVBQWUsTUFBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQztZQUNGLElBQUksQ0FBQyxVQUFTLEdBQUcsRUFBRSxJQUFJO1lBQ25CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ04sRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLHNCQUFvQixHQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0MsQ0FBQztZQUVELGlDQUFpQztZQUNqQyxJQUFJLEtBQUssR0FBRyxHQUFnQixDQUFDO1lBQzdCLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3QixLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDM0IsS0FBSyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ3JCLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztZQUV2QixRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUwsYUFBQztBQUFELENBalRBLEFBaVRDLENBalQyQixXQUFJLEdBaVQvQjtBQWpUWSxjQUFNLFNBaVRsQixDQUFBIiwiZmlsZSI6ImxpYi9uZXN0L3MzTmVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5lc3QgfSBmcm9tIFwiLi9uZXN0XCI7XG5pbXBvcnQgeyBGaWxlSm9iIH0gZnJvbSBcIi4vLi4vam9iL2ZpbGVKb2JcIjtcbmltcG9ydCB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uL2Vudmlyb25tZW50L2Vudmlyb25tZW50XCI7XG5pbXBvcnQge1MzRmlsZUpvYn0gZnJvbSBcIi4uL2pvYi9zM0ZpbGVKb2JcIjtcblxuY29uc3QgICBBV1MgPSByZXF1aXJlKFwiYXdzLXNka1wiKSxcbiAgICAgICAgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIiksXG4gICAgICAgIGFzeW5jID0gcmVxdWlyZShcImFzeW5jXCIpLFxuICAgICAgICBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcblxuZXhwb3J0IGNsYXNzIFMzTmVzdCBleHRlbmRzIE5lc3Qge1xuXG4gICAgcHJvdGVjdGVkIGNsaWVudDogYW55O1xuICAgIHByb3RlY3RlZCBzMzogYW55O1xuICAgIHByb3RlY3RlZCBidWNrZXQ6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQga2V5UHJlZml4OiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIGNoZWNrRXZlcnk6IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgY2hlY2tFdmVyeU1zOiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIGFsbG93Q3JlYXRpb246IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBDb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSBlXG4gICAgICogQHBhcmFtIGJ1Y2tldCAgICAgICAgICAgIEFXUyBTMyBidWNrZXQgdG8gd2F0Y2guXG4gICAgICogQHBhcmFtIGtleVByZWZpeCAgICAgICAgIE9wdGlvbmFsIGtleSBwcmVmaXggKHN1Yi1kaXJlY3RvcnkpIHRvIHdhdGNoLlxuICAgICAqIEBwYXJhbSBjaGVja0V2ZXJ5ICAgICAgICBGcmVxdWVuY3kgb2YgYnVja2V0IGNoZWNraW5nLCBpbiBtaW51dGVzLlxuICAgICAqIEBwYXJhbSBhbGxvd0NyZWF0aW9uICAgICBDcmVhdGUgdGhlIGJ1Y2tldDpwcmVmaXggaWYgaXQgZG9lcyBub3QgZXhpc3QuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGU6IEVudmlyb25tZW50LCBidWNrZXQ6IHN0cmluZywga2V5UHJlZml4Pzogc3RyaW5nLCBjaGVja0V2ZXJ5OiBudW1iZXIgPSA1LCBhbGxvd0NyZWF0aW9uOiBib29sZWFuID0gZmFsc2VcbiAgICApIHtcbiAgICAgICAgc3VwZXIoZSwgXCJBbiBTMyBidWNrZXRcIik7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG4gICAgICAgIHNuLnMzID0gbmV3IEFXUy5TMygpO1xuXG4gICAgICAgIHNuLmJ1Y2tldCA9IGJ1Y2tldDtcbiAgICAgICAgc24ua2V5UHJlZml4ID0ga2V5UHJlZml4O1xuICAgICAgICBzbi5jaGVja0V2ZXJ5ID0gY2hlY2tFdmVyeTtcbiAgICAgICAgc24uY2hlY2tFdmVyeU1zID0gY2hlY2tFdmVyeSAqIDYwMDAwO1xuICAgICAgICBzbi5hbGxvd0NyZWF0aW9uID0gYWxsb3dDcmVhdGlvbjtcblxuICAgICAgICBzbi52ZXJpZnlCdWNrZXQoKTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIFNldCBoYXJkLWNvZGVkIEFXUyBjcmVkZW50aWFscy5cbiAgICAgKiBAcGFyYW0gYWNjZXNzS2V5SWRcbiAgICAgKiBAcGFyYW0gc2VjcmV0QWNjZXNzS2V5XG4gICAgICovXG4gICAgcHVibGljIHNldENyZWRlbnRpYWxzKGFjY2Vzc0tleUlkOiBzdHJpbmcsIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nKSB7XG4gICAgICAgIEFXUy5jb25maWcudXBkYXRlKHthY2Nlc3NLZXlJZDogYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleTogc2VjcmV0QWNjZXNzS2V5fSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmVyaWZ5IGJ1Y2tldCBhbmQgaGFuZGxlIGNyZWF0aW9uIG9mIGJ1Y2tldCBpZiBuZWVkIGJlLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCB2ZXJpZnlCdWNrZXQoKSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG4gICAgICAgIHNuLmhlYWRCdWNrZXQoaGVhZFN1Y2Nlc3MgPT4ge1xuICAgICAgICAgICAgaWYgKCFoZWFkU3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGlmIChzbi5hbGxvd0NyZWF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHNuLmNyZWF0ZUJ1Y2tldChjcmVhdGVTdWNjZXNzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY3JlYXRlU3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBCdWNrZXQgXCIke3NuLmJ1Y2tldH1cIiBjb3VsZCBub3QgYmUgY3JlYXRlZC5gLCBzbik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBCdWNrZXQgXCIke3NuLmJ1Y2tldH1cIiBkb2VzIG5vdCBleGlzdCBhbmQgYWxsb3dDcmVhdGlvbiBpcyBzZXQgdG8gZmFsc2UuYCwgc24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmVyaWZ5IHRoYXQgdGhlIGJ1Y2tldCBpcyBhdmFpbGFibGUgYW5kIGV4aXN0c1xuICAgICAqIEBwYXJhbSBjYWxsYmFja1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBoZWFkQnVja2V0KGNhbGxiYWNrKSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHBhcmFtcyA9IHsgQnVja2V0OiBzbi5idWNrZXQgfTtcblxuICAgICAgICBzbi5zMy5oZWFkQnVja2V0KHBhcmFtcywgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDIsIGBoZWFkQnVja2V0IGVycm9yOiAke2Vycn1gLCBzbik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBpZiAoXy5pc0VtcHR5KGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgLy8gICAgIHNuLmUubG9nKDIsIGBoZWFkQnVja2V0IGVtcHR5IHJlc3BvbnNlYCwgc24pO1xuICAgICAgICAgICAgICAgIC8vICAgICBjYWxsYmFjayh0cnVlKTtcbiAgICAgICAgICAgICAgICAvLyB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vICAgICBzbi5lLmxvZygwLCBgaGVhZEJ1Y2tldCBzdWNjZXNzOiAke2RhdGF9YCwgc24pO1xuICAgICAgICAgICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAvLyAgICAgY2FsbGJhY2sodHJ1ZSk7XG4gICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIHNuLmUubG9nKDAsIGBCdWNrZXQgXCIke3NuLmJ1Y2tldH1cIiBpcyBhdmFpbGFibGUuYCwgc24pO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlQnVja2V0KGNhbGxiYWNrKSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHBhcmFtcyA9IHtcbiAgICAgICAgICAgIEJ1Y2tldDogc24uYnVja2V0LCAvKiByZXF1aXJlZCAqL1xuICAgICAgICAgICAgLy8gQUNMOiAncHJpdmF0ZSB8IHB1YmxpYy1yZWFkIHwgcHVibGljLXJlYWQtd3JpdGUgfCBhdXRoZW50aWNhdGVkLXJlYWQnLFxuICAgICAgICAgICAgLy8gQ3JlYXRlQnVja2V0Q29uZmlndXJhdGlvbjoge1xuICAgICAgICAgICAgLy8gICAgIExvY2F0aW9uQ29uc3RyYWludDogJ0VVIHwgZXUtd2VzdC0xIHwgdXMtd2VzdC0xIHwgdXMtd2VzdC0yIHwgYXAtc291dGgtMSB8IGFwLXNvdXRoZWFzdC0xIHwgYXAtc291dGhlYXN0LTIgfCBhcC1ub3J0aGVhc3QtMSB8IHNhLWVhc3QtMSB8IGNuLW5vcnRoLTEgfCBldS1jZW50cmFsLTEnXG4gICAgICAgICAgICAvLyB9LFxuICAgICAgICAgICAgLy8gR3JhbnRGdWxsQ29udHJvbDogJ1NUUklOR19WQUxVRScsXG4gICAgICAgICAgICAvLyBHcmFudFJlYWQ6ICdTVFJJTkdfVkFMVUUnLFxuICAgICAgICAgICAgLy8gR3JhbnRSZWFkQUNQOiAnU1RSSU5HX1ZBTFVFJyxcbiAgICAgICAgICAgIC8vIEdyYW50V3JpdGU6ICdTVFJJTkdfVkFMVUUnLFxuICAgICAgICAgICAgLy8gR3JhbnRXcml0ZUFDUDogJ1NUUklOR19WQUxVRSdcbiAgICAgICAgfTtcbiAgICAgICAgc24uczMuY3JlYXRlQnVja2V0KHBhcmFtcywgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgc24uZS5sb2coMywgYGNyZWF0ZUJ1Y2tldCBlcnJvcjogJHtlcnJ9YCwgc24pO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNFbXB0eShkYXRhKSkge1xuICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygyLCBgY3JlYXRlQnVja2V0IGVtcHR5IHJlc3BvbnNlYCwgc24pO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMCwgYGNyZWF0ZUJ1Y2tldCBzdWNjZXNzOiAke2RhdGF9YCwgc24pO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGxvYWQoKSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHBhcmFtcyA9IHtcbiAgICAgICAgICAgIEJ1Y2tldDogc24uYnVja2V0LCAvKiByZXF1aXJlZCAqL1xuICAgICAgICAgICAgLy8gQ29udGludWF0aW9uVG9rZW46ICdTVFJJTkdfVkFMVUUnLFxuICAgICAgICAgICAgLy8gRGVsaW1pdGVyOiAnU1RSSU5HX1ZBTFVFJyxcbiAgICAgICAgICAgIC8vIEVuY29kaW5nVHlwZTogJ3VybCcsXG4gICAgICAgICAgICAvLyBGZXRjaE93bmVyOiB0cnVlIHx8IGZhbHNlLFxuICAgICAgICAgICAgLy8gTWF4S2V5czogMCxcbiAgICAgICAgICAgIFByZWZpeDogc24ua2V5UHJlZml4XG4gICAgICAgIH07XG5cbiAgICAgICAgc24uczMubGlzdE9iamVjdHNWMihwYXJhbXMsIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgbGlzdE9iamVjdHNWMjogJHtlcnJ9YCwgc24pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgY29udGVudHMgPSBkYXRhLkNvbnRlbnRzO1xuXG4gICAgICAgICAgICAgICAgLy8gRG93bmxvYWQgZWFjaCBmaWxlIGZvdW5kXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMCwgYEZvdW5kICR7Y29udGVudHMubGVuZ3RofSBvYmplY3RzIGluIFwiJHtzbi5idWNrZXR9LyR7c24ua2V5UHJlZml4fVwiLmAsIHNuKTtcblxuICAgICAgICAgICAgICAgICAgICBhc3luYy5lYWNoU2VyaWVzKGNvbnRlbnRzLCAob2JqZWN0LCBkb25lKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0ZW1wIGZpbGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDEsIGBTMyBmb3VuZCBmaWxlIFwiJHtvYmplY3QuS2V5fVwiLmAsIHNuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBqb2IgPSBuZXcgUzNGaWxlSm9iKHNuLmUsIG9iamVjdC5LZXkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBEb3dubG9hZCBhbmQgcGlwZSB0byBmaWxlXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGFyYW1zID0ge0J1Y2tldDogc24uYnVja2V0LCBLZXk6IG9iamVjdC5LZXl9O1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGUgPSByZXF1aXJlKFwiZnNcIikuY3JlYXRlV3JpdGVTdHJlYW0oam9iLmdldFBhdGgoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbi5zMy5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShmaWxlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMSwgYERvd25sb2FkaW5nIFwiJHtvYmplY3QuS2V5fVwiLmAsIHNuKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS5vbihcImNsb3NlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGUgb2JqZWN0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uZGVsZXRlT2JqZWN0KG9iamVjdC5LZXkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uYXJyaXZlKGpvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICAgICAgICAgICAgICB9LCBlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBBc3luYyBzZXJpZXMgZG93bmxvYWQgZXJyb3I6IFwiJHtlcnJ9XCIuYCwgc24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMCwgYENvbXBsZXRlZCAke2NvbnRlbnRzLmxlbmd0aH0gc3luY2hyb25vdXMgZG93bmxvYWQocykuYCwgc24pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgYW4gb2JqZWN0IGZyb20gYW4gUzMgYnVja2V0LlxuICAgICAqIEBwYXJhbSBrZXlcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZGVsZXRlT2JqZWN0KGtleSkge1xuICAgICAgICBsZXQgc24gPSB0aGlzO1xuICAgICAgICBsZXQgcGFyYW1zID0ge1xuICAgICAgICAgICAgQnVja2V0OiBzbi5idWNrZXQsIC8qIHJlcXVpcmVkICovXG4gICAgICAgICAgICBLZXk6IGtleSAvKiByZXF1aXJlZCAqL1xuICAgICAgICB9O1xuICAgICAgICBzbi5zMy5kZWxldGVPYmplY3QocGFyYW1zLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgUzMgZGVsZXRlIG9iamVjdCBlcnJvciAke2Vycn1gLCBzbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogV2F0Y2ggYW4gUzMgYnVja2V0LlxuICAgICAqL1xuICAgIHB1YmxpYyB3YXRjaCgpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcblxuICAgICAgICBpZiAoc24uY2hlY2tFdmVyeSA9PT0gMCkge1xuICAgICAgICAgICAgc24uZS5sb2coMywgXCJDYW5ub3Qgd2F0Y2ggdGhpcyBidWNrZXQuIENoZWNrIGV2ZXJ5IChtaW51dGVzKSBzZXQgdG8gMC5cIiwgc24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc24uZS5sb2coMSwgXCJXYXRjaGluZyBTMyBidWNrZXQuXCIsIHNuKTtcblxuICAgICAgICAgICAgbGV0IGNvdW50ID0gMDtcblxuICAgICAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygxLCBgUmUtY2hlY2tpbmcgUzMgYnVja2V0LCBhdHRlbXB0ICR7Y291bnR9LmAsIHNuKTtcbiAgICAgICAgICAgICAgICBzbi5sb2FkKCk7XG4gICAgICAgICAgICB9LCBzbi5jaGVja0V2ZXJ5TXMsIGNvdW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE5lc3QgYXJyaXZhbFxuICAgICAqIEBwYXJhbSBqb2JcbiAgICAgKi9cbiAgICBwdWJsaWMgYXJyaXZlKGpvYjogRmlsZUpvYikge1xuICAgICAgICBzdXBlci5hcnJpdmUoam9iKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGxvYWQgYSBmaWxlIHRvIGFuIFMzIGJ1Y2tldC5cbiAgICAgKi9cbiAgICBwdWJsaWMgdGFrZShqb2I6IEZpbGVKb2IsIGNhbGxiYWNrPzogYW55KSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgc24udXBsb2FkRmlsZShqb2IsIChzM0pvYjogUzNGaWxlSm9iKSA9PiB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soczNKb2IpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgc24uZS5sb2coMywgXCJUYWtlIHVwbG9hZCBlcnJvciwgXCIgKyBlLCBzbik7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSB0aGUgcGVyY2VudCByZW1haW5pbmcgZnJvbSB0aGUgaHR0cFVwbG9hZFByb2dyZXNzIGV2ZW50IHZhbHVlcy5cbiAgICAgKiBAcGFyYW0gdG90YWxcbiAgICAgKiBAcGFyYW0gbG9hZGVkXG4gICAgICogQHBhcmFtIHBhcnRcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICAgIHByaXZhdGUgY2FsY3VsYXRlUmVtYWluaW5nKHRvdGFsOiBudW1iZXIsIGxvYWRlZDogbnVtYmVyLCBwYXJ0PzogbnVtYmVyKSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG4gICAgICAgIGlmICghaXNOYU4odG90YWwpICYmICFpc05hTihsb2FkZWQpKSB7XG4gICAgICAgICAgICBsZXQgcGVyY2VudFJlbWFpbmluZyA9IE1hdGgucm91bmQoKCBsb2FkZWQgLyB0b3RhbCkgKiAxMDApO1xuICAgICAgICAgICAgaWYgKGlzTmFOKHBlcmNlbnRSZW1haW5pbmcpIHx8IHBlcmNlbnRSZW1haW5pbmcgPiAxMDApIHtcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgRXJyb3IgY2FsY3VsYXRpbmcgcGVyY2VudCByZW1haW5pbmc6ICR7cGVyY2VudFJlbWFpbmluZ30gKCR7dHlwZW9mIHBlcmNlbnRSZW1haW5pbmd9KSwgdG90YWw6ICR7dG90YWx9LCBsb2FkZWQ6ICR7bG9hZGVkfS5gLCBzbik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBwZXJjZW50UmVtYWluaW5nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGxvYWQgZmlsZSB0byBTM1xuICAgICAqIEBwYXJhbSBqb2Ige0ZpbGVKb2J9ICAgICBGaWxlSm9iIHRvIGJlIHVwbG9hZGVkLlxuICAgICAqIEBwYXJhbSBjYWxsYmFjayAgICAgICAgICBDYWxsYmFjayBpbmNsdWRlcyB0aGUgUzNGaWxlSm9iIHBhcmFtZXRlci5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgdXBsb2FkRmlsZShqb2I6IEZpbGVKb2IsIGNhbGxiYWNrOiBhbnkpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcbiAgICAgICAgbGV0IGJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGpvYi5nZXRQYXRoKCkpO1xuICAgICAgICBsZXQgcGFyYW1zID0ge1xuICAgICAgICAgICAgQnVja2V0OiBzbi5idWNrZXQsXG4gICAgICAgICAgICBLZXk6IHNuLmtleVByZWZpeCArIGpvYi5uYW1lLFxuICAgICAgICAgICAgQm9keTogYm9keSxcbiAgICAgICAgICAgIEFDTDogXCJwdWJsaWMtcmVhZFwiXG4gICAgICAgIH07XG4gICAgICAgIGxldCBwZXJjZW50VXBsb2FkZWQgPSAwO1xuICAgICAgICBzbi5zMy51cGxvYWQocGFyYW1zKS5cbiAgICAgICAgb24oXCJodHRwVXBsb2FkUHJvZ3Jlc3NcIiwgZnVuY3Rpb24oZXZ0KSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcImV2dFwiLCBldnQpO1xuICAgICAgICAgICAgcGVyY2VudFVwbG9hZGVkID0gc24uY2FsY3VsYXRlUmVtYWluaW5nKGV2dC50b3RhbCwgZXZ0LmxvYWRlZCwgZXZ0LnBhcnQpO1xuICAgICAgICAgICAgc24uZS5sb2coMCwgYFVwbG9hZGluZyBcIiR7ZXZ0LmtleX1cIiAtICR7cGVyY2VudFVwbG9hZGVkfSVgLCBzbik7XG4gICAgICAgIH0pLlxuICAgICAgICBzZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBTMyB1cGxvYWQgZXJyb3I6ICR7ZXJyfWAsIHNuKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQ2hhbmdlIGpvYiB0eXBlIHRvIGEgUzNGaWxlSm9iXG4gICAgICAgICAgICBsZXQgczNKb2IgPSBqb2IgYXMgUzNGaWxlSm9iO1xuICAgICAgICAgICAgczNKb2Iuc2V0TG9jYWxseUF2YWlsYWJsZShmYWxzZSk7XG4gICAgICAgICAgICBzM0pvYi5zZXRQYXRoKGRhdGEuTG9jYXRpb24pO1xuICAgICAgICAgICAgczNKb2IuYnVja2V0ID0gZGF0YS5CdWNrZXQ7XG4gICAgICAgICAgICBzM0pvYi5rZXkgPSBkYXRhLktleTtcbiAgICAgICAgICAgIHMzSm9iLmVUYWcgPSBkYXRhLkVUYWc7XG5cbiAgICAgICAgICAgIGNhbGxiYWNrKHMzSm9iKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG59Il19
