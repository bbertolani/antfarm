"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var nest_1 = require("./nest");
var s3FileJob_1 = require("../job/s3FileJob");
var AWS = require("aws-sdk"), _ = require("lodash"), async = require("async"), fs = require("fs");
var S3Nest = (function (_super) {
    __extends(S3Nest, _super);
    /**
     * Constructor
     * @param e
     * @param bucket            AWS S3 bucket to watch.
     * @param keyPrefix         Optional key prefix (sub-directory) to watch.
     * @param checkEvery        Frequency of bucket checking, in minutes.
     * @param allowCreation     Create the bucket:prefix if it does not exist.
     */
    function S3Nest(e, bucket, keyPrefix, checkEvery, allowCreation) {
        if (checkEvery === void 0) { checkEvery = 5; }
        if (allowCreation === void 0) { allowCreation = false; }
        _super.call(this, e, "An S3 bucket");
        var sn = this;
        sn.s3 = new AWS.S3();
        sn.bucket = bucket;
        sn.keyPrefix = keyPrefix;
        sn.checkEvery = checkEvery;
        sn.checkEveryMs = checkEvery * 60000;
        sn.allowCreation = allowCreation;
        sn.verifyBucket();
    }
    /**
     * Set hard-coded AWS credentials.
     * @param accessKeyId
     * @param secretAccessKey
     */
    S3Nest.prototype.setCredentials = function (accessKeyId, secretAccessKey) {
        AWS.config.update({ accessKeyId: accessKeyId, secretAccessKey: secretAccessKey });
    };
    /**
     * Verify bucket and handle creation of bucket if need be.
     */
    S3Nest.prototype.verifyBucket = function () {
        var sn = this;
        sn.headBucket(function (headSuccess) {
            if (!headSuccess) {
                if (sn.allowCreation) {
                    sn.createBucket(function (createSuccess) {
                        if (!createSuccess) {
                            sn.e.log(3, "Bucket \"" + sn.bucket + "\" could not be created.", sn);
                        }
                    });
                }
                else {
                    sn.e.log(3, "Bucket \"" + sn.bucket + "\" does not exist and allowCreation is set to false.", sn);
                }
            }
        });
    };
    /**
     * Verify that the bucket is available and exists
     * @param callback
     */
    S3Nest.prototype.headBucket = function (callback) {
        var sn = this;
        var params = { Bucket: sn.bucket };
        sn.s3.headBucket(params, function (err, data) {
            if (err) {
                sn.e.log(2, "headBucket error: " + err, sn);
                callback(false);
            }
            else {
                // if (_.isEmpty(data)) {
                //     sn.e.log(2, `headBucket empty response`, sn);
                //     callback(true);
                // } else {
                //     sn.e.log(0, `headBucket success: ${data}`, sn);
                //     console.log(data);
                //     callback(true);
                // }
                sn.e.log(0, "Bucket \"" + sn.bucket + "\" is available.", sn);
                callback(true);
            }
        });
    };
    S3Nest.prototype.createBucket = function (callback) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
        };
        sn.s3.createBucket(params, function (err, data) {
            if (err) {
                sn.e.log(3, "createBucket error: " + err, sn);
                callback(false);
            }
            else {
                if (_.isEmpty(data)) {
                    sn.e.log(2, "createBucket empty response", sn);
                    callback(false);
                }
                else {
                    sn.e.log(0, "createBucket success: " + data, sn);
                    callback(true);
                }
            }
        });
    };
    S3Nest.prototype.load = function () {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            // ContinuationToken: 'STRING_VALUE',
            // Delimiter: 'STRING_VALUE',
            // EncodingType: 'url',
            // FetchOwner: true || false,
            // MaxKeys: 0,
            Prefix: sn.keyPrefix
        };
        sn.s3.listObjectsV2(params, function (err, data) {
            if (err) {
                sn.e.log(3, "listObjectsV2: " + err, sn);
            }
            else {
                var contents_1 = data.Contents;
                // Download each file found
                if (contents_1.length > 0) {
                    sn.e.log(0, "Found " + contents_1.length + " objects in \"" + sn.bucket + "/" + sn.keyPrefix + "\".", sn);
                    async.eachSeries(contents_1, function (object, done) {
                        // Create temp file
                        sn.e.log(1, "S3 found file \"" + object.Key + "\".", sn);
                        var job = new s3FileJob_1.S3FileJob(sn.e, object.Key);
                        // Download and pipe to file
                        var params = { Bucket: sn.bucket, Key: object.Key };
                        var file = require("fs").createWriteStream(job.getPath());
                        sn.s3.getObject(params).createReadStream().pipe(file);
                        sn.e.log(1, "Downloading \"" + object.Key + "\".", sn);
                        file.on("close", function () {
                            // Delete object
                            sn.deleteObject(object.Key);
                            sn.arrive(job);
                            done();
                        });
                    }, function (err) {
                        if (err) {
                            sn.e.log(3, "Async series download error: \"" + err + "\".", sn);
                        }
                        sn.e.log(0, "Completed " + contents_1.length + " synchronous download(s).", sn);
                    });
                }
            }
        });
    };
    /**
     * Removes an object from an S3 bucket.
     * @param key
     */
    S3Nest.prototype.deleteObject = function (key) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            Key: key /* required */
        };
        sn.s3.deleteObject(params, function (err) {
            if (err) {
                sn.e.log(3, "S3 delete object error " + err, sn);
            }
        });
    };
    /**
     * Watch an S3 bucket.
     */
    S3Nest.prototype.watch = function () {
        var sn = this;
        if (sn.checkEvery === 0) {
            sn.e.log(3, "Cannot watch this bucket. Check every (minutes) set to 0.", sn);
        }
        else {
            sn.e.log(1, "Watching S3 bucket.", sn);
            var count_1 = 0;
            setInterval(function () {
                count_1++;
                sn.e.log(1, "Re-checking S3 bucket, attempt " + count_1 + ".", sn);
                sn.load();
            }, sn.checkEveryMs, count_1);
        }
    };
    /**
     * Nest arrival
     * @param job
     */
    S3Nest.prototype.arrive = function (job) {
        _super.prototype.arrive.call(this, job);
    };
    /**
     * Upload a file to an S3 bucket.
     */
    S3Nest.prototype.take = function (job, callback) {
        var sn = this;
        try {
            sn.uploadFile(job, function (s3Job) {
                callback(s3Job);
            });
        }
        catch (e) {
            sn.e.log(3, "Take upload error, " + e, sn);
        }
    };
    /**
     * Calculate the percent remaining from the httpUploadProgress event values.
     * @param total
     * @param loaded
     * @param part
     * @returns {number}
     */
    S3Nest.prototype.calculateRemaining = function (total, loaded, part) {
        var sn = this;
        if (!isNaN(total) && !isNaN(loaded)) {
            var percentRemaining = Math.round((loaded / total) * 100);
            if (isNaN(percentRemaining) || percentRemaining > 100) {
                sn.e.log(3, "Error calculating percent remaining: " + percentRemaining + " (" + typeof percentRemaining + "), total: " + total + ", loaded: " + loaded + ".", sn);
                return 0;
            }
            else {
                return percentRemaining;
            }
        }
        else {
            return 0;
        }
    };
    /**
     * Upload file to S3
     * @param job {FileJob}     FileJob to be uploaded.
     * @param callback          Callback includes the S3FileJob parameter.
     */
    S3Nest.prototype.uploadFile = function (job, callback) {
        var sn = this;
        var body = fs.createReadStream(job.getPath());
        var params = {
            Bucket: sn.bucket,
            Key: sn.keyPrefix + job.getName(),
            Body: body,
            ACL: "public-read"
        };
        var percentUploaded = 0;
        sn.s3.upload(params).
            on("httpUploadProgress", function (evt) {
            // console.log("evt", evt);
            percentUploaded = sn.calculateRemaining(evt.total, evt.loaded, evt.part);
            sn.e.log(0, "Uploading \"" + evt.key + "\" - " + percentUploaded + "%", sn);
        }).
            send(function (err, data) {
            if (err) {
                sn.e.log(3, "S3 upload error: " + err, sn);
            }
            // Change job type to a S3FileJob
            var s3Job = job;
            s3Job.setLocallyAvailable(false);
            s3Job.setPath(data.Location);
            s3Job.bucket = data.Bucket;
            s3Job.key = data.Key;
            s3Job.eTag = data.ETag;
            callback(s3Job);
        });
    };
    return S3Nest;
}(nest_1.Nest));
exports.S3Nest = S3Nest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGlCQUFjLEdBQUcsQ0FBQyxHQUFHLGFBQU8sZUFBZSxNQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcEUsQ0FBQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLFVBQVMsR0FBRyxFQUFFLElBQUk7WUFDbkIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDTixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsc0JBQW9CLEdBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMvQyxDQUFDO1lBRUQsaUNBQWlDO1lBQ2pDLElBQUksS0FBSyxHQUFHLEdBQWdCLENBQUM7WUFDN0IsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdCLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMzQixLQUFLLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDckIsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBRXZCLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTCxhQUFDO0FBQUQsQ0FqVEEsQUFpVEMsQ0FqVDJCLFdBQUksR0FpVC9CO0FBalRZLGNBQU0sU0FpVGxCLENBQUEiLCJmaWxlIjoibGliL25lc3QvczNOZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmVzdCB9IGZyb20gXCIuL25lc3RcIjtcbmltcG9ydCB7IEZpbGVKb2IgfSBmcm9tIFwiLi8uLi9qb2IvZmlsZUpvYlwiO1xuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tIFwiLi4vZW52aXJvbm1lbnQvZW52aXJvbm1lbnRcIjtcbmltcG9ydCB7UzNGaWxlSm9ifSBmcm9tIFwiLi4vam9iL3MzRmlsZUpvYlwiO1xuXG5jb25zdCAgIEFXUyA9IHJlcXVpcmUoXCJhd3Mtc2RrXCIpLFxuICAgICAgICBfID0gcmVxdWlyZShcImxvZGFzaFwiKSxcbiAgICAgICAgYXN5bmMgPSByZXF1aXJlKFwiYXN5bmNcIiksXG4gICAgICAgIGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG5leHBvcnQgY2xhc3MgUzNOZXN0IGV4dGVuZHMgTmVzdCB7XG5cbiAgICBwcm90ZWN0ZWQgY2xpZW50OiBhbnk7XG4gICAgcHJvdGVjdGVkIHMzOiBhbnk7XG4gICAgcHJvdGVjdGVkIGJ1Y2tldDogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBrZXlQcmVmaXg6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgY2hlY2tFdmVyeTogbnVtYmVyO1xuICAgIHByb3RlY3RlZCBjaGVja0V2ZXJ5TXM6IG51bWJlcjtcbiAgICBwcm90ZWN0ZWQgYWxsb3dDcmVhdGlvbjogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIENvbnN0cnVjdG9yXG4gICAgICogQHBhcmFtIGVcbiAgICAgKiBAcGFyYW0gYnVja2V0ICAgICAgICAgICAgQVdTIFMzIGJ1Y2tldCB0byB3YXRjaC5cbiAgICAgKiBAcGFyYW0ga2V5UHJlZml4ICAgICAgICAgT3B0aW9uYWwga2V5IHByZWZpeCAoc3ViLWRpcmVjdG9yeSkgdG8gd2F0Y2guXG4gICAgICogQHBhcmFtIGNoZWNrRXZlcnkgICAgICAgIEZyZXF1ZW5jeSBvZiBidWNrZXQgY2hlY2tpbmcsIGluIG1pbnV0ZXMuXG4gICAgICogQHBhcmFtIGFsbG93Q3JlYXRpb24gICAgIENyZWF0ZSB0aGUgYnVja2V0OnByZWZpeCBpZiBpdCBkb2VzIG5vdCBleGlzdC5cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgZTogRW52aXJvbm1lbnQsIGJ1Y2tldDogc3RyaW5nLCBrZXlQcmVmaXg/OiBzdHJpbmcsIGNoZWNrRXZlcnk6IG51bWJlciA9IDUsIGFsbG93Q3JlYXRpb246IGJvb2xlYW4gPSBmYWxzZVxuICAgICkge1xuICAgICAgICBzdXBlcihlLCBcIkFuIFMzIGJ1Y2tldFwiKTtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcbiAgICAgICAgc24uczMgPSBuZXcgQVdTLlMzKCk7XG5cbiAgICAgICAgc24uYnVja2V0ID0gYnVja2V0O1xuICAgICAgICBzbi5rZXlQcmVmaXggPSBrZXlQcmVmaXg7XG4gICAgICAgIHNuLmNoZWNrRXZlcnkgPSBjaGVja0V2ZXJ5O1xuICAgICAgICBzbi5jaGVja0V2ZXJ5TXMgPSBjaGVja0V2ZXJ5ICogNjAwMDA7XG4gICAgICAgIHNuLmFsbG93Q3JlYXRpb24gPSBhbGxvd0NyZWF0aW9uO1xuXG4gICAgICAgIHNuLnZlcmlmeUJ1Y2tldCgpO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogU2V0IGhhcmQtY29kZWQgQVdTIGNyZWRlbnRpYWxzLlxuICAgICAqIEBwYXJhbSBhY2Nlc3NLZXlJZFxuICAgICAqIEBwYXJhbSBzZWNyZXRBY2Nlc3NLZXlcbiAgICAgKi9cbiAgICBwdWJsaWMgc2V0Q3JlZGVudGlhbHMoYWNjZXNzS2V5SWQ6IHN0cmluZywgc2VjcmV0QWNjZXNzS2V5OiBzdHJpbmcpIHtcbiAgICAgICAgQVdTLmNvbmZpZy51cGRhdGUoe2FjY2Vzc0tleUlkOiBhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5OiBzZWNyZXRBY2Nlc3NLZXl9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWZXJpZnkgYnVja2V0IGFuZCBoYW5kbGUgY3JlYXRpb24gb2YgYnVja2V0IGlmIG5lZWQgYmUuXG4gICAgICovXG4gICAgcHJvdGVjdGVkIHZlcmlmeUJ1Y2tldCgpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcbiAgICAgICAgc24uaGVhZEJ1Y2tldChoZWFkU3VjY2VzcyA9PiB7XG4gICAgICAgICAgICBpZiAoIWhlYWRTdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNuLmFsbG93Q3JlYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgc24uY3JlYXRlQnVja2V0KGNyZWF0ZVN1Y2Nlc3MgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjcmVhdGVTdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMywgYEJ1Y2tldCBcIiR7c24uYnVja2V0fVwiIGNvdWxkIG5vdCBiZSBjcmVhdGVkLmAsIHNuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMywgYEJ1Y2tldCBcIiR7c24uYnVja2V0fVwiIGRvZXMgbm90IGV4aXN0IGFuZCBhbGxvd0NyZWF0aW9uIGlzIHNldCB0byBmYWxzZS5gLCBzbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWZXJpZnkgdGhhdCB0aGUgYnVja2V0IGlzIGF2YWlsYWJsZSBhbmQgZXhpc3RzXG4gICAgICogQHBhcmFtIGNhbGxiYWNrXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGhlYWRCdWNrZXQoY2FsbGJhY2spIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcblxuICAgICAgICBsZXQgcGFyYW1zID0geyBCdWNrZXQ6IHNuLmJ1Y2tldCB9O1xuXG4gICAgICAgIHNuLnMzLmhlYWRCdWNrZXQocGFyYW1zLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgc24uZS5sb2coMiwgYGhlYWRCdWNrZXQgZXJyb3I6ICR7ZXJyfWAsIHNuKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGlmIChfLmlzRW1wdHkoZGF0YSkpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgc24uZS5sb2coMiwgYGhlYWRCdWNrZXQgZW1wdHkgcmVzcG9uc2VgLCBzbik7XG4gICAgICAgICAgICAgICAgLy8gICAgIGNhbGxiYWNrKHRydWUpO1xuICAgICAgICAgICAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gICAgIHNuLmUubG9nKDAsIGBoZWFkQnVja2V0IHN1Y2Nlc3M6ICR7ZGF0YX1gLCBzbik7XG4gICAgICAgICAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgICAgIC8vICAgICBjYWxsYmFjayh0cnVlKTtcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgc24uZS5sb2coMCwgYEJ1Y2tldCBcIiR7c24uYnVja2V0fVwiIGlzIGF2YWlsYWJsZS5gLCBzbik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVCdWNrZXQoY2FsbGJhY2spIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcblxuICAgICAgICBsZXQgcGFyYW1zID0ge1xuICAgICAgICAgICAgQnVja2V0OiBzbi5idWNrZXQsIC8qIHJlcXVpcmVkICovXG4gICAgICAgICAgICAvLyBBQ0w6ICdwcml2YXRlIHwgcHVibGljLXJlYWQgfCBwdWJsaWMtcmVhZC13cml0ZSB8IGF1dGhlbnRpY2F0ZWQtcmVhZCcsXG4gICAgICAgICAgICAvLyBDcmVhdGVCdWNrZXRDb25maWd1cmF0aW9uOiB7XG4gICAgICAgICAgICAvLyAgICAgTG9jYXRpb25Db25zdHJhaW50OiAnRVUgfCBldS13ZXN0LTEgfCB1cy13ZXN0LTEgfCB1cy13ZXN0LTIgfCBhcC1zb3V0aC0xIHwgYXAtc291dGhlYXN0LTEgfCBhcC1zb3V0aGVhc3QtMiB8IGFwLW5vcnRoZWFzdC0xIHwgc2EtZWFzdC0xIHwgY24tbm9ydGgtMSB8IGV1LWNlbnRyYWwtMSdcbiAgICAgICAgICAgIC8vIH0sXG4gICAgICAgICAgICAvLyBHcmFudEZ1bGxDb250cm9sOiAnU1RSSU5HX1ZBTFVFJyxcbiAgICAgICAgICAgIC8vIEdyYW50UmVhZDogJ1NUUklOR19WQUxVRScsXG4gICAgICAgICAgICAvLyBHcmFudFJlYWRBQ1A6ICdTVFJJTkdfVkFMVUUnLFxuICAgICAgICAgICAgLy8gR3JhbnRXcml0ZTogJ1NUUklOR19WQUxVRScsXG4gICAgICAgICAgICAvLyBHcmFudFdyaXRlQUNQOiAnU1RSSU5HX1ZBTFVFJ1xuICAgICAgICB9O1xuICAgICAgICBzbi5zMy5jcmVhdGVCdWNrZXQocGFyYW1zLCBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgY3JlYXRlQnVja2V0IGVycm9yOiAke2Vycn1gLCBzbik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoXy5pc0VtcHR5KGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDIsIGBjcmVhdGVCdWNrZXQgZW1wdHkgcmVzcG9uc2VgLCBzbik7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygwLCBgY3JlYXRlQnVja2V0IHN1Y2Nlc3M6ICR7ZGF0YX1gLCBzbik7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZCgpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcblxuICAgICAgICBsZXQgcGFyYW1zID0ge1xuICAgICAgICAgICAgQnVja2V0OiBzbi5idWNrZXQsIC8qIHJlcXVpcmVkICovXG4gICAgICAgICAgICAvLyBDb250aW51YXRpb25Ub2tlbjogJ1NUUklOR19WQUxVRScsXG4gICAgICAgICAgICAvLyBEZWxpbWl0ZXI6ICdTVFJJTkdfVkFMVUUnLFxuICAgICAgICAgICAgLy8gRW5jb2RpbmdUeXBlOiAndXJsJyxcbiAgICAgICAgICAgIC8vIEZldGNoT3duZXI6IHRydWUgfHwgZmFsc2UsXG4gICAgICAgICAgICAvLyBNYXhLZXlzOiAwLFxuICAgICAgICAgICAgUHJlZml4OiBzbi5rZXlQcmVmaXhcbiAgICAgICAgfTtcblxuICAgICAgICBzbi5zMy5saXN0T2JqZWN0c1YyKHBhcmFtcywgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBsaXN0T2JqZWN0c1YyOiAke2Vycn1gLCBzbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBjb250ZW50cyA9IGRhdGEuQ29udGVudHM7XG5cbiAgICAgICAgICAgICAgICAvLyBEb3dubG9hZCBlYWNoIGZpbGUgZm91bmRcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygwLCBgRm91bmQgJHtjb250ZW50cy5sZW5ndGh9IG9iamVjdHMgaW4gXCIke3NuLmJ1Y2tldH0vJHtzbi5rZXlQcmVmaXh9XCIuYCwgc24pO1xuXG4gICAgICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoY29udGVudHMsIChvYmplY3QsIGRvbmUpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHRlbXAgZmlsZVxuICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMSwgYFMzIGZvdW5kIGZpbGUgXCIke29iamVjdC5LZXl9XCIuYCwgc24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGpvYiA9IG5ldyBTM0ZpbGVKb2Ioc24uZSwgb2JqZWN0LktleSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvd25sb2FkIGFuZCBwaXBlIHRvIGZpbGVcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwYXJhbXMgPSB7QnVja2V0OiBzbi5idWNrZXQsIEtleTogb2JqZWN0LktleX07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZmlsZSA9IHJlcXVpcmUoXCJmc1wiKS5jcmVhdGVXcml0ZVN0cmVhbShqb2IuZ2V0UGF0aCgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuLnMzLmdldE9iamVjdChwYXJhbXMpLmNyZWF0ZVJlYWRTdHJlYW0oKS5waXBlKGZpbGUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygxLCBgRG93bmxvYWRpbmcgXCIke29iamVjdC5LZXl9XCIuYCwgc24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlLm9uKFwiY2xvc2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlbGV0ZSBvYmplY3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbi5kZWxldGVPYmplY3Qob2JqZWN0LktleSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbi5hcnJpdmUoam9iKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuXG4gICAgICAgICAgICAgICAgICAgIH0sIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMywgYEFzeW5jIHNlcmllcyBkb3dubG9hZCBlcnJvcjogXCIke2Vycn1cIi5gLCBzbik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygwLCBgQ29tcGxldGVkICR7Y29udGVudHMubGVuZ3RofSBzeW5jaHJvbm91cyBkb3dubG9hZChzKS5gLCBzbik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlcyBhbiBvYmplY3QgZnJvbSBhbiBTMyBidWNrZXQuXG4gICAgICogQHBhcmFtIGtleVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBkZWxldGVPYmplY3Qoa2V5KSB7XG4gICAgICAgIGxldCBzbiA9IHRoaXM7XG4gICAgICAgIGxldCBwYXJhbXMgPSB7XG4gICAgICAgICAgICBCdWNrZXQ6IHNuLmJ1Y2tldCwgLyogcmVxdWlyZWQgKi9cbiAgICAgICAgICAgIEtleToga2V5IC8qIHJlcXVpcmVkICovXG4gICAgICAgIH07XG4gICAgICAgIHNuLnMzLmRlbGV0ZU9iamVjdChwYXJhbXMsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBTMyBkZWxldGUgb2JqZWN0IGVycm9yICR7ZXJyfWAsIHNuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXYXRjaCBhbiBTMyBidWNrZXQuXG4gICAgICovXG4gICAgcHVibGljIHdhdGNoKCkge1xuICAgICAgICBsZXQgc24gPSB0aGlzO1xuXG4gICAgICAgIGlmIChzbi5jaGVja0V2ZXJ5ID09PSAwKSB7XG4gICAgICAgICAgICBzbi5lLmxvZygzLCBcIkNhbm5vdCB3YXRjaCB0aGlzIGJ1Y2tldC4gQ2hlY2sgZXZlcnkgKG1pbnV0ZXMpIHNldCB0byAwLlwiLCBzbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzbi5lLmxvZygxLCBcIldhdGNoaW5nIFMzIGJ1Y2tldC5cIiwgc24pO1xuXG4gICAgICAgICAgICBsZXQgY291bnQgPSAwO1xuXG4gICAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBjb3VudCsrO1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDEsIGBSZS1jaGVja2luZyBTMyBidWNrZXQsIGF0dGVtcHQgJHtjb3VudH0uYCwgc24pO1xuICAgICAgICAgICAgICAgIHNuLmxvYWQoKTtcbiAgICAgICAgICAgIH0sIHNuLmNoZWNrRXZlcnlNcywgY291bnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTmVzdCBhcnJpdmFsXG4gICAgICogQHBhcmFtIGpvYlxuICAgICAqL1xuICAgIHB1YmxpYyBhcnJpdmUoam9iOiBGaWxlSm9iKSB7XG4gICAgICAgIHN1cGVyLmFycml2ZShqb2IpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCBhIGZpbGUgdG8gYW4gUzMgYnVja2V0LlxuICAgICAqL1xuICAgIHB1YmxpYyB0YWtlKGpvYjogRmlsZUpvYiwgY2FsbGJhY2s/OiBhbnkpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICBzbi51cGxvYWRGaWxlKGpvYiwgKHMzSm9iOiBTM0ZpbGVKb2IpID0+IHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhzM0pvYik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBzbi5lLmxvZygzLCBcIlRha2UgdXBsb2FkIGVycm9yLCBcIiArIGUsIHNuKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIHRoZSBwZXJjZW50IHJlbWFpbmluZyBmcm9tIHRoZSBodHRwVXBsb2FkUHJvZ3Jlc3MgZXZlbnQgdmFsdWVzLlxuICAgICAqIEBwYXJhbSB0b3RhbFxuICAgICAqIEBwYXJhbSBsb2FkZWRcbiAgICAgKiBAcGFyYW0gcGFydFxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVSZW1haW5pbmcodG90YWw6IG51bWJlciwgbG9hZGVkOiBudW1iZXIsIHBhcnQ/OiBudW1iZXIpIHtcbiAgICAgICAgbGV0IHNuID0gdGhpcztcbiAgICAgICAgaWYgKCFpc05hTih0b3RhbCkgJiYgIWlzTmFOKGxvYWRlZCkpIHtcbiAgICAgICAgICAgIGxldCBwZXJjZW50UmVtYWluaW5nID0gTWF0aC5yb3VuZCgoIGxvYWRlZCAvIHRvdGFsKSAqIDEwMCk7XG4gICAgICAgICAgICBpZiAoaXNOYU4ocGVyY2VudFJlbWFpbmluZykgfHwgcGVyY2VudFJlbWFpbmluZyA+IDEwMCkge1xuICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBFcnJvciBjYWxjdWxhdGluZyBwZXJjZW50IHJlbWFpbmluZzogJHtwZXJjZW50UmVtYWluaW5nfSAoJHt0eXBlb2YgcGVyY2VudFJlbWFpbmluZ30pLCB0b3RhbDogJHt0b3RhbH0sIGxvYWRlZDogJHtsb2FkZWR9LmAsIHNuKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBlcmNlbnRSZW1haW5pbmc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCBmaWxlIHRvIFMzXG4gICAgICogQHBhcmFtIGpvYiB7RmlsZUpvYn0gICAgIEZpbGVKb2IgdG8gYmUgdXBsb2FkZWQuXG4gICAgICogQHBhcmFtIGNhbGxiYWNrICAgICAgICAgIENhbGxiYWNrIGluY2x1ZGVzIHRoZSBTM0ZpbGVKb2IgcGFyYW1ldGVyLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCB1cGxvYWRGaWxlKGpvYjogRmlsZUpvYiwgY2FsbGJhY2s6IGFueSkge1xuICAgICAgICBsZXQgc24gPSB0aGlzO1xuICAgICAgICBsZXQgYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oam9iLmdldFBhdGgoKSk7XG4gICAgICAgIGxldCBwYXJhbXMgPSB7XG4gICAgICAgICAgICBCdWNrZXQ6IHNuLmJ1Y2tldCxcbiAgICAgICAgICAgIEtleTogc24ua2V5UHJlZml4ICsgam9iLmdldE5hbWUoKSxcbiAgICAgICAgICAgIEJvZHk6IGJvZHksXG4gICAgICAgICAgICBBQ0w6IFwicHVibGljLXJlYWRcIlxuICAgICAgICB9O1xuICAgICAgICBsZXQgcGVyY2VudFVwbG9hZGVkID0gMDtcbiAgICAgICAgc24uczMudXBsb2FkKHBhcmFtcykuXG4gICAgICAgIG9uKFwiaHR0cFVwbG9hZFByb2dyZXNzXCIsIGZ1bmN0aW9uKGV2dCkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJldnRcIiwgZXZ0KTtcbiAgICAgICAgICAgIHBlcmNlbnRVcGxvYWRlZCA9IHNuLmNhbGN1bGF0ZVJlbWFpbmluZyhldnQudG90YWwsIGV2dC5sb2FkZWQsIGV2dC5wYXJ0KTtcbiAgICAgICAgICAgIHNuLmUubG9nKDAsIGBVcGxvYWRpbmcgXCIke2V2dC5rZXl9XCIgLSAke3BlcmNlbnRVcGxvYWRlZH0lYCwgc24pO1xuICAgICAgICB9KS5cbiAgICAgICAgc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgUzMgdXBsb2FkIGVycm9yOiAke2Vycn1gLCBzbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIENoYW5nZSBqb2IgdHlwZSB0byBhIFMzRmlsZUpvYlxuICAgICAgICAgICAgbGV0IHMzSm9iID0gam9iIGFzIFMzRmlsZUpvYjtcbiAgICAgICAgICAgIHMzSm9iLnNldExvY2FsbHlBdmFpbGFibGUoZmFsc2UpO1xuICAgICAgICAgICAgczNKb2Iuc2V0UGF0aChkYXRhLkxvY2F0aW9uKTtcbiAgICAgICAgICAgIHMzSm9iLmJ1Y2tldCA9IGRhdGEuQnVja2V0O1xuICAgICAgICAgICAgczNKb2Iua2V5ID0gZGF0YS5LZXk7XG4gICAgICAgICAgICBzM0pvYi5lVGFnID0gZGF0YS5FVGFnO1xuXG4gICAgICAgICAgICBjYWxsYmFjayhzM0pvYik7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSJdfQ==
