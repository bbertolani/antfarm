"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var nest_1 = require("./nest");
var s3FileJob_1 = require("../job/s3FileJob");
var AWS = require("aws-sdk"), _ = require("lodash"), async = require("async"), fs = require("fs");
var S3Nest = (function (_super) {
    __extends(S3Nest, _super);
    /**
     * Constructor
     * @param e
     * @param bucket            AWS S3 bucket to watch.
     * @param keyPrefix         Optional key prefix (sub-directory) to watch.
     * @param checkEvery        Frequency of bucket checking, in minutes.
     * @param allowCreation     Create the bucket:prefix if it does not exist.
     */
    function S3Nest(e, bucket, keyPrefix, checkEvery, allowCreation) {
        if (checkEvery === void 0) { checkEvery = 5; }
        if (allowCreation === void 0) { allowCreation = false; }
        var _this = _super.call(this, e, "An S3 bucket") || this;
        var sn = _this;
        sn.s3 = new AWS.S3();
        sn.bucket = bucket;
        sn.keyPrefix = keyPrefix;
        sn.checkEvery = checkEvery;
        sn.checkEveryMs = checkEvery * 60000;
        sn.allowCreation = allowCreation;
        sn.verifyBucket();
        return _this;
    }
    /**
     * Set hard-coded AWS credentials.
     * @param accessKeyId
     * @param secretAccessKey
     */
    S3Nest.prototype.setCredentials = function (accessKeyId, secretAccessKey) {
        AWS.config.update({ accessKeyId: accessKeyId, secretAccessKey: secretAccessKey });
    };
    /**
     * Verify bucket and handle creation of bucket if need be.
     */
    S3Nest.prototype.verifyBucket = function () {
        var sn = this;
        sn.headBucket(function (headSuccess) {
            if (!headSuccess) {
                if (sn.allowCreation) {
                    sn.createBucket(function (createSuccess) {
                        if (!createSuccess) {
                            sn.e.log(3, "Bucket \"" + sn.bucket + "\" could not be created.", sn);
                        }
                    });
                }
                else {
                    sn.e.log(3, "Bucket \"" + sn.bucket + "\" does not exist and allowCreation is set to false.", sn);
                }
            }
        });
    };
    /**
     * Verify that the bucket is available and exists
     * @param callback
     */
    S3Nest.prototype.headBucket = function (callback) {
        var sn = this;
        var params = { Bucket: sn.bucket };
        sn.s3.headBucket(params, function (err, data) {
            if (err) {
                sn.e.log(2, "headBucket error: " + err, sn);
                callback(false);
            }
            else {
                // if (_.isEmpty(data)) {
                //     sn.e.log(2, `headBucket empty response`, sn);
                //     callback(true);
                // } else {
                //     sn.e.log(0, `headBucket success: ${data}`, sn);
                //     console.log(data);
                //     callback(true);
                // }
                sn.e.log(0, "Bucket \"" + sn.bucket + "\" is available.", sn);
                callback(true);
            }
        });
    };
    S3Nest.prototype.createBucket = function (callback) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
        };
        sn.s3.createBucket(params, function (err, data) {
            if (err) {
                sn.e.log(3, "createBucket error: " + err, sn);
                callback(false);
            }
            else {
                if (_.isEmpty(data)) {
                    sn.e.log(2, "createBucket empty response", sn);
                    callback(false);
                }
                else {
                    sn.e.log(0, "createBucket success: " + data, sn);
                    callback(true);
                }
            }
        });
    };
    S3Nest.prototype.load = function () {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            // ContinuationToken: 'STRING_VALUE',
            // Delimiter: 'STRING_VALUE',
            // EncodingType: 'url',
            // FetchOwner: true || false,
            // MaxKeys: 0,
            Prefix: sn.keyPrefix
        };
        sn.s3.listObjectsV2(params, function (err, data) {
            if (err) {
                sn.e.log(3, "listObjectsV2: " + err, sn);
            }
            else {
                var contents_1 = data.Contents;
                // Download each file found
                if (contents_1.length > 0) {
                    sn.e.log(0, "Found " + contents_1.length + " objects in \"" + sn.bucket + "/" + sn.keyPrefix + "\".", sn);
                    async.eachSeries(contents_1, function (object, done) {
                        // Create temp file
                        sn.e.log(1, "S3 found file \"" + object.Key + "\".", sn);
                        var job = new s3FileJob_1.S3FileJob(sn.e, object.Key);
                        // Download and pipe to file
                        var params = { Bucket: sn.bucket, Key: object.Key };
                        var file = require("fs").createWriteStream(job.path);
                        sn.s3.getObject(params).createReadStream().pipe(file);
                        sn.e.log(1, "Downloading \"" + object.Key + "\".", sn);
                        file.on("close", function () {
                            // Delete object
                            sn.deleteObject(object.Key);
                            sn.arrive(job);
                            done();
                        });
                    }, function (err) {
                        if (err) {
                            sn.e.log(3, "Async series download error: \"" + err + "\".", sn);
                        }
                        sn.e.log(0, "Completed " + contents_1.length + " synchronous download(s).", sn);
                    });
                }
            }
        });
    };
    /**
     * Removes an object from an S3 bucket.
     * @param key
     */
    S3Nest.prototype.deleteObject = function (key) {
        var sn = this;
        var params = {
            Bucket: sn.bucket,
            Key: key /* required */
        };
        sn.s3.deleteObject(params, function (err) {
            if (err) {
                sn.e.log(3, "S3 delete object error " + err, sn);
            }
        });
    };
    /**
     * Watch an S3 bucket.
     */
    S3Nest.prototype.watch = function () {
        var sn = this;
        if (sn.checkEvery === 0) {
            sn.e.log(3, "Cannot watch this bucket. Check every (minutes) set to 0.", sn);
        }
        else {
            sn.e.log(1, "Watching S3 bucket.", sn);
            var count_1 = 0;
            setInterval(function () {
                count_1++;
                sn.e.log(1, "Re-checking S3 bucket, attempt " + count_1 + ".", sn);
                sn.load();
            }, sn.checkEveryMs, count_1);
        }
    };
    /**
     * Nest arrival
     * @param job
     */
    S3Nest.prototype.arrive = function (job) {
        _super.prototype.arrive.call(this, job);
    };
    /**
     * Upload a file to an S3 bucket.
     */
    S3Nest.prototype.take = function (job, callback) {
        var sn = this;
        try {
            sn.uploadFile(job, function (s3Job) {
                callback(s3Job);
            });
        }
        catch (e) {
            sn.e.log(3, "Take upload error, " + e, sn);
        }
    };
    /**
     * Calculate the percent remaining from the httpUploadProgress event values.
     * @param total
     * @param loaded
     * @param part
     * @returns {number}
     */
    S3Nest.prototype.calculateRemaining = function (total, loaded, part) {
        var sn = this;
        if (!isNaN(total) && !isNaN(loaded)) {
            var percentRemaining = Math.round((loaded / total) * 100);
            if (isNaN(percentRemaining) || percentRemaining > 100) {
                sn.e.log(3, "Error calculating percent remaining: " + percentRemaining + " (" + typeof percentRemaining + "), total: " + total + ", loaded: " + loaded + ".", sn);
                return 0;
            }
            else {
                return percentRemaining;
            }
        }
        else {
            return 0;
        }
    };
    /**
     * Upload file to S3
     * @param job {FileJob}     FileJob to be uploaded.
     * @param callback          Callback includes the S3FileJob parameter.
     */
    S3Nest.prototype.uploadFile = function (job, callback) {
        var sn = this;
        var body = fs.createReadStream(job.path);
        var params = {
            Bucket: sn.bucket,
            Key: sn.keyPrefix + job.name,
            Body: body,
            ACL: "public-read"
        };
        var percentUploaded = 0;
        sn.s3.upload(params).
            on("httpUploadProgress", function (evt) {
            // console.log("evt", evt);
            percentUploaded = sn.calculateRemaining(evt.total, evt.loaded, evt.part);
            sn.e.log(0, "Uploading \"" + evt.key + "\" - " + percentUploaded + "%", sn);
        }).
            send(function (err, data) {
            if (err) {
                sn.e.log(3, "S3 upload error: " + err, sn);
            }
            // Change job type to a S3FileJob
            var s3Job = job;
            s3Job.locallyAvailable = false;
            s3Job.path = data.Location;
            s3Job.bucket = data.Bucket;
            s3Job.key = data.Key;
            s3Job.eTag = data.ETag;
            callback(s3Job);
        });
    };
    return S3Nest;
}(nest_1.Nest));
exports.S3Nest = S3Nest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxpQkFBYyxHQUFHLENBQUMsR0FBRyxhQUFPLGVBQWUsTUFBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQztZQUNGLElBQUksQ0FBQyxVQUFTLEdBQUcsRUFBRSxJQUFJO1lBQ25CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ04sRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLHNCQUFvQixHQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDL0MsQ0FBQztZQUVELGlDQUFpQztZQUNqQyxJQUFJLEtBQUssR0FBRyxHQUFnQixDQUFDO1lBQzdCLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7WUFDL0IsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQzNCLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMzQixLQUFLLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDckIsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBRXZCLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTCxhQUFDO0FBQUQsQ0FqVEEsQUFpVEMsQ0FqVDJCLFdBQUksR0FpVC9CO0FBalRZLHdCQUFNIiwiZmlsZSI6ImxpYi9uZXN0L3MzTmVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5lc3QgfSBmcm9tIFwiLi9uZXN0XCI7XHJcbmltcG9ydCB7IEZpbGVKb2IgfSBmcm9tIFwiLi8uLi9qb2IvZmlsZUpvYlwiO1xyXG5pbXBvcnQgeyBFbnZpcm9ubWVudCB9IGZyb20gXCIuLi9lbnZpcm9ubWVudC9lbnZpcm9ubWVudFwiO1xyXG5pbXBvcnQge1MzRmlsZUpvYn0gZnJvbSBcIi4uL2pvYi9zM0ZpbGVKb2JcIjtcclxuXHJcbmNvbnN0ICAgQVdTID0gcmVxdWlyZShcImF3cy1zZGtcIiksXHJcbiAgICAgICAgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIiksXHJcbiAgICAgICAgYXN5bmMgPSByZXF1aXJlKFwiYXN5bmNcIiksXHJcbiAgICAgICAgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcblxyXG5leHBvcnQgY2xhc3MgUzNOZXN0IGV4dGVuZHMgTmVzdCB7XHJcblxyXG4gICAgcHJvdGVjdGVkIGNsaWVudDogYW55O1xyXG4gICAgcHJvdGVjdGVkIHMzOiBhbnk7XHJcbiAgICBwcm90ZWN0ZWQgYnVja2V0OiBzdHJpbmc7XHJcbiAgICBwcm90ZWN0ZWQga2V5UHJlZml4OiBzdHJpbmc7XHJcbiAgICBwcm90ZWN0ZWQgY2hlY2tFdmVyeTogbnVtYmVyO1xyXG4gICAgcHJvdGVjdGVkIGNoZWNrRXZlcnlNczogbnVtYmVyO1xyXG4gICAgcHJvdGVjdGVkIGFsbG93Q3JlYXRpb246IGJvb2xlYW47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb25zdHJ1Y3RvclxyXG4gICAgICogQHBhcmFtIGVcclxuICAgICAqIEBwYXJhbSBidWNrZXQgICAgICAgICAgICBBV1MgUzMgYnVja2V0IHRvIHdhdGNoLlxyXG4gICAgICogQHBhcmFtIGtleVByZWZpeCAgICAgICAgIE9wdGlvbmFsIGtleSBwcmVmaXggKHN1Yi1kaXJlY3RvcnkpIHRvIHdhdGNoLlxyXG4gICAgICogQHBhcmFtIGNoZWNrRXZlcnkgICAgICAgIEZyZXF1ZW5jeSBvZiBidWNrZXQgY2hlY2tpbmcsIGluIG1pbnV0ZXMuXHJcbiAgICAgKiBAcGFyYW0gYWxsb3dDcmVhdGlvbiAgICAgQ3JlYXRlIHRoZSBidWNrZXQ6cHJlZml4IGlmIGl0IGRvZXMgbm90IGV4aXN0LlxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBlOiBFbnZpcm9ubWVudCwgYnVja2V0OiBzdHJpbmcsIGtleVByZWZpeD86IHN0cmluZywgY2hlY2tFdmVyeTogbnVtYmVyID0gNSwgYWxsb3dDcmVhdGlvbjogYm9vbGVhbiA9IGZhbHNlXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcihlLCBcIkFuIFMzIGJ1Y2tldFwiKTtcclxuICAgICAgICBsZXQgc24gPSB0aGlzO1xyXG4gICAgICAgIHNuLnMzID0gbmV3IEFXUy5TMygpO1xyXG5cclxuICAgICAgICBzbi5idWNrZXQgPSBidWNrZXQ7XHJcbiAgICAgICAgc24ua2V5UHJlZml4ID0ga2V5UHJlZml4O1xyXG4gICAgICAgIHNuLmNoZWNrRXZlcnkgPSBjaGVja0V2ZXJ5O1xyXG4gICAgICAgIHNuLmNoZWNrRXZlcnlNcyA9IGNoZWNrRXZlcnkgKiA2MDAwMDtcclxuICAgICAgICBzbi5hbGxvd0NyZWF0aW9uID0gYWxsb3dDcmVhdGlvbjtcclxuXHJcbiAgICAgICAgc24udmVyaWZ5QnVja2V0KCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU2V0IGhhcmQtY29kZWQgQVdTIGNyZWRlbnRpYWxzLlxyXG4gICAgICogQHBhcmFtIGFjY2Vzc0tleUlkXHJcbiAgICAgKiBAcGFyYW0gc2VjcmV0QWNjZXNzS2V5XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXRDcmVkZW50aWFscyhhY2Nlc3NLZXlJZDogc3RyaW5nLCBzZWNyZXRBY2Nlc3NLZXk6IHN0cmluZykge1xyXG4gICAgICAgIEFXUy5jb25maWcudXBkYXRlKHthY2Nlc3NLZXlJZDogYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleTogc2VjcmV0QWNjZXNzS2V5fSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBWZXJpZnkgYnVja2V0IGFuZCBoYW5kbGUgY3JlYXRpb24gb2YgYnVja2V0IGlmIG5lZWQgYmUuXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCB2ZXJpZnlCdWNrZXQoKSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuICAgICAgICBzbi5oZWFkQnVja2V0KGhlYWRTdWNjZXNzID0+IHtcclxuICAgICAgICAgICAgaWYgKCFoZWFkU3VjY2Vzcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNuLmFsbG93Q3JlYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBzbi5jcmVhdGVCdWNrZXQoY3JlYXRlU3VjY2VzcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY3JlYXRlU3VjY2Vzcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMywgYEJ1Y2tldCBcIiR7c24uYnVja2V0fVwiIGNvdWxkIG5vdCBiZSBjcmVhdGVkLmAsIHNuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgQnVja2V0IFwiJHtzbi5idWNrZXR9XCIgZG9lcyBub3QgZXhpc3QgYW5kIGFsbG93Q3JlYXRpb24gaXMgc2V0IHRvIGZhbHNlLmAsIHNuKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVmVyaWZ5IHRoYXQgdGhlIGJ1Y2tldCBpcyBhdmFpbGFibGUgYW5kIGV4aXN0c1xyXG4gICAgICogQHBhcmFtIGNhbGxiYWNrXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBoZWFkQnVja2V0KGNhbGxiYWNrKSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuXHJcbiAgICAgICAgbGV0IHBhcmFtcyA9IHsgQnVja2V0OiBzbi5idWNrZXQgfTtcclxuXHJcbiAgICAgICAgc24uczMuaGVhZEJ1Y2tldChwYXJhbXMsIChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgc24uZS5sb2coMiwgYGhlYWRCdWNrZXQgZXJyb3I6ICR7ZXJyfWAsIHNuKTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIGlmIChfLmlzRW1wdHkoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICBzbi5lLmxvZygyLCBgaGVhZEJ1Y2tldCBlbXB0eSByZXNwb25zZWAsIHNuKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICBjYWxsYmFjayh0cnVlKTtcclxuICAgICAgICAgICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgc24uZS5sb2coMCwgYGhlYWRCdWNrZXQgc3VjY2VzczogJHtkYXRhfWAsIHNuKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICBjYWxsYmFjayh0cnVlKTtcclxuICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgIHNuLmUubG9nKDAsIGBCdWNrZXQgXCIke3NuLmJ1Y2tldH1cIiBpcyBhdmFpbGFibGUuYCwgc24pO1xyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY3JlYXRlQnVja2V0KGNhbGxiYWNrKSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuXHJcbiAgICAgICAgbGV0IHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgQnVja2V0OiBzbi5idWNrZXQsIC8qIHJlcXVpcmVkICovXHJcbiAgICAgICAgICAgIC8vIEFDTDogJ3ByaXZhdGUgfCBwdWJsaWMtcmVhZCB8IHB1YmxpYy1yZWFkLXdyaXRlIHwgYXV0aGVudGljYXRlZC1yZWFkJyxcclxuICAgICAgICAgICAgLy8gQ3JlYXRlQnVja2V0Q29uZmlndXJhdGlvbjoge1xyXG4gICAgICAgICAgICAvLyAgICAgTG9jYXRpb25Db25zdHJhaW50OiAnRVUgfCBldS13ZXN0LTEgfCB1cy13ZXN0LTEgfCB1cy13ZXN0LTIgfCBhcC1zb3V0aC0xIHwgYXAtc291dGhlYXN0LTEgfCBhcC1zb3V0aGVhc3QtMiB8IGFwLW5vcnRoZWFzdC0xIHwgc2EtZWFzdC0xIHwgY24tbm9ydGgtMSB8IGV1LWNlbnRyYWwtMSdcclxuICAgICAgICAgICAgLy8gfSxcclxuICAgICAgICAgICAgLy8gR3JhbnRGdWxsQ29udHJvbDogJ1NUUklOR19WQUxVRScsXHJcbiAgICAgICAgICAgIC8vIEdyYW50UmVhZDogJ1NUUklOR19WQUxVRScsXHJcbiAgICAgICAgICAgIC8vIEdyYW50UmVhZEFDUDogJ1NUUklOR19WQUxVRScsXHJcbiAgICAgICAgICAgIC8vIEdyYW50V3JpdGU6ICdTVFJJTkdfVkFMVUUnLFxyXG4gICAgICAgICAgICAvLyBHcmFudFdyaXRlQUNQOiAnU1RSSU5HX1ZBTFVFJ1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgc24uczMuY3JlYXRlQnVja2V0KHBhcmFtcywgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBjcmVhdGVCdWNrZXQgZXJyb3I6ICR7ZXJyfWAsIHNuKTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChfLmlzRW1wdHkoZGF0YSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzbi5lLmxvZygyLCBgY3JlYXRlQnVja2V0IGVtcHR5IHJlc3BvbnNlYCwgc24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMCwgYGNyZWF0ZUJ1Y2tldCBzdWNjZXNzOiAke2RhdGF9YCwgc24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsb2FkKCkge1xyXG4gICAgICAgIGxldCBzbiA9IHRoaXM7XHJcblxyXG4gICAgICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogc24uYnVja2V0LCAvKiByZXF1aXJlZCAqL1xyXG4gICAgICAgICAgICAvLyBDb250aW51YXRpb25Ub2tlbjogJ1NUUklOR19WQUxVRScsXHJcbiAgICAgICAgICAgIC8vIERlbGltaXRlcjogJ1NUUklOR19WQUxVRScsXHJcbiAgICAgICAgICAgIC8vIEVuY29kaW5nVHlwZTogJ3VybCcsXHJcbiAgICAgICAgICAgIC8vIEZldGNoT3duZXI6IHRydWUgfHwgZmFsc2UsXHJcbiAgICAgICAgICAgIC8vIE1heEtleXM6IDAsXHJcbiAgICAgICAgICAgIFByZWZpeDogc24ua2V5UHJlZml4XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgc24uczMubGlzdE9iamVjdHNWMihwYXJhbXMsIChlcnIsIGRhdGEpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgc24uZS5sb2coMywgYGxpc3RPYmplY3RzVjI6ICR7ZXJyfWAsIHNuKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxldCBjb250ZW50cyA9IGRhdGEuQ29udGVudHM7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gRG93bmxvYWQgZWFjaCBmaWxlIGZvdW5kXHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDAsIGBGb3VuZCAke2NvbnRlbnRzLmxlbmd0aH0gb2JqZWN0cyBpbiBcIiR7c24uYnVja2V0fS8ke3NuLmtleVByZWZpeH1cIi5gLCBzbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoY29udGVudHMsIChvYmplY3QsIGRvbmUpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0ZW1wIGZpbGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgc24uZS5sb2coMSwgYFMzIGZvdW5kIGZpbGUgXCIke29iamVjdC5LZXl9XCIuYCwgc24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgam9iID0gbmV3IFMzRmlsZUpvYihzbi5lLCBvYmplY3QuS2V5KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvd25sb2FkIGFuZCBwaXBlIHRvIGZpbGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmFtcyA9IHtCdWNrZXQ6IHNuLmJ1Y2tldCwgS2V5OiBvYmplY3QuS2V5fTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGUgPSByZXF1aXJlKFwiZnNcIikuY3JlYXRlV3JpdGVTdHJlYW0oam9iLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzbi5zMy5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShmaWxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDEsIGBEb3dubG9hZGluZyBcIiR7b2JqZWN0LktleX1cIi5gLCBzbik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlLm9uKFwiY2xvc2VcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVsZXRlIG9iamVjdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc24uZGVsZXRlT2JqZWN0KG9iamVjdC5LZXkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuLmFycml2ZShqb2IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0sIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDMsIGBBc3luYyBzZXJpZXMgZG93bmxvYWQgZXJyb3I6IFwiJHtlcnJ9XCIuYCwgc24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuLmUubG9nKDAsIGBDb21wbGV0ZWQgJHtjb250ZW50cy5sZW5ndGh9IHN5bmNocm9ub3VzIGRvd25sb2FkKHMpLmAsIHNuKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlcyBhbiBvYmplY3QgZnJvbSBhbiBTMyBidWNrZXQuXHJcbiAgICAgKiBAcGFyYW0ga2V5XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBkZWxldGVPYmplY3Qoa2V5KSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuICAgICAgICBsZXQgcGFyYW1zID0ge1xyXG4gICAgICAgICAgICBCdWNrZXQ6IHNuLmJ1Y2tldCwgLyogcmVxdWlyZWQgKi9cclxuICAgICAgICAgICAgS2V5OiBrZXkgLyogcmVxdWlyZWQgKi9cclxuICAgICAgICB9O1xyXG4gICAgICAgIHNuLnMzLmRlbGV0ZU9iamVjdChwYXJhbXMsIGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygzLCBgUzMgZGVsZXRlIG9iamVjdCBlcnJvciAke2Vycn1gLCBzbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBXYXRjaCBhbiBTMyBidWNrZXQuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyB3YXRjaCgpIHtcclxuICAgICAgICBsZXQgc24gPSB0aGlzO1xyXG5cclxuICAgICAgICBpZiAoc24uY2hlY2tFdmVyeSA9PT0gMCkge1xyXG4gICAgICAgICAgICBzbi5lLmxvZygzLCBcIkNhbm5vdCB3YXRjaCB0aGlzIGJ1Y2tldC4gQ2hlY2sgZXZlcnkgKG1pbnV0ZXMpIHNldCB0byAwLlwiLCBzbik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc24uZS5sb2coMSwgXCJXYXRjaGluZyBTMyBidWNrZXQuXCIsIHNuKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7XHJcblxyXG4gICAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGNvdW50Kys7XHJcbiAgICAgICAgICAgICAgICBzbi5lLmxvZygxLCBgUmUtY2hlY2tpbmcgUzMgYnVja2V0LCBhdHRlbXB0ICR7Y291bnR9LmAsIHNuKTtcclxuICAgICAgICAgICAgICAgIHNuLmxvYWQoKTtcclxuICAgICAgICAgICAgfSwgc24uY2hlY2tFdmVyeU1zLCBjb3VudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTmVzdCBhcnJpdmFsXHJcbiAgICAgKiBAcGFyYW0gam9iXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhcnJpdmUoam9iOiBGaWxlSm9iKSB7XHJcbiAgICAgICAgc3VwZXIuYXJyaXZlKGpvYik7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVcGxvYWQgYSBmaWxlIHRvIGFuIFMzIGJ1Y2tldC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIHRha2Uoam9iOiBGaWxlSm9iLCBjYWxsYmFjaz86IGFueSkge1xyXG4gICAgICAgIGxldCBzbiA9IHRoaXM7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICBzbi51cGxvYWRGaWxlKGpvYiwgKHMzSm9iOiBTM0ZpbGVKb2IpID0+IHtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHMzSm9iKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgc24uZS5sb2coMywgXCJUYWtlIHVwbG9hZCBlcnJvciwgXCIgKyBlLCBzbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGN1bGF0ZSB0aGUgcGVyY2VudCByZW1haW5pbmcgZnJvbSB0aGUgaHR0cFVwbG9hZFByb2dyZXNzIGV2ZW50IHZhbHVlcy5cclxuICAgICAqIEBwYXJhbSB0b3RhbFxyXG4gICAgICogQHBhcmFtIGxvYWRlZFxyXG4gICAgICogQHBhcmFtIHBhcnRcclxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY2FsY3VsYXRlUmVtYWluaW5nKHRvdGFsOiBudW1iZXIsIGxvYWRlZDogbnVtYmVyLCBwYXJ0PzogbnVtYmVyKSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuICAgICAgICBpZiAoIWlzTmFOKHRvdGFsKSAmJiAhaXNOYU4obG9hZGVkKSkge1xyXG4gICAgICAgICAgICBsZXQgcGVyY2VudFJlbWFpbmluZyA9IE1hdGgucm91bmQoKCBsb2FkZWQgLyB0b3RhbCkgKiAxMDApO1xyXG4gICAgICAgICAgICBpZiAoaXNOYU4ocGVyY2VudFJlbWFpbmluZykgfHwgcGVyY2VudFJlbWFpbmluZyA+IDEwMCkge1xyXG4gICAgICAgICAgICAgICAgc24uZS5sb2coMywgYEVycm9yIGNhbGN1bGF0aW5nIHBlcmNlbnQgcmVtYWluaW5nOiAke3BlcmNlbnRSZW1haW5pbmd9ICgke3R5cGVvZiBwZXJjZW50UmVtYWluaW5nfSksIHRvdGFsOiAke3RvdGFsfSwgbG9hZGVkOiAke2xvYWRlZH0uYCwgc24pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGVyY2VudFJlbWFpbmluZztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFVwbG9hZCBmaWxlIHRvIFMzXHJcbiAgICAgKiBAcGFyYW0gam9iIHtGaWxlSm9ifSAgICAgRmlsZUpvYiB0byBiZSB1cGxvYWRlZC5cclxuICAgICAqIEBwYXJhbSBjYWxsYmFjayAgICAgICAgICBDYWxsYmFjayBpbmNsdWRlcyB0aGUgUzNGaWxlSm9iIHBhcmFtZXRlci5cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIHVwbG9hZEZpbGUoam9iOiBGaWxlSm9iLCBjYWxsYmFjazogYW55KSB7XHJcbiAgICAgICAgbGV0IHNuID0gdGhpcztcclxuICAgICAgICBsZXQgYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oam9iLnBhdGgpO1xyXG4gICAgICAgIGxldCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgIEJ1Y2tldDogc24uYnVja2V0LFxyXG4gICAgICAgICAgICBLZXk6IHNuLmtleVByZWZpeCArIGpvYi5uYW1lLFxyXG4gICAgICAgICAgICBCb2R5OiBib2R5LFxyXG4gICAgICAgICAgICBBQ0w6IFwicHVibGljLXJlYWRcIlxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHBlcmNlbnRVcGxvYWRlZCA9IDA7XHJcbiAgICAgICAgc24uczMudXBsb2FkKHBhcmFtcykuXHJcbiAgICAgICAgb24oXCJodHRwVXBsb2FkUHJvZ3Jlc3NcIiwgZnVuY3Rpb24oZXZ0KSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiZXZ0XCIsIGV2dCk7XHJcbiAgICAgICAgICAgIHBlcmNlbnRVcGxvYWRlZCA9IHNuLmNhbGN1bGF0ZVJlbWFpbmluZyhldnQudG90YWwsIGV2dC5sb2FkZWQsIGV2dC5wYXJ0KTtcclxuICAgICAgICAgICAgc24uZS5sb2coMCwgYFVwbG9hZGluZyBcIiR7ZXZ0LmtleX1cIiAtICR7cGVyY2VudFVwbG9hZGVkfSVgLCBzbik7XHJcbiAgICAgICAgfSkuXHJcbiAgICAgICAgc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgc24uZS5sb2coMywgYFMzIHVwbG9hZCBlcnJvcjogJHtlcnJ9YCwgc24pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBDaGFuZ2Ugam9iIHR5cGUgdG8gYSBTM0ZpbGVKb2JcclxuICAgICAgICAgICAgbGV0IHMzSm9iID0gam9iIGFzIFMzRmlsZUpvYjtcclxuICAgICAgICAgICAgczNKb2IubG9jYWxseUF2YWlsYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICBzM0pvYi5wYXRoID0gZGF0YS5Mb2NhdGlvbjtcclxuICAgICAgICAgICAgczNKb2IuYnVja2V0ID0gZGF0YS5CdWNrZXQ7XHJcbiAgICAgICAgICAgIHMzSm9iLmtleSA9IGRhdGEuS2V5O1xyXG4gICAgICAgICAgICBzM0pvYi5lVGFnID0gZGF0YS5FVGFnO1xyXG5cclxuICAgICAgICAgICAgY2FsbGJhY2soczNKb2IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxufSJdfQ==
