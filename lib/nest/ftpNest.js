"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var nest_1 = require("./nest");
var ftpFileJob_1 = require("./../job/ftpFileJob");
var EasyFtp = require("easy-ftp"), tmp = require("tmp"), fs = require("fs"), async = require("async");
var FtpNest = (function (_super) {
    __extends(FtpNest, _super);
    function FtpNest(e, host, port, username, password, checkEvery) {
        _super.call(this, e, host);
        this.config = {
            host: host,
            port: port,
            username: username,
            password: password
        };
        this.checkEvery = checkEvery;
        this.checkEveryMs = this.checkEvery * 60000;
    }
    FtpNest.prototype.getClient = function () {
        return new EasyFtp();
    };
    FtpNest.prototype.load = function () {
        var ftp = this;
        try {
            var ftp_client_1 = ftp.getClient();
            ftp_client_1.connect(ftp.config);
            ftp_client_1.ls("/", function (err, list) {
                if (err) {
                    ftp_client_1.close();
                }
                ftp.e.log(1, "FTP ls found " + list.length + " files.", ftp);
                async.eachSeries(list, function (file, done) {
                    // Create temp file
                    ftp.e.log(1, "FTP found file \"" + file.name + "\".", ftp);
                    var job = new ftpFileJob_1.FtpFileJob(ftp.e, file.name);
                    // Download to the temp job location
                    ftp_client_1.download(file.name, job.getPath(), function (err) {
                        if (err) {
                            ftp.e.log(3, "Download error: \"" + err + "\".", ftp);
                            done();
                        }
                        else {
                            job.setLocallyAvailable(true);
                            // Delete on success
                            ftp_client_1.rm(file.name, function (err) {
                                if (err) {
                                    ftp.e.log(3, "Remove error: \"" + err + "\".", ftp);
                                }
                                ftp.arrive(job);
                                done();
                            });
                        }
                    });
                }, function (err) {
                    if (err) {
                        ftp.e.log(3, "Async series download error: \"" + err + "\".", ftp);
                    }
                    ftp.e.log(0, "Completed " + list.length + " synchronous download(s).", ftp);
                    ftp_client_1.close();
                });
                //
                // list.forEach(function (file, index) {
                //
                // });
            });
        }
        catch (e) {
            ftp.e.log(3, e, ftp);
        }
    };
    FtpNest.prototype.watch = function () {
        var ftp = this;
        ftp.e.log(1, "Watching FTP directory.", ftp);
        var count = 0;
        setInterval(function () {
            count++;
            ftp.e.log(1, "Re-checking FTP, attempt " + count + ".", ftp);
            ftp.load();
        }, ftp.checkEveryMs, count);
    };
    FtpNest.prototype.arrive = function (job) {
        _super.prototype.arrive.call(this, job);
    };
    FtpNest.prototype.take = function (job, callback) {
        var ftp = this;
        try {
            var ftp_path = "/" + job.name;
            var ftp_client_2 = ftp.getClient();
            ftp_client_2.connect(ftp.config);
            ftp_client_2.upload(job.getPath(), ftp_path, function (err) {
                if (err) {
                    ftp.e.log(3, "Error uploading " + job.name + " to FTP.", ftp);
                }
                fs.unlinkSync(job.getPath());
                ftp_client_2.close();
                var ftpJob = job;
                ftpJob.setLocallyAvailable(false);
                callback(ftpJob);
            });
        }
        catch (e) {
            ftp.e.log(3, "Take upload error, " + e, ftp);
        }
    };
    return FtpNest;
}(nest_1.Nest));
exports.FtpNest = FtpNest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVCxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUscUJBQXFCLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDTCxDQUFDO0lBRUwsY0FBQztBQUFELENBaklBLEFBaUlDLENBakk0QixXQUFJLEdBaUloQztBQWpJWSxlQUFPLFVBaUluQixDQUFBIiwiZmlsZSI6ImxpYi9uZXN0L2Z0cE5lc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZXN0IH0gZnJvbSBcIi4vbmVzdFwiO1xuaW1wb3J0IHsgRmlsZUpvYiB9IGZyb20gXCIuLy4uL2pvYi9maWxlSm9iXCI7XG5pbXBvcnQgeyBGdHBGaWxlSm9iIH0gZnJvbSBcIi4vLi4vam9iL2Z0cEZpbGVKb2JcIjtcblxuY29uc3QgICBFYXN5RnRwID0gcmVxdWlyZShcImVhc3ktZnRwXCIpLFxuICAgICAgICB0bXAgPSByZXF1aXJlKFwidG1wXCIpLFxuICAgICAgICBmcyA9IHJlcXVpcmUoXCJmc1wiKSxcbiAgICAgICAgYXN5bmMgPSByZXF1aXJlKFwiYXN5bmNcIik7XG5cbmltcG9ydCB7RW52aXJvbm1lbnR9IGZyb20gXCIuLi9lbnZpcm9ubWVudC9lbnZpcm9ubWVudFwiO1xuXG5leHBvcnQgY2xhc3MgRnRwTmVzdCBleHRlbmRzIE5lc3Qge1xuXG4gICAgcHJvdGVjdGVkIGNsaWVudDogYW55O1xuICAgIHByb3RlY3RlZCBjb25maWc6IHt9O1xuICAgIHByb3RlY3RlZCBjaGVja0V2ZXJ5OiBudW1iZXI7XG4gICAgcHJvdGVjdGVkIGNoZWNrRXZlcnlNczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoZTogRW52aXJvbm1lbnQsIGhvc3Q6IHN0cmluZywgcG9ydDogbnVtYmVyLCB1c2VybmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBjaGVja0V2ZXJ5OiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoZSwgaG9zdCk7XG5cbiAgICAgICAgdGhpcy5jb25maWcgPSB7XG4gICAgICAgICAgICBob3N0OiBob3N0LFxuICAgICAgICAgICAgcG9ydDogcG9ydCxcbiAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VybmFtZSxcbiAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuY2hlY2tFdmVyeSA9IGNoZWNrRXZlcnk7XG5cbiAgICAgICAgdGhpcy5jaGVja0V2ZXJ5TXMgPSB0aGlzLmNoZWNrRXZlcnkgKiA2MDAwMDtcblxuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRDbGllbnQoKSB7XG4gICAgICAgIHJldHVybiBuZXcgRWFzeUZ0cCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkKCkge1xuXG4gICAgICAgIGxldCBmdHAgPSB0aGlzO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgZnRwX2NsaWVudCA9IGZ0cC5nZXRDbGllbnQoKTtcbiAgICAgICAgICAgIGZ0cF9jbGllbnQuY29ubmVjdChmdHAuY29uZmlnKTtcblxuICAgICAgICAgICAgZnRwX2NsaWVudC5scyhcIi9cIiwgZnVuY3Rpb24oZXJyLCBsaXN0KSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZ0cF9jbGllbnQuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdHAuZS5sb2coMSwgYEZUUCBscyBmb3VuZCAke2xpc3QubGVuZ3RofSBmaWxlcy5gLCBmdHApO1xuXG5cbiAgICAgICAgICAgICAgICBhc3luYy5lYWNoU2VyaWVzKGxpc3QsIGZ1bmN0aW9uIChmaWxlLCBkb25lKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSB0ZW1wIGZpbGVcbiAgICAgICAgICAgICAgICAgICAgZnRwLmUubG9nKDEsIGBGVFAgZm91bmQgZmlsZSBcIiR7ZmlsZS5uYW1lfVwiLmAsIGZ0cCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBqb2IgPSBuZXcgRnRwRmlsZUpvYihmdHAuZSwgZmlsZS5uYW1lKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBEb3dubG9hZCB0byB0aGUgdGVtcCBqb2IgbG9jYXRpb25cbiAgICAgICAgICAgICAgICAgICAgZnRwX2NsaWVudC5kb3dubG9hZChmaWxlLm5hbWUsIGpvYi5nZXRQYXRoKCksIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdHAuZS5sb2coMywgYERvd25sb2FkIGVycm9yOiBcIiR7ZXJyfVwiLmAsIGZ0cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2Iuc2V0TG9jYWxseUF2YWlsYWJsZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGUgb24gc3VjY2Vzc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0cF9jbGllbnQucm0oZmlsZS5uYW1lLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0cC5lLmxvZygzLCBgUmVtb3ZlIGVycm9yOiBcIiR7ZXJyfVwiLmAsIGZ0cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRwLmFycml2ZShqb2IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnRwLmUubG9nKDMsIGBBc3luYyBzZXJpZXMgZG93bmxvYWQgZXJyb3I6IFwiJHtlcnJ9XCIuYCwgZnRwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmdHAuZS5sb2coMCwgYENvbXBsZXRlZCAke2xpc3QubGVuZ3RofSBzeW5jaHJvbm91cyBkb3dubG9hZChzKS5gLCBmdHApO1xuICAgICAgICAgICAgICAgICAgICBmdHBfY2xpZW50LmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyBsaXN0LmZvckVhY2goZnVuY3Rpb24gKGZpbGUsIGluZGV4KSB7XG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBmdHAuZS5sb2coMywgZSwgZnRwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB3YXRjaCgpIHtcbiAgICAgICAgbGV0IGZ0cCA9IHRoaXM7XG5cbiAgICAgICAgZnRwLmUubG9nKDEsIFwiV2F0Y2hpbmcgRlRQIGRpcmVjdG9yeS5cIiwgZnRwKTtcblxuICAgICAgICBsZXQgY291bnQgPSAwO1xuXG4gICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgIGZ0cC5lLmxvZygxLCBgUmUtY2hlY2tpbmcgRlRQLCBhdHRlbXB0ICR7Y291bnR9LmAsIGZ0cCk7XG4gICAgICAgICAgICBmdHAubG9hZCgpO1xuICAgICAgICB9LCBmdHAuY2hlY2tFdmVyeU1zLCBjb3VudCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFycml2ZShqb2I6IEZpbGVKb2IpIHtcbiAgICAgICAgc3VwZXIuYXJyaXZlKGpvYik7XG4gICAgfVxuXG4gICAgcHVibGljIHRha2Uoam9iOiBGaWxlSm9iLCBjYWxsYmFjazogYW55KSB7XG4gICAgICAgIGxldCBmdHAgPSB0aGlzO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgZnRwX3BhdGggPSBgLyR7am9iLm5hbWV9YDtcblxuICAgICAgICAgICAgbGV0IGZ0cF9jbGllbnQgPSBmdHAuZ2V0Q2xpZW50KCk7XG5cbiAgICAgICAgICAgIGZ0cF9jbGllbnQuY29ubmVjdChmdHAuY29uZmlnKTtcblxuICAgICAgICAgICAgZnRwX2NsaWVudC51cGxvYWQoam9iLmdldFBhdGgoKSwgZnRwX3BhdGgsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZ0cC5lLmxvZygzLCBgRXJyb3IgdXBsb2FkaW5nICR7am9iLm5hbWV9IHRvIEZUUC5gLCBmdHApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoam9iLmdldFBhdGgoKSk7XG4gICAgICAgICAgICAgICAgZnRwX2NsaWVudC5jbG9zZSgpO1xuXG4gICAgICAgICAgICAgICAgbGV0IGZ0cEpvYiA9IGpvYiBhcyBGdHBGaWxlSm9iO1xuICAgICAgICAgICAgICAgIGZ0cEpvYi5zZXRMb2NhbGx5QXZhaWxhYmxlKGZhbHNlKTtcblxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZ0cEpvYik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgZnRwLmUubG9nKDMsIFwiVGFrZSB1cGxvYWQgZXJyb3IsIFwiICsgZSwgZnRwKTtcbiAgICAgICAgfVxuICAgIH1cblxufSJdfQ==
