"use strict";
var webhookJob_1 = require("../job/webhookJob");
var express = require("express");
var cors = require("cors"), multer = require("multer"), path = require("path"), tmp = require("tmp"), async = require("async");
/**
 * Webhook and logging server.
 */
var Server = (function () {
    function Server(e) {
        this.hookRoutes = [];
        this.hookInterfaceRoutes = [];
        this.config = {
            hooks_prefix: "/hooks",
            hooks_ui_prefix: "/hooks-ui",
            log_prefix: "/log"
        };
        /**
         * Handles request and response of the web hook interface.
         * @param im {InterfaceManager}
         * @param req {express.Request}
         * @param res {express.Response}
         * @param customHandler             Custom request handler.
         */
        this.handleHookInterfaceRequest = function (im, req, res, customHandler) {
            var s = this;
            // Job arrive
            var job = new webhookJob_1.WebhookJob(s.e, req, res);
            // Fill in default values
            var params = job.getQueryStringValues();
            // If session not set, return a fresh ui somehow
            var sessionId = params["sessionId"] || job.getFormDataValue("sessionId");
            var ui = im.getInterface(sessionId);
            if (ui.getSessionId() === sessionId) {
                // Fill in default values
                var fields = ui.getFields();
                fields.forEach(function (field) {
                    if (field.id in params && params[field.id] !== "undefined") {
                        field.value = params[field.id];
                    }
                });
                // Do steps
                async.each(ui.getSteps(), function (step, cb) {
                    s.e.log(0, "Running UI step \"" + step.name + "\".", s);
                    step.callback(job, ui, step, function () {
                        cb();
                    });
                }, function (err) {
                    if (err) {
                        s.e.log(3, "Error running UI steps. " + err, s);
                    }
                    else {
                        s.e.log(0, "Done running all UI steps.", s);
                    }
                    if (customHandler) {
                        customHandler(req, res, ui);
                    }
                    else {
                        res.json(ui.getTransportInterface());
                    }
                });
            }
            else {
                if (customHandler) {
                    customHandler(req, res, ui);
                }
                else {
                    res.json(ui.getTransportInterface());
                }
            }
        };
        this.e = e;
        this.server = express();
        this.createServer();
        // let tmpDir = tmp.dirSync()._name;
        var tmpDir = "./example";
        this.upload = multer({
            destination: tmpDir,
            storage: multer.diskStorage({
                filename: function (req, file, cb) {
                    cb(null, file.fieldname + "-" + Date.now());
                }
            })
        });
    }
    /**
     * Creates the server.
     */
    Server.prototype.createServer = function () {
        var s = this;
        var port = s.e.getOptions().port;
        s.server.use(cors());
        // Add index routes
        s.server.get(s.config.hooks_prefix, function (req, res) {
            res.json(s.hookRoutes);
        });
        s.server.get(s.config.hooks_ui_prefix, function (req, res) {
            res.json(s.hookInterfaceRoutes);
        });
        // Prevent duplicate listening for tests
        // if (!module.parent) {
        //     s.server.listen(port, () => s.e.log(1, `Server up and listening on port ${port}.`, s));
        // }
        s.server.listen(port, function () { return s.e.log(1, "Server up and listening on port " + port + ".", s); });
    };
    Server.prototype.createLogServer = function (logger) {
        var s = this;
        var options = {
            order: "desc",
            fields: ["message"]
        };
        // Add index routes
        s.server.get(s.config.log_prefix, function (req, res) {
            logger.query(options, function (results) {
                res.json(results);
            });
        });
    };
    /**
     * Log _name
     * @returns {string}
     */
    Server.prototype.toString = function () {
        return "Server";
    };
    /**
     * Adds a webhook to the server.
     * @param nest {WebhookNest}
     */
    Server.prototype.addWebhook = function (nest) {
        var s = this;
        var e = s.e;
        var httpMethod = nest.getHttpMethod();
        var hook_path = s.config.hooks_prefix + nest.getPath();
        var hook_ui_path;
        var im = nest.getInterfaceManager();
        var wi = im.getInterface();
        hook_ui_path = s.config.hooks_ui_prefix + im.getPath();
        s.e.log(1, "Watching webhook " + httpMethod.toUpperCase() + " " + hook_path, s);
        s.hookRoutes.push({
            id: nest.getId(),
            path: hook_path,
            nest: nest.name,
            tunnel: nest.getTunnel().name,
            method: httpMethod,
            interface_path: hook_ui_path
        });
        s.server[httpMethod](hook_path, s.upload.any(), function (req, res) {
            var customHandler = nest.getCustomHandleRequest();
            s.handleHookRequest(nest, req, res, customHandler);
        });
    };
    /**
     * Handles request and response of the web hook, creates a new job, as well as calling the nest's arrive.
     * @param nest {WebhookNest}
     * @param req {express.Request}
     * @param res {express.Response}
     * @param customHandler     Custom request handler.
     */
    Server.prototype.handleHookRequest = function (nest, req, res, customHandler) {
        var s = this;
        // Job arrive
        var job = new webhookJob_1.WebhookJob(s.e, req, res);
        nest.arrive(job);
        s.sendHookResponse(nest.holdResponse, job, nest, req, res, customHandler);
    };
    ;
    /**
     * Sends the actual hook response.
     * @param holdResponse      Flag to bypass sending now for held responses.
     * @param job               Webhook job
     * @param nest              Webhook nest
     * @param req
     * @param res
     * @param customHandler
     * @param message
     */
    Server.prototype.sendHookResponse = function (holdResponse, job, nest, req, res, customHandler, message) {
        if (holdResponse === true) {
        }
        else if (customHandler) {
            job.responseSent = true;
            customHandler(req, res, job, nest);
        }
        else {
            job.responseSent = true;
            var response = {
                message: message || "Job " + job.getId() + " was created!",
                job: {
                    id: job.getId(),
                    name: job.name
                },
                nest: {
                    name: nest.name
                }
            };
            res.json(response);
        }
    };
    /**
     * Adds a webhook interface to the webhook server.
     * @param im {InterfaceManager}
     */
    Server.prototype.addWebhookInterface = function (im) {
        var s = this;
        var nest = im.getNest();
        var hook_path = s.config.hooks_prefix + nest.getPath();
        var hook_ui_path = s.config.hooks_ui_prefix + im.getPath();
        s.e.log(1, "Watching webhook interface GET " + hook_ui_path, s);
        this.hookInterfaceRoutes.push({
            id: nest.getId(),
            path: hook_ui_path,
            nest: nest.name,
            target: hook_path
        });
        s.server.get(hook_ui_path, function (req, res) {
            var customHandler = im.getCustomHandleRequest();
            s.handleHookInterfaceRequest(im, req, res, customHandler);
        });
    };
    return Server;
}());
exports.Server = Server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lbnZpcm9ubWVudC9zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLDJCQUF5QixtQkFBbUIsQ0FBQyxDQUFBO0FBQzdDLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBSW5DLElBQVEsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFDMUIsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFDcEIsS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUVqQzs7R0FFRztBQUNIO0lBY0ksZ0JBQVksQ0FBYztRQVZoQixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLHdCQUFtQixHQUFHLEVBQUUsQ0FBQztRQUd6QixXQUFNLEdBQUc7WUFDZixZQUFZLEVBQUUsUUFBUTtZQUN0QixlQUFlLEVBQUUsV0FBVztZQUM1QixVQUFVLEVBQUUsTUFBTTtTQUNyQixDQUFDO1FBeUxGOzs7Ozs7V0FNRztRQUNPLCtCQUEwQixHQUFHLFVBQVMsRUFBb0IsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLGFBQW1CO1lBQy9GLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUViLGFBQWE7WUFDYixJQUFJLEdBQUcsR0FBRyxJQUFJLHVCQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFeEMseUJBQXlCO1lBQ3pCLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBRXhDLGdEQUFnRDtZQUNoRCxJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXpFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENB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QzFCLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2hCLElBQUksRUFBRSxZQUFZO1lBQ2xCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLE1BQU0sRUFBRSxTQUFTO1NBRXBCLENBQUMsQ0FBQztRQUVILENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRyxVQUFVLEdBQUcsRUFBRSxHQUFHO1lBRTFDLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBRWhELENBQUMsQ0FBQywwQkFBMEIsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5RCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUE2REwsYUFBQztBQUFELENBaFFBLEFBZ1FDLElBQUE7QUFoUVksY0FBTSxTQWdRbEIsQ0FBQSIsImZpbGUiOiJsaWIvZW52aXJvbm1lbnQvc2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFbnZpcm9ubWVudH0gZnJvbSBcIi4vZW52aXJvbm1lbnRcIjtcbmltcG9ydCB7V2ViaG9va05lc3R9IGZyb20gXCIuLi9uZXN0L3dlYmhvb2tOZXN0XCI7XG5pbXBvcnQge1dlYmhvb2tKb2J9IGZyb20gXCIuLi9qb2Ivd2ViaG9va0pvYlwiO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0IHtJbnRlcmZhY2VNYW5hZ2VyfSBmcm9tIFwiLi4vdWkvaW50ZXJmYWNlTWFuYWdlclwiO1xuaW1wb3J0IHtMb2dnZXIsIExvZ1F1ZXJ5T3B0aW9uc30gZnJvbSBcIi4vbG9nZ2VyXCI7XG5cbmNvbnN0ICAgY29ycyA9IHJlcXVpcmUoXCJjb3JzXCIpLFxuICAgICAgICBtdWx0ZXIgPSByZXF1aXJlKFwibXVsdGVyXCIpLFxuICAgICAgICBwYXRoID0gcmVxdWlyZShcInBhdGhcIiksXG4gICAgICAgIHRtcCA9IHJlcXVpcmUoXCJ0bXBcIiksXG4gICAgICAgIGFzeW5jID0gcmVxdWlyZShcImFzeW5jXCIpO1xuXG4vKipcbiAqIFdlYmhvb2sgYW5kIGxvZ2dpbmcgc2VydmVyLlxuICovXG5leHBvcnQgY2xhc3MgU2VydmVyIHtcblxuICAgIHByb3RlY3RlZCBzZXJ2ZXI6IGV4cHJlc3MuQXBwbGljYXRpb247XG4gICAgcHJvdGVjdGVkIGU6IEVudmlyb25tZW50O1xuICAgIHByb3RlY3RlZCBob29rUm91dGVzID0gW107XG4gICAgcHJvdGVjdGVkIGhvb2tJbnRlcmZhY2VSb3V0ZXMgPSBbXTtcbiAgICBwcm90ZWN0ZWQgdXBsb2FkO1xuXG4gICAgcHJvdGVjdGVkIGNvbmZpZyA9IHtcbiAgICAgICAgaG9va3NfcHJlZml4OiBcIi9ob29rc1wiLFxuICAgICAgICBob29rc191aV9wcmVmaXg6IFwiL2hvb2tzLXVpXCIsXG4gICAgICAgIGxvZ19wcmVmaXg6IFwiL2xvZ1wiXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKGU6IEVudmlyb25tZW50KSB7XG4gICAgICAgIHRoaXMuZSA9IGU7XG4gICAgICAgIHRoaXMuc2VydmVyID0gZXhwcmVzcygpO1xuICAgICAgICB0aGlzLmNyZWF0ZVNlcnZlcigpO1xuXG4gICAgICAgIC8vIGxldCB0bXBEaXIgPSB0bXAuZGlyU3luYygpLl9uYW1lO1xuICAgICAgICBsZXQgdG1wRGlyID0gXCIuL2V4YW1wbGVcIjtcblxuICAgICAgICB0aGlzLnVwbG9hZCA9IG11bHRlcih7XG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb246IHRtcERpcixcbiAgICAgICAgICAgICAgICBzdG9yYWdlOiBtdWx0ZXIuZGlza1N0b3JhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBmaWxlbmFtZTogZnVuY3Rpb24gKHJlcSwgZmlsZSwgY2IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGZpbGUuZmllbGRuYW1lICsgXCItXCIgKyBEYXRlLm5vdygpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIHRoZSBzZXJ2ZXIuXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVNlcnZlcigpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuXG4gICAgICAgIGxldCBwb3J0ID0gcy5lLmdldE9wdGlvbnMoKS5wb3J0O1xuXG4gICAgICAgIHMuc2VydmVyLnVzZShjb3JzKCkpO1xuXG4gICAgICAgIC8vIEFkZCBpbmRleCByb3V0ZXNcbiAgICAgICAgcy5zZXJ2ZXIuZ2V0KHMuY29uZmlnLmhvb2tzX3ByZWZpeCwgZnVuY3Rpb24ocmVxLCByZXMpe1xuICAgICAgICAgICAgcmVzLmpzb24ocy5ob29rUm91dGVzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHMuc2VydmVyLmdldChzLmNvbmZpZy5ob29rc191aV9wcmVmaXgsIGZ1bmN0aW9uKHJlcSwgcmVzKXtcbiAgICAgICAgICAgIHJlcy5qc29uKHMuaG9va0ludGVyZmFjZVJvdXRlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFByZXZlbnQgZHVwbGljYXRlIGxpc3RlbmluZyBmb3IgdGVzdHNcbiAgICAgICAgLy8gaWYgKCFtb2R1bGUucGFyZW50KSB7XG4gICAgICAgIC8vICAgICBzLnNlcnZlci5saXN0ZW4ocG9ydCwgKCkgPT4gcy5lLmxvZygxLCBgU2VydmVyIHVwIGFuZCBsaXN0ZW5pbmcgb24gcG9ydCAke3BvcnR9LmAsIHMpKTtcbiAgICAgICAgLy8gfVxuICAgICAgICBzLnNlcnZlci5saXN0ZW4ocG9ydCwgKCkgPT4gcy5lLmxvZygxLCBgU2VydmVyIHVwIGFuZCBsaXN0ZW5pbmcgb24gcG9ydCAke3BvcnR9LmAsIHMpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlTG9nU2VydmVyKGxvZ2dlcjogTG9nZ2VyKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcblxuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG9yZGVyOiBcImRlc2NcIixcbiAgICAgICAgICAgIGZpZWxkczogW1wibWVzc2FnZVwiXVxuICAgICAgICB9IGFzIExvZ1F1ZXJ5T3B0aW9ucztcblxuICAgICAgICAvLyBBZGQgaW5kZXggcm91dGVzXG4gICAgICAgIHMuc2VydmVyLmdldChzLmNvbmZpZy5sb2dfcHJlZml4LCAocmVxLCByZXMpID0+IHtcblxuICAgICAgICAgICAgbG9nZ2VyLnF1ZXJ5KG9wdGlvbnMsIHJlc3VsdHMgPT4ge1xuICAgICAgICAgICAgICAgIHJlcy5qc29uKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9nIF9uYW1lXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBcIlNlcnZlclwiO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSB3ZWJob29rIHRvIHRoZSBzZXJ2ZXIuXG4gICAgICogQHBhcmFtIG5lc3Qge1dlYmhvb2tOZXN0fVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRXZWJob29rKG5lc3Q6IFdlYmhvb2tOZXN0KSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IGUgPSBzLmU7XG5cbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBuZXN0LmdldEh0dHBNZXRob2QoKTtcbiAgICAgICAgbGV0IGhvb2tfcGF0aCA9IHMuY29uZmlnLmhvb2tzX3ByZWZpeCArIG5lc3QuZ2V0UGF0aCgpO1xuICAgICAgICBsZXQgaG9va191aV9wYXRoO1xuICAgICAgICBsZXQgaW0gPSBuZXN0LmdldEludGVyZmFjZU1hbmFnZXIoKTtcblxuICAgICAgICBsZXQgd2kgPSBpbS5nZXRJbnRlcmZhY2UoKTtcbiAgICAgICAgaG9va191aV9wYXRoID0gcy5jb25maWcuaG9va3NfdWlfcHJlZml4ICsgaW0uZ2V0UGF0aCgpO1xuXG4gICAgICAgIHMuZS5sb2coMSwgYFdhdGNoaW5nIHdlYmhvb2sgJHtodHRwTWV0aG9kLnRvVXBwZXJDYXNlKCl9ICR7aG9va19wYXRofWAsIHMpO1xuXG4gICAgICAgIHMuaG9va1JvdXRlcy5wdXNoKHtcbiAgICAgICAgICAgIGlkOiBuZXN0LmdldElkKCksXG4gICAgICAgICAgICBwYXRoOiBob29rX3BhdGgsXG4gICAgICAgICAgICBuZXN0OiBuZXN0Lm5hbWUsXG4gICAgICAgICAgICB0dW5uZWw6IG5lc3QuZ2V0VHVubmVsKCkubmFtZSxcbiAgICAgICAgICAgIG1ldGhvZDogaHR0cE1ldGhvZCxcbiAgICAgICAgICAgIGludGVyZmFjZV9wYXRoOiBob29rX3VpX3BhdGhcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcy5zZXJ2ZXJbaHR0cE1ldGhvZF0oaG9va19wYXRoLCBzLnVwbG9hZC5hbnkoKSwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG5cbiAgICAgICAgICAgIGxldCBjdXN0b21IYW5kbGVyID0gbmVzdC5nZXRDdXN0b21IYW5kbGVSZXF1ZXN0KCk7XG5cbiAgICAgICAgICAgICBzLmhhbmRsZUhvb2tSZXF1ZXN0KG5lc3QsIHJlcSwgcmVzLCBjdXN0b21IYW5kbGVyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyByZXF1ZXN0IGFuZCByZXNwb25zZSBvZiB0aGUgd2ViIGhvb2ssIGNyZWF0ZXMgYSBuZXcgam9iLCBhcyB3ZWxsIGFzIGNhbGxpbmcgdGhlIG5lc3QncyBhcnJpdmUuXG4gICAgICogQHBhcmFtIG5lc3Qge1dlYmhvb2tOZXN0fVxuICAgICAqIEBwYXJhbSByZXEge2V4cHJlc3MuUmVxdWVzdH1cbiAgICAgKiBAcGFyYW0gcmVzIHtleHByZXNzLlJlc3BvbnNlfVxuICAgICAqIEBwYXJhbSBjdXN0b21IYW5kbGVyICAgICBDdXN0b20gcmVxdWVzdCBoYW5kbGVyLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCBoYW5kbGVIb29rUmVxdWVzdCAobmVzdDogV2ViaG9va05lc3QsIHJlcSwgcmVzLCBjdXN0b21IYW5kbGVyPzogYW55KSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcblxuICAgICAgICAvLyBKb2IgYXJyaXZlXG4gICAgICAgIGxldCBqb2IgPSBuZXcgV2ViaG9va0pvYihzLmUsIHJlcSwgcmVzKTtcbiAgICAgICAgbmVzdC5hcnJpdmUoam9iKTtcblxuICAgICAgICBzLnNlbmRIb29rUmVzcG9uc2UobmVzdC5ob2xkUmVzcG9uc2UsIGpvYiwgbmVzdCwgcmVxLCByZXMsIGN1c3RvbUhhbmRsZXIpO1xuXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFNlbmRzIHRoZSBhY3R1YWwgaG9vayByZXNwb25zZS5cbiAgICAgKiBAcGFyYW0gaG9sZFJlc3BvbnNlICAgICAgRmxhZyB0byBieXBhc3Mgc2VuZGluZyBub3cgZm9yIGhlbGQgcmVzcG9uc2VzLlxuICAgICAqIEBwYXJhbSBqb2IgICAgICAgICAgICAgICBXZWJob29rIGpvYlxuICAgICAqIEBwYXJhbSBuZXN0ICAgICAgICAgICAgICBXZWJob29rIG5lc3RcbiAgICAgKiBAcGFyYW0gcmVxXG4gICAgICogQHBhcmFtIHJlc1xuICAgICAqIEBwYXJhbSBjdXN0b21IYW5kbGVyXG4gICAgICogQHBhcmFtIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBwdWJsaWMgc2VuZEhvb2tSZXNwb25zZSAoaG9sZFJlc3BvbnNlOiBib29sZWFuLCBqb2I6IFdlYmhvb2tKb2IsIG5lc3Q6IFdlYmhvb2tOZXN0LCByZXEsIHJlcywgY3VzdG9tSGFuZGxlcj86IGFueSwgbWVzc2FnZT86IHN0cmluZykge1xuICAgICAgICBpZiAoaG9sZFJlc3BvbnNlID09PSB0cnVlKSB7XG4gICAgICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICAgIH0gZWxzZSBpZiAoY3VzdG9tSGFuZGxlcikge1xuICAgICAgICAgICAgam9iLnJlc3BvbnNlU2VudCA9IHRydWU7XG4gICAgICAgICAgICBjdXN0b21IYW5kbGVyKHJlcSwgcmVzLCBqb2IsIG5lc3QpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgam9iLnJlc3BvbnNlU2VudCA9IHRydWU7XG4gICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSB8fCBgSm9iICR7am9iLmdldElkKCl9IHdhcyBjcmVhdGVkIWAsXG4gICAgICAgICAgICAgICAgam9iOiB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBqb2IuZ2V0SWQoKSxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogam9iLm5hbWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG5lc3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmVzdC5uYW1lXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJlcy5qc29uKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSB3ZWJob29rIGludGVyZmFjZSB0byB0aGUgd2ViaG9vayBzZXJ2ZXIuXG4gICAgICogQHBhcmFtIGltIHtJbnRlcmZhY2VNYW5hZ2VyfVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRXZWJob29rSW50ZXJmYWNlKGltOiBJbnRlcmZhY2VNYW5hZ2VyKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IG5lc3QgPSBpbS5nZXROZXN0KCk7XG5cbiAgICAgICAgbGV0IGhvb2tfcGF0aCA9IHMuY29uZmlnLmhvb2tzX3ByZWZpeCArIG5lc3QuZ2V0UGF0aCgpO1xuICAgICAgICBsZXQgaG9va191aV9wYXRoID0gcy5jb25maWcuaG9va3NfdWlfcHJlZml4ICsgaW0uZ2V0UGF0aCgpO1xuXG4gICAgICAgIHMuZS5sb2coMSwgYFdhdGNoaW5nIHdlYmhvb2sgaW50ZXJmYWNlIEdFVCAke2hvb2tfdWlfcGF0aH1gLCBzKTtcblxuICAgICAgICB0aGlzLmhvb2tJbnRlcmZhY2VSb3V0ZXMucHVzaCh7XG4gICAgICAgICAgICBpZDogbmVzdC5nZXRJZCgpLFxuICAgICAgICAgICAgcGF0aDogaG9va191aV9wYXRoLFxuICAgICAgICAgICAgbmVzdDogbmVzdC5uYW1lLFxuICAgICAgICAgICAgdGFyZ2V0OiBob29rX3BhdGhcbiAgICAgICAgICAgIC8vIHR1bm5lbDogbmVzdC5nZXRUdW5uZWwoKS5uYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHMuc2VydmVyLmdldChob29rX3VpX3BhdGgsICBmdW5jdGlvbiAocmVxLCByZXMpIHtcblxuICAgICAgICAgICAgbGV0IGN1c3RvbUhhbmRsZXIgPSBpbS5nZXRDdXN0b21IYW5kbGVSZXF1ZXN0KCk7XG5cbiAgICAgICAgICAgIHMuaGFuZGxlSG9va0ludGVyZmFjZVJlcXVlc3QoaW0sIHJlcSwgcmVzLCBjdXN0b21IYW5kbGVyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyByZXF1ZXN0IGFuZCByZXNwb25zZSBvZiB0aGUgd2ViIGhvb2sgaW50ZXJmYWNlLlxuICAgICAqIEBwYXJhbSBpbSB7SW50ZXJmYWNlTWFuYWdlcn1cbiAgICAgKiBAcGFyYW0gcmVxIHtleHByZXNzLlJlcXVlc3R9XG4gICAgICogQHBhcmFtIHJlcyB7ZXhwcmVzcy5SZXNwb25zZX1cbiAgICAgKiBAcGFyYW0gY3VzdG9tSGFuZGxlciAgICAgICAgICAgICBDdXN0b20gcmVxdWVzdCBoYW5kbGVyLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCBoYW5kbGVIb29rSW50ZXJmYWNlUmVxdWVzdCA9IGZ1bmN0aW9uKGltOiBJbnRlcmZhY2VNYW5hZ2VyLCByZXEsIHJlcywgY3VzdG9tSGFuZGxlcj86IGFueSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG5cbiAgICAgICAgLy8gSm9iIGFycml2ZVxuICAgICAgICBsZXQgam9iID0gbmV3IFdlYmhvb2tKb2Iocy5lLCByZXEsIHJlcyk7XG5cbiAgICAgICAgLy8gRmlsbCBpbiBkZWZhdWx0IHZhbHVlc1xuICAgICAgICBsZXQgcGFyYW1zID0gam9iLmdldFF1ZXJ5U3RyaW5nVmFsdWVzKCk7XG5cbiAgICAgICAgLy8gSWYgc2Vzc2lvbiBub3Qgc2V0LCByZXR1cm4gYSBmcmVzaCB1aSBzb21laG93XG4gICAgICAgIGxldCBzZXNzaW9uSWQgPSBwYXJhbXNbXCJzZXNzaW9uSWRcIl0gfHwgam9iLmdldEZvcm1EYXRhVmFsdWUoXCJzZXNzaW9uSWRcIik7XG5cbiAgICAgICAgbGV0IHVpID0gaW0uZ2V0SW50ZXJmYWNlKHNlc3Npb25JZCk7XG5cbiAgICAgICAgaWYgKHVpLmdldFNlc3Npb25JZCgpID09PSBzZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIC8vIEZpbGwgaW4gZGVmYXVsdCB2YWx1ZXNcbiAgICAgICAgICAgIGxldCBmaWVsZHMgPSB1aS5nZXRGaWVsZHMoKTtcbiAgICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQuaWQgaW4gcGFyYW1zICYmIHBhcmFtc1tmaWVsZC5pZF0gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBwYXJhbXNbZmllbGQuaWRdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBEbyBzdGVwc1xuICAgICAgICAgICAgYXN5bmMuZWFjaCh1aS5nZXRTdGVwcygpLCAoc3RlcCwgY2IpID0+IHtcbiAgICAgICAgICAgICAgICBzLmUubG9nKDAsIGBSdW5uaW5nIFVJIHN0ZXAgXCIke3N0ZXAubmFtZX1cIi5gLCBzKTtcbiAgICAgICAgICAgICAgICBzdGVwLmNhbGxiYWNrKGpvYiwgdWksIHN0ZXAsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZS5sb2coMywgYEVycm9yIHJ1bm5pbmcgVUkgc3RlcHMuICR7ZXJyfWAsIHMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZS5sb2coMCwgYERvbmUgcnVubmluZyBhbGwgVUkgc3RlcHMuYCwgcyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGN1c3RvbUhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tSGFuZGxlcihyZXEsIHJlcywgdWkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5qc29uKHVpLmdldFRyYW5zcG9ydEludGVyZmFjZSgpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGN1c3RvbUhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICBjdXN0b21IYW5kbGVyKHJlcSwgcmVzLCB1aSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlcy5qc29uKHVpLmdldFRyYW5zcG9ydEludGVyZmFjZSgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgfTtcbn0iXX0=
