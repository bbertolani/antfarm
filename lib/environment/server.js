"use strict";
var webhookJob_1 = require("../job/webhookJob");
var express = require("express");
var cors = require("cors"), multer = require("multer"), path = require("path"), tmp = require("tmp"), async = require("async");
/**
 * Webhook and logging server.
 */
var Server = (function () {
    function Server(e) {
        this.hookRoutes = [];
        this.hookInterfaceRoutes = [];
        this.config = {
            hooks_prefix: "/hooks",
            hooks_ui_prefix: "/hooks-ui",
            log_prefix: "/log"
        };
        /**
         * Handles request and response of the web hook interface.
         * @param im {InterfaceManager}
         * @param req {express.Request}
         * @param res {express.Response}
         * @param customHandler             Custom request handler.
         */
        this.handleHookInterfaceRequest = function (im, req, res, customHandler) {
            var s = this;
            // Job arrive
            var job = new webhookJob_1.WebhookJob(s.e, req, res);
            // Fill in default values
            var params = job.getQueryStringValues();
            // If session not set, return a fresh ui somehow
            var sessionId = params["sessionId"] || job.getFormDataValue("sessionId");
            var ui = im.getInterface(sessionId);
            if (ui.sessionId === sessionId) {
                // Fill in default values
                ui.fields.forEach(function (field) {
                    if (field.id in params && params[field.id] !== "undefined") {
                        field.value = params[field.id];
                    }
                });
                // Do steps
                async.each(ui.steps, function (step, cb) {
                    s.e.log(0, "Running UI step \"" + step.name + "\".", s);
                    step.callback(job, ui, step, function () {
                        cb();
                    });
                }, function (err) {
                    if (err) {
                        s.e.log(3, "Error running UI steps. " + err, s);
                    }
                    else {
                        s.e.log(0, "Done running all UI steps.", s);
                    }
                    if (customHandler) {
                        customHandler(req, res, ui);
                    }
                    else {
                        res.json(ui.getTransportInterface());
                    }
                });
            }
            else {
                if (customHandler) {
                    customHandler(req, res, ui);
                }
                else {
                    res.json(ui.getTransportInterface());
                }
            }
        };
        this.e = e;
        this.server = express();
        this.createServer();
        // let tmpDir = tmp.dirSync()._name;
        var tmpDir = "./example";
        this.upload = multer({
            destination: tmpDir,
            storage: multer.diskStorage({
                filename: function (req, file, cb) {
                    cb(null, file.fieldname + "-" + Date.now());
                }
            })
        });
    }
    /**
     * Creates the server.
     */
    Server.prototype.createServer = function () {
        var s = this;
        var port = s.e.options.port;
        s.server.use(cors());
        // Add index routes
        s.server.get(s.config.hooks_prefix, function (req, res) {
            res.json(s.hookRoutes);
        });
        s.server.get(s.config.hooks_ui_prefix, function (req, res) {
            res.json(s.hookInterfaceRoutes);
        });
        // Prevent duplicate listening for tests
        // if (!module.parent) {
        //     s.server.listen(port, () => s.e.log(1, `Server up and listening on port ${port}.`, s));
        // }
        s.server.listen(port, function () { return s.e.log(1, "Server up and listening on port " + port + ".", s); });
    };
    Server.prototype.createLogServer = function (logger) {
        var s = this;
        var options = {
            order: "desc",
            fields: ["message"]
        };
        // Add index routes
        s.server.get(s.config.log_prefix, function (req, res) {
            logger.query(options, function (results) {
                res.json(results);
            });
        });
    };
    /**
     * Log _name
     * @returns {string}
     */
    Server.prototype.toString = function () {
        return "Server";
    };
    /**
     * Adds a webhook to the server.
     * @param nest {WebhookNest}
     */
    Server.prototype.addWebhook = function (nest) {
        var s = this;
        var e = s.e;
        var httpMethod = nest.httpMethod;
        var hook_path = s.config.hooks_prefix + nest.path;
        var hook_ui_path;
        var im = nest.interfaceManager;
        var wi = im.getInterface();
        hook_ui_path = s.config.hooks_ui_prefix + im.path;
        s.e.log(1, "Watching webhook " + httpMethod.toUpperCase() + " " + hook_path, s);
        s.hookRoutes.push({
            id: nest.id,
            path: hook_path,
            nest: nest.name,
            tunnel: nest.tunnel.name,
            method: httpMethod,
            interface_path: hook_ui_path
        });
        s.server[httpMethod](hook_path, s.upload.any(), function (req, res) {
            var customHandler = nest.customHandleRequest;
            s.handleHookRequest(nest, req, res, customHandler);
        });
    };
    /**
     * Handles request and response of the web hook, creates a new job, as well as calling the nest's arrive.
     * @param nest {WebhookNest}
     * @param req {express.Request}
     * @param res {express.Response}
     * @param customHandler     Custom request handler.
     */
    Server.prototype.handleHookRequest = function (nest, req, res, customHandler) {
        var s = this;
        // Job arrive
        var job = new webhookJob_1.WebhookJob(s.e, req, res);
        nest.arrive(job);
        s.sendHookResponse(nest.holdResponse, job, nest, req, res, customHandler);
    };
    ;
    /**
     * Sends the actual hook response.
     * @param holdResponse      Flag to bypass sending now for held responses.
     * @param job               Webhook job
     * @param nest              Webhook nest
     * @param req
     * @param res
     * @param customHandler
     * @param message
     */
    Server.prototype.sendHookResponse = function (holdResponse, job, nest, req, res, customHandler, message) {
        if (holdResponse === true) {
        }
        else if (customHandler) {
            job.responseSent = true;
            customHandler(req, res, job, nest);
        }
        else {
            job.responseSent = true;
            var response = {
                message: message || "Job " + job.id + " was created!",
                job: {
                    id: job.id,
                    name: job.name
                },
                nest: {
                    name: nest.name
                }
            };
            res.json(response);
        }
    };
    /**
     * Adds a webhook interface to the webhook server.
     * @param im {InterfaceManager}
     */
    Server.prototype.addWebhookInterface = function (im) {
        var s = this;
        var nest = im.nest;
        var hook_path = s.config.hooks_prefix + nest.path;
        var hook_ui_path = s.config.hooks_ui_prefix + im.path;
        s.e.log(1, "Watching webhook interface GET " + hook_ui_path, s);
        this.hookInterfaceRoutes.push({
            id: nest.id,
            path: hook_ui_path,
            nest: nest.name,
            target: hook_path
        });
        s.server.get(hook_ui_path, function (req, res) {
            var customHandler = im.customHandleRequest;
            s.handleHookInterfaceRequest(im, req, res, customHandler);
        });
    };
    return Server;
}());
exports.Server = Server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lbnZpcm9ubWVudC9zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLDJCQUF5QixtQkFBbUIsQ0FBQyxDQUFBO0FBQzdDLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBSW5DLElBQVEsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFDMUIsSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFDcEIsS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUVqQzs7R0FFRztBQUNIO0lBY0ksZ0JBQVksQ0FBYztRQVZoQixlQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLHdCQUFtQixHQUFHLEVBQUUsQ0FBQztRQUd6QixXQUFNLEdBQUc7WUFDZixZQUFZLEVBQUUsUUFBUTtZQUN0QixlQUFlLEVBQUUsV0FBVztZQUM1QixVQUFVLEVBQUUsTUFBTTtTQUNyQixDQUFDO1FBeUxGOzs7Ozs7V0FNRztRQUNPLCtCQUEwQixHQUFHLFVBQVMsRUFBb0IsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLGFBQW1CO1lBQy9GLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUViLGFBQWE7WUFDYixJQUFJLEdBQUcsR0FBRyxJQUFJLHVCQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFeEMseUJBQXlCO1lBQ3pCLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBRXhDLGdEQUFnRDtZQUNoRCxJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXpFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENB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QUM7UUFFSCxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUcsVUFBVSxHQUFHLEVBQUUsR0FBRztZQUUxQyxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUMsbUJBQW1CLENBQUM7WUFFM0MsQ0FBQyxDQUFDLDBCQUEwQixDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzlELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQTRETCxhQUFDO0FBQUQsQ0EvUEEsQUErUEMsSUFBQTtBQS9QWSxjQUFNLFNBK1BsQixDQUFBIiwiZmlsZSI6ImxpYi9lbnZpcm9ubWVudC9zZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Vudmlyb25tZW50fSBmcm9tIFwiLi9lbnZpcm9ubWVudFwiO1xuaW1wb3J0IHtXZWJob29rTmVzdH0gZnJvbSBcIi4uL25lc3Qvd2ViaG9va05lc3RcIjtcbmltcG9ydCB7V2ViaG9va0pvYn0gZnJvbSBcIi4uL2pvYi93ZWJob29rSm9iXCI7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQge0ludGVyZmFjZU1hbmFnZXJ9IGZyb20gXCIuLi91aS9pbnRlcmZhY2VNYW5hZ2VyXCI7XG5pbXBvcnQge0xvZ2dlciwgTG9nUXVlcnlPcHRpb25zfSBmcm9tIFwiLi9sb2dnZXJcIjtcblxuY29uc3QgICBjb3JzID0gcmVxdWlyZShcImNvcnNcIiksXG4gICAgICAgIG11bHRlciA9IHJlcXVpcmUoXCJtdWx0ZXJcIiksXG4gICAgICAgIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKSxcbiAgICAgICAgdG1wID0gcmVxdWlyZShcInRtcFwiKSxcbiAgICAgICAgYXN5bmMgPSByZXF1aXJlKFwiYXN5bmNcIik7XG5cbi8qKlxuICogV2ViaG9vayBhbmQgbG9nZ2luZyBzZXJ2ZXIuXG4gKi9cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIge1xuXG4gICAgcHJvdGVjdGVkIHNlcnZlcjogZXhwcmVzcy5BcHBsaWNhdGlvbjtcbiAgICBwcm90ZWN0ZWQgZTogRW52aXJvbm1lbnQ7XG4gICAgcHJvdGVjdGVkIGhvb2tSb3V0ZXMgPSBbXTtcbiAgICBwcm90ZWN0ZWQgaG9va0ludGVyZmFjZVJvdXRlcyA9IFtdO1xuICAgIHByb3RlY3RlZCB1cGxvYWQ7XG5cbiAgICBwcm90ZWN0ZWQgY29uZmlnID0ge1xuICAgICAgICBob29rc19wcmVmaXg6IFwiL2hvb2tzXCIsXG4gICAgICAgIGhvb2tzX3VpX3ByZWZpeDogXCIvaG9va3MtdWlcIixcbiAgICAgICAgbG9nX3ByZWZpeDogXCIvbG9nXCJcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IoZTogRW52aXJvbm1lbnQpIHtcbiAgICAgICAgdGhpcy5lID0gZTtcbiAgICAgICAgdGhpcy5zZXJ2ZXIgPSBleHByZXNzKCk7XG4gICAgICAgIHRoaXMuY3JlYXRlU2VydmVyKCk7XG5cbiAgICAgICAgLy8gbGV0IHRtcERpciA9IHRtcC5kaXJTeW5jKCkuX25hbWU7XG4gICAgICAgIGxldCB0bXBEaXIgPSBcIi4vZXhhbXBsZVwiO1xuXG4gICAgICAgIHRoaXMudXBsb2FkID0gbXVsdGVyKHtcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbjogdG1wRGlyLFxuICAgICAgICAgICAgICAgIHN0b3JhZ2U6IG11bHRlci5kaXNrU3RvcmFnZSh7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBmdW5jdGlvbiAocmVxLCBmaWxlLCBjYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgZmlsZS5maWVsZG5hbWUgKyBcIi1cIiArIERhdGUubm93KCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgdGhlIHNlcnZlci5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlU2VydmVyKCkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHBvcnQgPSBzLmUub3B0aW9ucy5wb3J0O1xuXG4gICAgICAgIHMuc2VydmVyLnVzZShjb3JzKCkpO1xuXG4gICAgICAgIC8vIEFkZCBpbmRleCByb3V0ZXNcbiAgICAgICAgcy5zZXJ2ZXIuZ2V0KHMuY29uZmlnLmhvb2tzX3ByZWZpeCwgZnVuY3Rpb24ocmVxLCByZXMpe1xuICAgICAgICAgICAgcmVzLmpzb24ocy5ob29rUm91dGVzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHMuc2VydmVyLmdldChzLmNvbmZpZy5ob29rc191aV9wcmVmaXgsIGZ1bmN0aW9uKHJlcSwgcmVzKXtcbiAgICAgICAgICAgIHJlcy5qc29uKHMuaG9va0ludGVyZmFjZVJvdXRlcyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFByZXZlbnQgZHVwbGljYXRlIGxpc3RlbmluZyBmb3IgdGVzdHNcbiAgICAgICAgLy8gaWYgKCFtb2R1bGUucGFyZW50KSB7XG4gICAgICAgIC8vICAgICBzLnNlcnZlci5saXN0ZW4ocG9ydCwgKCkgPT4gcy5lLmxvZygxLCBgU2VydmVyIHVwIGFuZCBsaXN0ZW5pbmcgb24gcG9ydCAke3BvcnR9LmAsIHMpKTtcbiAgICAgICAgLy8gfVxuICAgICAgICBzLnNlcnZlci5saXN0ZW4ocG9ydCwgKCkgPT4gcy5lLmxvZygxLCBgU2VydmVyIHVwIGFuZCBsaXN0ZW5pbmcgb24gcG9ydCAke3BvcnR9LmAsIHMpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlTG9nU2VydmVyKGxvZ2dlcjogTG9nZ2VyKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcblxuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG9yZGVyOiBcImRlc2NcIixcbiAgICAgICAgICAgIGZpZWxkczogW1wibWVzc2FnZVwiXVxuICAgICAgICB9IGFzIExvZ1F1ZXJ5T3B0aW9ucztcblxuICAgICAgICAvLyBBZGQgaW5kZXggcm91dGVzXG4gICAgICAgIHMuc2VydmVyLmdldChzLmNvbmZpZy5sb2dfcHJlZml4LCAocmVxLCByZXMpID0+IHtcblxuICAgICAgICAgICAgbG9nZ2VyLnF1ZXJ5KG9wdGlvbnMsIHJlc3VsdHMgPT4ge1xuICAgICAgICAgICAgICAgIHJlcy5qc29uKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9nIF9uYW1lXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBwdWJsaWMgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBcIlNlcnZlclwiO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSB3ZWJob29rIHRvIHRoZSBzZXJ2ZXIuXG4gICAgICogQHBhcmFtIG5lc3Qge1dlYmhvb2tOZXN0fVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRXZWJob29rKG5lc3Q6IFdlYmhvb2tOZXN0KSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IGUgPSBzLmU7XG5cbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBuZXN0Lmh0dHBNZXRob2Q7XG4gICAgICAgIGxldCBob29rX3BhdGggPSBzLmNvbmZpZy5ob29rc19wcmVmaXggKyBuZXN0LnBhdGg7XG4gICAgICAgIGxldCBob29rX3VpX3BhdGg7XG4gICAgICAgIGxldCBpbSA9IG5lc3QuaW50ZXJmYWNlTWFuYWdlcjtcblxuICAgICAgICBsZXQgd2kgPSBpbS5nZXRJbnRlcmZhY2UoKTtcbiAgICAgICAgaG9va191aV9wYXRoID0gcy5jb25maWcuaG9va3NfdWlfcHJlZml4ICsgaW0ucGF0aDtcblxuICAgICAgICBzLmUubG9nKDEsIGBXYXRjaGluZyB3ZWJob29rICR7aHR0cE1ldGhvZC50b1VwcGVyQ2FzZSgpfSAke2hvb2tfcGF0aH1gLCBzKTtcblxuICAgICAgICBzLmhvb2tSb3V0ZXMucHVzaCh7XG4gICAgICAgICAgICBpZDogbmVzdC5pZCxcbiAgICAgICAgICAgIHBhdGg6IGhvb2tfcGF0aCxcbiAgICAgICAgICAgIG5lc3Q6IG5lc3QubmFtZSxcbiAgICAgICAgICAgIHR1bm5lbDogbmVzdC50dW5uZWwubmFtZSxcbiAgICAgICAgICAgIG1ldGhvZDogaHR0cE1ldGhvZCxcbiAgICAgICAgICAgIGludGVyZmFjZV9wYXRoOiBob29rX3VpX3BhdGhcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcy5zZXJ2ZXJbaHR0cE1ldGhvZF0oaG9va19wYXRoLCBzLnVwbG9hZC5hbnkoKSwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG5cbiAgICAgICAgICAgIGxldCBjdXN0b21IYW5kbGVyID0gbmVzdC5jdXN0b21IYW5kbGVSZXF1ZXN0O1xuXG4gICAgICAgICAgICAgcy5oYW5kbGVIb29rUmVxdWVzdChuZXN0LCByZXEsIHJlcywgY3VzdG9tSGFuZGxlcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgcmVxdWVzdCBhbmQgcmVzcG9uc2Ugb2YgdGhlIHdlYiBob29rLCBjcmVhdGVzIGEgbmV3IGpvYiwgYXMgd2VsbCBhcyBjYWxsaW5nIHRoZSBuZXN0J3MgYXJyaXZlLlxuICAgICAqIEBwYXJhbSBuZXN0IHtXZWJob29rTmVzdH1cbiAgICAgKiBAcGFyYW0gcmVxIHtleHByZXNzLlJlcXVlc3R9XG4gICAgICogQHBhcmFtIHJlcyB7ZXhwcmVzcy5SZXNwb25zZX1cbiAgICAgKiBAcGFyYW0gY3VzdG9tSGFuZGxlciAgICAgQ3VzdG9tIHJlcXVlc3QgaGFuZGxlci5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaGFuZGxlSG9va1JlcXVlc3QgKG5lc3Q6IFdlYmhvb2tOZXN0LCByZXEsIHJlcywgY3VzdG9tSGFuZGxlcj86IGFueSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG5cbiAgICAgICAgLy8gSm9iIGFycml2ZVxuICAgICAgICBsZXQgam9iID0gbmV3IFdlYmhvb2tKb2Iocy5lLCByZXEsIHJlcyk7XG4gICAgICAgIG5lc3QuYXJyaXZlKGpvYik7XG5cbiAgICAgICAgcy5zZW5kSG9va1Jlc3BvbnNlKG5lc3QuaG9sZFJlc3BvbnNlLCBqb2IsIG5lc3QsIHJlcSwgcmVzLCBjdXN0b21IYW5kbGVyKTtcblxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBTZW5kcyB0aGUgYWN0dWFsIGhvb2sgcmVzcG9uc2UuXG4gICAgICogQHBhcmFtIGhvbGRSZXNwb25zZSAgICAgIEZsYWcgdG8gYnlwYXNzIHNlbmRpbmcgbm93IGZvciBoZWxkIHJlc3BvbnNlcy5cbiAgICAgKiBAcGFyYW0gam9iICAgICAgICAgICAgICAgV2ViaG9vayBqb2JcbiAgICAgKiBAcGFyYW0gbmVzdCAgICAgICAgICAgICAgV2ViaG9vayBuZXN0XG4gICAgICogQHBhcmFtIHJlcVxuICAgICAqIEBwYXJhbSByZXNcbiAgICAgKiBAcGFyYW0gY3VzdG9tSGFuZGxlclxuICAgICAqIEBwYXJhbSBtZXNzYWdlXG4gICAgICovXG4gICAgcHVibGljIHNlbmRIb29rUmVzcG9uc2UgKGhvbGRSZXNwb25zZTogYm9vbGVhbiwgam9iOiBXZWJob29rSm9iLCBuZXN0OiBXZWJob29rTmVzdCwgcmVxLCByZXMsIGN1c3RvbUhhbmRsZXI/OiBhbnksIG1lc3NhZ2U/OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGhvbGRSZXNwb25zZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICB9IGVsc2UgaWYgKGN1c3RvbUhhbmRsZXIpIHtcbiAgICAgICAgICAgIGpvYi5yZXNwb25zZVNlbnQgPSB0cnVlO1xuICAgICAgICAgICAgY3VzdG9tSGFuZGxlcihyZXEsIHJlcywgam9iLCBuZXN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGpvYi5yZXNwb25zZVNlbnQgPSB0cnVlO1xuICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UgfHwgYEpvYiAke2pvYi5pZH0gd2FzIGNyZWF0ZWQhYCxcbiAgICAgICAgICAgICAgICBqb2I6IHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IGpvYi5pZCxcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogam9iLm5hbWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG5lc3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmVzdC5uYW1lXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJlcy5qc29uKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSB3ZWJob29rIGludGVyZmFjZSB0byB0aGUgd2ViaG9vayBzZXJ2ZXIuXG4gICAgICogQHBhcmFtIGltIHtJbnRlcmZhY2VNYW5hZ2VyfVxuICAgICAqL1xuICAgIHB1YmxpYyBhZGRXZWJob29rSW50ZXJmYWNlKGltOiBJbnRlcmZhY2VNYW5hZ2VyKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgbGV0IG5lc3QgPSBpbS5uZXN0O1xuXG4gICAgICAgIGxldCBob29rX3BhdGggPSBzLmNvbmZpZy5ob29rc19wcmVmaXggKyBuZXN0LnBhdGg7XG4gICAgICAgIGxldCBob29rX3VpX3BhdGggPSBzLmNvbmZpZy5ob29rc191aV9wcmVmaXggKyBpbS5wYXRoO1xuXG4gICAgICAgIHMuZS5sb2coMSwgYFdhdGNoaW5nIHdlYmhvb2sgaW50ZXJmYWNlIEdFVCAke2hvb2tfdWlfcGF0aH1gLCBzKTtcblxuICAgICAgICB0aGlzLmhvb2tJbnRlcmZhY2VSb3V0ZXMucHVzaCh7XG4gICAgICAgICAgICBpZDogbmVzdC5pZCxcbiAgICAgICAgICAgIHBhdGg6IGhvb2tfdWlfcGF0aCxcbiAgICAgICAgICAgIG5lc3Q6IG5lc3QubmFtZSxcbiAgICAgICAgICAgIHRhcmdldDogaG9va19wYXRoXG4gICAgICAgICAgICAvLyB0dW5uZWw6IG5lc3QuZ2V0VHVubmVsKCkubmFtZVxuICAgICAgICB9KTtcblxuICAgICAgICBzLnNlcnZlci5nZXQoaG9va191aV9wYXRoLCAgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG5cbiAgICAgICAgICAgIGxldCBjdXN0b21IYW5kbGVyID0gaW0uY3VzdG9tSGFuZGxlUmVxdWVzdDtcblxuICAgICAgICAgICAgcy5oYW5kbGVIb29rSW50ZXJmYWNlUmVxdWVzdChpbSwgcmVxLCByZXMsIGN1c3RvbUhhbmRsZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIG9mIHRoZSB3ZWIgaG9vayBpbnRlcmZhY2UuXG4gICAgICogQHBhcmFtIGltIHtJbnRlcmZhY2VNYW5hZ2VyfVxuICAgICAqIEBwYXJhbSByZXEge2V4cHJlc3MuUmVxdWVzdH1cbiAgICAgKiBAcGFyYW0gcmVzIHtleHByZXNzLlJlc3BvbnNlfVxuICAgICAqIEBwYXJhbSBjdXN0b21IYW5kbGVyICAgICAgICAgICAgIEN1c3RvbSByZXF1ZXN0IGhhbmRsZXIuXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGhhbmRsZUhvb2tJbnRlcmZhY2VSZXF1ZXN0ID0gZnVuY3Rpb24oaW06IEludGVyZmFjZU1hbmFnZXIsIHJlcSwgcmVzLCBjdXN0b21IYW5kbGVyPzogYW55KSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcblxuICAgICAgICAvLyBKb2IgYXJyaXZlXG4gICAgICAgIGxldCBqb2IgPSBuZXcgV2ViaG9va0pvYihzLmUsIHJlcSwgcmVzKTtcblxuICAgICAgICAvLyBGaWxsIGluIGRlZmF1bHQgdmFsdWVzXG4gICAgICAgIGxldCBwYXJhbXMgPSBqb2IuZ2V0UXVlcnlTdHJpbmdWYWx1ZXMoKTtcblxuICAgICAgICAvLyBJZiBzZXNzaW9uIG5vdCBzZXQsIHJldHVybiBhIGZyZXNoIHVpIHNvbWVob3dcbiAgICAgICAgbGV0IHNlc3Npb25JZCA9IHBhcmFtc1tcInNlc3Npb25JZFwiXSB8fCBqb2IuZ2V0Rm9ybURhdGFWYWx1ZShcInNlc3Npb25JZFwiKTtcblxuICAgICAgICBsZXQgdWkgPSBpbS5nZXRJbnRlcmZhY2Uoc2Vzc2lvbklkKTtcblxuICAgICAgICBpZiAodWkuc2Vzc2lvbklkID09PSBzZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIC8vIEZpbGwgaW4gZGVmYXVsdCB2YWx1ZXNcbiAgICAgICAgICAgIHVpLmZpZWxkcy5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQuaWQgaW4gcGFyYW1zICYmIHBhcmFtc1tmaWVsZC5pZF0gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQudmFsdWUgPSBwYXJhbXNbZmllbGQuaWRdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBEbyBzdGVwc1xuICAgICAgICAgICAgYXN5bmMuZWFjaCh1aS5zdGVwcywgKHN0ZXAsIGNiKSA9PiB7XG4gICAgICAgICAgICAgICAgcy5lLmxvZygwLCBgUnVubmluZyBVSSBzdGVwIFwiJHtzdGVwLm5hbWV9XCIuYCwgcyk7XG4gICAgICAgICAgICAgICAgc3RlcC5jYWxsYmFjayhqb2IsIHVpLCBzdGVwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBzLmUubG9nKDMsIGBFcnJvciBydW5uaW5nIFVJIHN0ZXBzLiAke2Vycn1gLCBzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzLmUubG9nKDAsIGBEb25lIHJ1bm5pbmcgYWxsIFVJIHN0ZXBzLmAsIHMpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjdXN0b21IYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUhhbmRsZXIocmVxLCByZXMsIHVpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXMuanNvbih1aS5nZXRUcmFuc3BvcnRJbnRlcmZhY2UoKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjdXN0b21IYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgY3VzdG9tSGFuZGxlcihyZXEsIHJlcywgdWkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXMuanNvbih1aS5nZXRUcmFuc3BvcnRJbnRlcmZhY2UoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH07XG59Il19
